


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv='content-language' content='ja'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.3.1. データベースアクセス(JDBCラッパー) &mdash; ∇Nablarch  5u20 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  

  
  <link rel="canonical" href="https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/database/database.html" />
  
    <link rel="top" title="∇Nablarch  5u20 ドキュメント" href="../../../../index.html"/>
        <link rel="up" title="7.3. データベースアクセス" href="../database_management.html"/>
        <link rel="next" title="7.3.2. ユニバーサルDAO" href="universal_dao.html"/>
        <link rel="prev" title="7.3. データベースアクセス" href="../database_management.html"/>
 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
  
  <a href="../../../../index.html" id="sidebar-title" class="icon"> ∇Nablarch 
  

  
    <div id="sidebar-version">Version: 5u20</div>
  </a>

  <div role="search">
    <form id="google-search-form" class="wy-form" method="get" action="https://www.google.co.jp/search">
      <input type="text" name="text" placeholder="Search docs on google" id="text"/>
      <input type="hidden" name="q" id="q"/>
    </form>
  </div>
    
    

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  
  
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../about_nablarch/index.html">Nablarchについて</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/concept.html">Nablarchのコンセプト</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/concept.html#robustness">Robustness</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/concept.html#testability">Testability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/concept.html#ready-to-use">Ready-to-Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/mvn_module.html">Nablarch のモジュール一覧</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/license.html">Nablarchのライセンスについて</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Nablarchアプリケーションフレームワーク</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">アプリケーションフレームワーク</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../nablarch/index.html">1. Nablarchアプリケーションフレームワークとは</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../web/index.html">2. ウェブアプリケーション編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../web_service/index.html">3. ウェブサービス編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../batch/index.html">4. バッチアプリケーション編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../messaging/index.html">5. メッセージング編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../handlers/index.html">6. Nablarchの提供する標準ハンドラ</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">7. Nablarchが提供するライブラリ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../blank_project/index.html">8. ブランクプロジェクト</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../setting_guide/index.html">9. Nablarchアプリケーションフレームワーク設定ガイド</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/index.html">10. デフォルト設定一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cloud_native/index.html">11. Nablarchクラウドネイティブ対応</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../adaptors/index.html">アダプタ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/log_adaptor.html">logアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/router_adaptor.html">ルーティングアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/webspheremq_adaptor.html">IBM WebSphere MQアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/jaxrs_adaptor.html">JAX-RSアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/doma_adaptor.html">Domaアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/jsr310_adaptor.html">JSR310(Date and Time API)アダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/mail_sender_freemarker_adaptor.html">E-mail FreeMarkerアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/mail_sender_thymeleaf_adaptor.html">E-mail Thymeleafアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/mail_sender_velocity_adaptor.html">E-mail Velocityアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/web_thymeleaf_adaptor.html">ウェブアプリケーション Thymeleafアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/lettuce_adaptor.html">Lettuceアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/slf4j_adaptor.html">SLF4Jアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/micrometer_adaptor.html">Micrometerアダプタ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../example/index.html">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../example/index.html#id1">環境構築手順について</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../example/index.html#id2">アプリケーションの実行手順について</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../extension_components/index.html">Nablarch拡張コンポーネント</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/report/index.html">1. 帳票ライブラリ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/report/index.html#id2">1.1. 概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/report/index.html#id3">1.2. 要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/report/index.html#id7">1.3. 構造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/report/index.html#report-template">1.4. 実装例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/workflow/doc/index.html">2. ワークフローライブラリ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/workflow/doc/index.html#id3">2.1. 機能概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/workflow/doc/index.html#id6">2.2. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/workflow/doc/index.html#id7">2.3. 使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/workflow/doc/index.html#xor">2.4. XORゲートウェイの進行先ノードの判定方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/workflow/doc/index.html#workflow-multi-completion">2.5. マルチインスタンスの完了条件の判定方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/workflow/tool/index.html">3. ワークフロー定義データ生成ツール</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/workflow/tool/index.html#id3">3.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/workflow/tool/index.html#id4">3.2. 使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/etl/index.html">4. ETL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/etl/index.html#id3">4.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/etl/index.html#etl-phase">4.2. ETLの各フェーズの仕様</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/etl/index.html#id5">4.3. ETLを使用するバッチの設計ポイント</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/etl/index.html#id9">4.4. 使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/etl/index.html#id18">4.5. 拡張例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/etl/etl_maven_plugin.html">5. ETL Mavenプラグイン</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/etl/etl_maven_plugin.html#id2">5.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../extension_components/etl/etl_maven_plugin.html#id3">5.2. 使用方法</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../development_tools/index.html">Nablarch開発ツール</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html">1. 効率的なJava静的チェック</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html#code-analysis">1.1. 構文チェックを行う</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html#code-format">1.2. フォーマットを統一する</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html#api">1.3. 許可していないAPIが使用されていないかチェックする</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/ui_dev/index.html">2. フロントエンド上級者向けのUI開発基盤</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/ui_dev/doc/index.html">2.1. Nablarch UI開発基盤 解説書</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/ui_dev/guide/index.html">2.2. JSP/HTML作成ガイド</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/ui_dev/guide/widget_usage/widget_list.html">2.3. UI部品の実装サンプルで提供しているウィジェットの一覧</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/testing_framework/index.html">3. テスティングフレームワーク</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/testing_framework/guide/development_guide/05_UnitTestGuide/index.html">3.1. 単体テスト実施方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/testing_framework/guide/development_guide/06_TestFWGuide/index.html">3.2. 自動テストフレームワークの使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/testing_framework/guide/development_guide/08_TestTools/index.html">3.3. プログラミング工程で使用するツール</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/toolbox/index.html">4. アプリケーション開発時に使える便利なツール</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/toolbox/JspStaticAnalysis/index.html">4.1. JSP静的解析ツール</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/toolbox/SqlExecutor/SqlExecutor.html">4.2. Nablarch SQL Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/toolbox/JspVerifier/JspVerifier.html">4.3. 業務画面JSP検証ツール</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/index.html">Nablarch実装例集</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/01/index.html">データベースを用いたパスワード認証機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/0101_PBKDF2PasswordEncryptor.html">PBKDF2を用いたパスワード暗号化機能サンプル</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#id12">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/02/index.html">バリデーション機能の拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/02/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/02/index.html#extendedvalidation-mailaddressvalidator">メールアドレスバリデーション</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/02/index.html#extendedvalidation-japanesetelnumbervalidator">日本電話番号バリデーション</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/02/index.html#id12">コード値精査</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/03/index.html">検索結果の一覧表示</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#id5">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#id8">使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchinfo">ListSearchInfoクラス</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult">listSearchResultタグ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult-sort">検索結果の並び替え</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult-nopaging">1画面にすべての検索結果を一覧表示する場合の実装方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult-defaultcondition">デフォルトの検索条件で検索した結果を初期表示する場合の実装方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult-setting">検索結果の一覧表示機能のデフォルト値設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult-customize">業務アプリケーションへのサンプル実装(タグファイル)の取り込み方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult-tagreference">タグリファレンス</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/04/index.html">フォーマッタ機能の拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/04/0401_ExtendedDataFormatter.html">データフォーマッタの拡張</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/04/0402_ExtendedFieldType.html">データフォーマッタ機能におけるフィールドタイプの拡張</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/05/index.html">データベースを用いたファイル管理機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#id2">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#id6">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#id7">機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#id10">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#id15">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/06/index.html">CAPTCHA機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/06/06_Captcha_guide.html">CAPTCHA機能の組み込み手順</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/06/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/06/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/06/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/06/index.html#id21">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/07/index.html">UserAgent情報取得機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/07/index.html#id1">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/07/index.html#id3">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/07/index.html#id8">設定の記述</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/07/index.html#id11">使用例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/08/index.html">HTMLメール送信機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#id1">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#id3">要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#id14">実装例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/09/index.html">bouncycastleを使用した電子署名つきメールの送信サンプルの使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#id3">環境準備</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#id4">電子署名付きメール送信機能の構造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#id5">設定ファイルの準備</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#id7">実行方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/10/index.html">ログ集計サンプルの使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/10/index.html#id3">提供サンプル一覧</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/11/index.html">メッセージング基盤テストシミュレータサンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#id4">用途</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#id8">特徴</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#id12">要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#id15">使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#id18">拡張例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nablarch_api/index.html">Nablarch API</a></li>
</ul>

  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">∇Nablarch </a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Nablarchアプリケーションフレームワーク</a> &raquo;</li>
      
          <li><a href="../../index.html">アプリケーションフレームワーク</a> &raquo;</li>
      
          <li><a href="../index.html">7. Nablarchが提供するライブラリ</a> &raquo;</li>
      
          <li><a href="../database_management.html">7.3. データベースアクセス</a> &raquo;</li>
      
    <li>7.3.1. データベースアクセス(JDBCラッパー)</li>
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/nablarch" class="fa fa-github">GitHub</a>
    </li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://nablarch.github.io/docs/LATEST/doc/en/index.html" class="en">English</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="jdbc">
<span id="database"></span><h1>7.3.1. データベースアクセス(JDBCラッパー)<a class="headerlink" href="#jdbc" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id2" id="id31">機能概要</a><ul>
<li><a class="reference internal" href="#database-dialect" id="id32">データベースの方言を意識することなく利用できる</a></li>
<li><a class="reference internal" href="#sqlsql" id="id33">SQLはロジックではなくSQLファイルに記述する</a></li>
<li><a class="reference internal" href="#beansql" id="id34">Beanのプロパティ値をSQLのバインド変数に埋め込むことができる</a></li>
<li><a class="reference internal" href="#like" id="id35">like検索を容易に実装できる</a></li>
<li><a class="reference internal" href="#database-variable-condition" id="id36">実行時のBeanオブジェクトの状態を元にSQL文を動的に構築できる</a></li>
<li><a class="reference internal" href="#sql" id="id37">SQLのクエリ結果をキャッシュできる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id38">モジュール一覧</a></li>
<li><a class="reference internal" href="#id6" id="id39">使用方法</a><ul>
<li><a class="reference internal" href="#database-connect" id="id40">データベースに対する接続設定を行う</a></li>
<li><a class="reference internal" href="#database-use-dialect" id="id41">データベース製品に対応したダイアレクトを使用する</a></li>
<li><a class="reference internal" href="#database-use-sql-file" id="id42">SQLをファイルで管理する</a></li>
<li><a class="reference internal" href="#sqlidsql" id="id43">SQLIDを指定してSQLを実行する</a></li>
<li><a class="reference internal" href="#id10" id="id44">ストアードプロシージャを実行する</a></li>
<li><a class="reference internal" href="#database-paging" id="id45">検索範囲を指定してSQLを実行する</a></li>
<li><a class="reference internal" href="#database-input-bean" id="id46">Beanオブジェクトを入力としてSQLを実行する</a></li>
<li><a class="reference internal" href="#id13" id="id47">型を変換する</a></li>
<li><a class="reference internal" href="#database-common-bean" id="id48">SQL実行時に共通的な値を自動的に設定したい</a></li>
<li><a class="reference internal" href="#database-like-condition" id="id49">like検索を行う</a></li>
<li><a class="reference internal" href="#database-def-escape-char" id="id50">like検索時のエスケープ文字及びエスケープ対象文字を定義する</a></li>
<li><a class="reference internal" href="#database-use-variable-condition" id="id51">可変条件を持つSQLを実行する</a></li>
<li><a class="reference internal" href="#insql" id="id52">in句の条件数が可変となるSQLを実行する</a></li>
<li><a class="reference internal" href="#order-bysql" id="id53">order byのソート項目を実行時に動的に切り替えてSQLを実行する</a></li>
<li><a class="reference internal" href="#database-binary-column" id="id54">バイナリ型のカラムにアクセスする</a></li>
<li><a class="reference internal" href="#clob" id="id55">桁数の大きい文字列型のカラム(例えばCLOB)にアクセスする</a></li>
<li><a class="reference internal" href="#id20" id="id56">データベースアクセス時に発生する例外の種類</a></li>
<li><a class="reference internal" href="#database-duplicated-error" id="id57">一意制約違反をハンドリングして処理を行う</a></li>
<li><a class="reference internal" href="#id22" id="id58">処理が長いトランザクションはエラーとして処理を中断させる</a></li>
<li><a class="reference internal" href="#database-new-transaction" id="id59">現在のトランザクションとは異なるトランザクションでSQLを実行する</a></li>
<li><a class="reference internal" href="#database-use-cache" id="id60">検索結果をキャッシュする（同じSQLで同じ条件の場合にキャッシュしたデータを扱いたい)</a></li>
<li><a class="reference internal" href="#java-sql-connection" id="id61"><cite>java.sql.Connection</cite> を使って処理を行う</a></li>
<li><a class="reference internal" href="#database-replace-schema" id="id62">SQL文中のスキーマを環境毎に切り替える</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id27" id="id63">拡張例</a><ul>
<li><a class="reference internal" href="#database-add-connection-factory" id="id64">データベースへの接続法を追加する</a></li>
<li><a class="reference internal" href="#database-add-dialect" id="id65">ダイアレクトを追加する</a></li>
<li><a class="reference internal" href="#database-change-exception" id="id66">データベースアクセス時の例外クラスを切り替える</a></li>
</ul>
</li>
</ul>
</div>
<p>JDBCを使用してデータベースに対してSQL文を実行する機能を提供する。</p>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p><a class="reference internal" href="../database_management.html#database-management"><span>データベースアクセス</span></a> で説明したように、SQLの実行に関しては <a class="reference internal" href="universal_dao.html#universal-dao"><span>ユニバーサルDAO</span></a> を使用することを推奨する。</p>
<p class="last">なお、<a class="reference internal" href="universal_dao.html#universal-dao"><span>ユニバーサルDAO</span></a> 内部では、この機能のAPIを使用してデータベースアクセスを行っているため、
この機能を使用するための設定は必ず必要になる。</p>
</div>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">この機能は、JDBC 3.0に依存しているため、使用するJDBCドライバがJDBC 3.0以上を実装している必要がある。</p>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id31">7.3.1.1. 機能概要</a><a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="database-dialect">
<span id="id3"></span><h3><a class="toc-backref" href="#id32">7.3.1.1.1. データベースの方言を意識することなく利用できる</a><a class="headerlink" href="#database-dialect" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>使用するデータベース製品に対応した <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html" title="nablarch.core.db.dialect.Dialect">Dialect</a> を設定することで、
製品ごとの方言を意識せずにアプリケーションを実装できる。</p>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html" title="nablarch.core.db.dialect.Dialect">Dialect</a> は、以下の機能を提供する。</p>
<ul class="simple">
<li>identityカラムを使えるか否かを返すメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#supportsIdentity--" title="nablarch.core.db.dialect.Dialect.supportsIdentity()">supportsIdentity</a> )</li>
<li>identity(自動採番)カラムを持つテーブル対してbatch insertが行えるか否かを返すメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#supportsIdentityWithBatchInsert--" title="nablarch.core.db.dialect.Dialect.supportsIdentityWithBatchInsert()">supportsIdentityWithBatchInsert</a>)</li>
<li>シーケンスオブジェクトを使えるか否かを返すメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#supportsSequence--" title="nablarch.core.db.dialect.Dialect.supportsSequence()">supportsSequence</a> )</li>
<li>検索クエリーの範囲指定でoffset（またはoffsetと同等の機能）を使えるか否かを返すメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#supportsOffset--" title="nablarch.core.db.dialect.Dialect.supportsOffset()">supportsOffset</a> )</li>
<li>一意制約違反を表す <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/SQLException.html" title="java.sql.SQLException">SQLException</a> か否かを判定するメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#isDuplicateException-java.sql.SQLException-" title="nablarch.core.db.dialect.Dialect.isDuplicateException(java.sql.SQLException)">isDuplicateException</a> )</li>
<li>トランザクションタイムアウト対象の  <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/SQLException.html" title="java.sql.SQLException">SQLException</a> か否かを判定するメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#isTransactionTimeoutError-java.sql.SQLException-" title="nablarch.core.db.dialect.Dialect.isTransactionTimeoutError(java.sql.SQLException)">isTransactionTimeoutError</a> )</li>
<li>シーケンスオブジェクトから次の値を取得するSQL文生成するメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#buildSequenceGeneratorSql-java.lang.String-" title="nablarch.core.db.dialect.Dialect.buildSequenceGeneratorSql(java.lang.String)">buildSequenceGeneratorSql</a> )</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" title="java.sql.ResultSet">ResultSet</a> から値を取得する <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/ResultSetConvertor.html" title="nablarch.core.db.statement.ResultSetConvertor">ResultSetConvertor</a> を返すメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#getResultSetConvertor--" title="nablarch.core.db.dialect.Dialect.getResultSetConvertor()">getResultSetConvertor</a> )</li>
<li>検索クエリーを範囲指定（ページング用）SQLに変換するメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#convertPaginationSql-java.lang.String-nablarch.core.db.statement.SelectOption-" title="nablarch.core.db.dialect.Dialect.convertPaginationSql(java.lang.String-nablarch.core.db.statement.SelectOption)">convertPaginationSql</a> )</li>
<li>検索クエリーを件数取得SQLに変換するメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#convertCountSql-java.lang.String-" title="nablarch.core.db.dialect.Dialect.convertCountSql(java.lang.String)">convertCountSql</a> )</li>
<li><a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" title="java.sql.Connection">Connection</a> がデータベースに接続されているかチェックを行うSQLを返すメソッド(<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html#getPingSql--" title="nablarch.core.db.dialect.Dialect.getPingSql()">getPingSql</a> )</li>
</ul>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/Dialect.html" title="nablarch.core.db.dialect.Dialect">Dialect</a> の設定方法は、 <a class="reference internal" href="#database-use-dialect"><span>データベース製品に対応したダイアレクトを使用する</span></a> を参照。</p>
</div>
<div class="section" id="sqlsql">
<span id="database-sql-file"></span><h3><a class="toc-backref" href="#id33">7.3.1.1.2. SQLはロジックではなくSQLファイルに記述する</a><a class="headerlink" href="#sqlsql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SQLはSQLファイルに定義し、原則ロジック内には記述しない。</p>
<p>SQLファイルに記述することで、ロジックでSQLの組み立てを行う必要がなく、
必ず <cite>PreparedStatement</cite> を使用するため、SQLインジェクションの脆弱性が排除できる。</p>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">どうしてもSQLファイルに定義できない場合は、SQLを直接指定して実行するAPIも提供しているので、そちらを使用すること。
ただし、安易に使用するとSQLインジェクションの脆弱性が埋め込まれる可能性があるため注意すること。
また、SQLインジェクションの脆弱性がないことなど、テストやレビューで担保出来ることが前提となる。</p>
</div>
<p>詳細は、 <a class="reference internal" href="#database-use-sql-file"><span>SQLをファイルで管理する</span></a> を参照。</p>
</div>
<div class="section" id="beansql">
<span id="database-bean"></span><h3><a class="toc-backref" href="#id34">7.3.1.1.3. Beanのプロパティ値をSQLのバインド変数に埋め込むことができる</a><a class="headerlink" href="#beansql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Beanのプロパティに設定した値を <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" title="java.sql.PreparedStatement">java.sql.PreparedStatement</a> のINパラメータに自動的にバインドする機能を提供する。</p>
<p>この機能を使用することで、  <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" title="java.sql.PreparedStatement">java.sql.PreparedStatement</a> の値設定用メソッドを複数回呼び出す必要がなくなり、
INパラメータが増減した際のインデクス修正などが不要となる。</p>
<p>詳細は <a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> を参照。</p>
</div>
<div class="section" id="like">
<h3><a class="toc-backref" href="#id35">7.3.1.1.4. like検索を容易に実装できる</a><a class="headerlink" href="#like" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>like検索に対するescape句の挿入とワイルドカード文字のエスケープ処理を自動で行う機能を提供する。</p>
<p>詳細は <a class="reference internal" href="#database-like-condition"><span>like検索を行う</span></a> を参照。</p>
</div>
<div class="section" id="database-variable-condition">
<span id="id4"></span><h3><a class="toc-backref" href="#id36">7.3.1.1.5. 実行時のBeanオブジェクトの状態を元にSQL文を動的に構築できる</a><a class="headerlink" href="#database-variable-condition" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Beanオブジェクトの状態を元に、実行するSQL文を動的に組み立てる機能を提供する。</p>
<p>例えば、条件やin句の動的な構築などが行える。</p>
<p>詳細は以下を参照。</p>
<ul class="simple">
<li><a class="reference internal" href="#database-use-variable-condition"><span>可変条件を持つSQLを実行する</span></a></li>
<li><a class="reference internal" href="#database-in-condition"><span>in句の条件数が可変となるSQLを実行する</span></a></li>
<li><a class="reference internal" href="#database-make-order-by"><span>order byのソート項目を実行時に動的に切り替えてSQLを実行する</span></a></li>
</ul>
</div>
<div class="section" id="sql">
<h3><a class="toc-backref" href="#id37">7.3.1.1.6. SQLのクエリ結果をキャッシュできる</a><a class="headerlink" href="#sql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>実行したSQLと外部から取得した条件(バインド変数に設定した値)が等価である場合に、
データベースにアクセスせずにキャッシュから検索結果を返却する機能を提供する。</p>
<p>詳細は、 <a class="reference internal" href="#database-use-cache"><span>検索結果をキャッシュする（同じSQLで同じ条件の場合にキャッシュしたデータを扱いたい)</span></a> を参照。</p>
</div>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id38">7.3.1.2. モジュール一覧</a><a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-core-jdbc<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id39">7.3.1.3. 使用方法</a><a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="database-connect">
<span id="id7"></span><h3><a class="toc-backref" href="#id40">7.3.1.3.1. データベースに対する接続設定を行う</a><a class="headerlink" href="#database-connect" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベースに対する接続設定は、以下の2通りから選択することができる。</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html" title="javax.sql.DataSource">javax.sql.DataSource</a> を使ったデータベース接続の生成</li>
<li>アプリケーションサーバなどに登録されたデータソースを使ったデータベース接続の生成</li>
</ul>
<p>上記以外の接続方法を使用したい場合(例えばOSSのコネクションプーリングライブラリを使う場合など)は、
<a class="reference internal" href="#database-add-connection-factory"><span>データベースへの接続法を追加する</span></a> を参照し、データベース接続を行う実装を追加すること。</p>
<dl class="docutils">
<dt>接続設定例</dt>
<dd><dl class="first docutils">
<dt><a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html" title="javax.sql.DataSource">javax.sql.DataSource</a> からデータベース接続の生成</dt>
<dd><div class="first last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.connection.BasicDbConnectionFactoryForDataSource&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- 設定値の詳細はJavadocを参照すること --&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>アプリケーションサーバのデータソースからデータベース接続の生成</dt>
<dd><div class="first last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.connection.BasicDbConnectionFactoryForJndi&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- 設定値の詳細はJavadocを参照すること --&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
<p class="last"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/BasicDbConnectionFactoryForDataSource.html" title="nablarch.core.db.connection.BasicDbConnectionFactoryForDataSource">BasicDbConnectionFactoryForDataSource</a> や
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/BasicDbConnectionFactoryForJndi.html" title="nablarch.core.db.connection.BasicDbConnectionFactoryForJndi">BasicDbConnectionFactoryForJndi</a> への
設定値については、それぞれのクラスのJavadocを参照すること。</p>
</dd>
</dl>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>上記に設定したクラスを直接使用することは基本的にない。
データベースアクセスを必要とする場合には、 <a class="reference internal" href="../../handlers/common/database_connection_management_handler.html#database-connection-management-handler"><span>データベース接続管理ハンドラ</span></a> を使用すること。</p>
<p class="last">なお、データベースを利用する場合はトランザクション管理も必要となる。
トランザクション管理については、 <a class="reference internal" href="../transaction.html#transaction"><span>トランザクション管理</span></a> を参照。</p>
</div>
</div>
<div class="section" id="database-use-dialect">
<span id="id8"></span><h3><a class="toc-backref" href="#id41">7.3.1.3.2. データベース製品に対応したダイアレクトを使用する</a><a class="headerlink" href="#database-use-dialect" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベース製品に対応したダイアレクトをコンポーネント設定ファイルに設定することで、ダイアレクト機能が有効になる。</p>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>設定を行わなかった場合は <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/DefaultDialect.html" title="nablarch.core.db.dialect.DefaultDialect">DefaultDialect</a> が利用される。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/DefaultDialect.html" title="nablarch.core.db.dialect.DefaultDialect">DefaultDialect</a> は原則全ての機能が無効化されるので、必ずデータベース製品に対応したダイアレクトを設定すること。</p>
<p class="last">なお、使用するデータベース製品に対応するダイアレクトが存在しない場合や、
新しいバージョンの新機能を使いたい場合には、 <a class="reference internal" href="#database-add-dialect"><span>ダイアレクトを追加する</span></a> を参照し新しいダイアレクトを作成すること。</p>
</div>
<dl class="docutils">
<dt>コンポーネント設定例</dt>
<dd><p class="first">この例では、 <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html" title="javax.sql.DataSource">javax.sql.DataSource</a> からデータベース接続を取得するコンポーネントへの設定例となる。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/BasicDbConnectionFactoryForJndi.html" title="nablarch.core.db.connection.BasicDbConnectionFactoryForJndi">BasicDbConnectionFactoryForJndi</a> の場合も以下の例と同じように
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/ConnectionFactorySupport.html#setDialect-nablarch.core.db.dialect.Dialect-" title="nablarch.core.db.connection.ConnectionFactorySupport.setDialect(nablarch.core.db.dialect.Dialect)">dialect</a> プロパティにダイアレクトを設定すれば良い。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.connection.BasicDbConnectionFactoryForDataSource&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ダイアレクトと関係のないプロパティについては省略 --&gt;</span>

  <span class="c">&lt;!--</span>
<span class="c">  ダイアレクトは、dialectプロパティに設定する。</span>
<span class="c">  この例では、Oracleデータベース用のダイアレクトを設定している。</span>
<span class="c">  --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dialect&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.dialect.OracleDialect&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="database-use-sql-file">
<span id="id9"></span><h3><a class="toc-backref" href="#id42">7.3.1.3.3. SQLをファイルで管理する</a><a class="headerlink" href="#database-use-sql-file" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>この機能では、 <a class="reference internal" href="#database-sql-file"><span>SQLはロジックではなくSQLファイルに記述する</span></a> で説明したように、SQLはSQLファイルで管理する。
SQLファイルを扱うためには、コンポーネント設定ファイルへの設定が必要となる。
詳細は、 <a class="reference internal" href="#database-load-sql"><span>SQLファイルからSQLをロードするための設定</span></a> を参照。</p>
<p>SQLファイルは以下のルールで作成する。</p>
<ul class="simple">
<li>クラスパス配下に作成する。</li>
<li>1つのSQLファイルに複数のSQLを記述できるが、SQLIDはファイル内で一意とする。</li>
<li>SQLIDとSQLIDとの間には空行を挿入する。(スペースが存在する行は空行とはみなさない)</li>
<li>SQLIDとSQLとの間には <code class="docutils literal"><span class="pre">=</span></code> を入れる。</li>
<li>コメントは <code class="docutils literal"><span class="pre">--</span></code> で記述する。(ブロックコメントはサポートしない)</li>
<li>SQLは改行やスペース(tab)などで整形してもよい。</li>
</ul>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>SQLを複数機能で流用せずに、かならず機能毎に作成すること。</p>
<p class="last">複数機能で流用した場合、意図しない使われ方やSQLが変更されることにより思わぬ不具合が発生する原因となる。
例えば、複数機能で使用していたSQL文に排他ロック用の <code class="docutils literal"><span class="pre">for</span> <span class="pre">update</span></code> が追加された場合、
排他ロックが不要な機能でロックが取得され処理遅延の原因となる。</p>
</div>
<p>以下にSQLファイルの例を示す。</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- ＸＸＸＸＸ取得SQL</span>
<span class="c1">-- SQL_ID:GET_XXXX_INFO</span>
<span class="n">GET_XXXX_INFO</span> <span class="o">=</span>
<span class="k">select</span>
   <span class="n">col1</span><span class="p">,</span>
   <span class="n">col2</span>
<span class="k">from</span>
   <span class="n">test_table</span>
<span class="k">where</span>
   <span class="n">col1</span> <span class="o">=</span> <span class="p">:</span><span class="n">col1</span>


<span class="c1">-- ＸＸＸＸＸ更新SQL</span>
<span class="c1">-- SQL_ID:UPDATE_XXXX</span>
<span class="n">update_xxxx</span> <span class="o">=</span>
<span class="k">update</span>
    <span class="n">test_table</span>
<span class="k">set</span>
    <span class="n">col2</span> <span class="o">=</span> <span class="p">:</span><span class="n">col2</span>
<span class="k">where</span>
    <span class="n">col1</span> <span class="o">=</span> <span class="p">:</span><span class="n">col1</span>
</pre></div>
</div>
<dl class="docutils" id="database-load-sql">
<dt>SQLファイルからSQLをロードするための設定</dt>
<dd><p class="first">SQLファイルからSQLをロードするために必要な設定内容を説明する。</p>
<p>SQLをロードするためには、以下の例のように <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html#setSqlLoader-nablarch.core.cache.StaticDataLoader-" title="nablarch.core.db.statement.BasicStatementFactory.setSqlLoader(nablarch.core.cache.StaticDataLoader)">BasicStatementFactory#sqlLoader</a>
に <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicSqlLoader.html" title="nablarch.core.db.statement.BasicSqlLoader">BasicSqlLoader</a> を設定する。</p>
<p>この例では、ファイルエンコーディングと拡張子を設定している。設定を省略した場合は以下の設定値となる。</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">ファイルエンコーディング:</th><td class="field-body">utf-8</td>
</tr>
<tr class="field-even field"><th class="field-name">拡張子:</th><td class="field-body">sql</td>
</tr>
</tbody>
</table>
<p>ここで定義した <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html" title="nablarch.core.db.statement.BasicStatementFactory">BasicStatementFactory</a> コンポーネントは、 <a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a>
で定義したデータベース接続を取得するコンポーネントに設定する必要がある。</p>
<dl class="last docutils">
<dt>設定例</dt>
<dd><div class="first last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;statementFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.BasicStatementFactory&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlLoader&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.BasicSqlLoader&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;fileEncoding&quot;</span> <span class="na">value=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;extension&quot;</span> <span class="na">value=</span><span class="s">&quot;sql&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/component&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</dd>
</dl>
</div>
<div class="section" id="sqlidsql">
<span id="database-execute-sqlid"></span><h3><a class="toc-backref" href="#id43">7.3.1.3.4. SQLIDを指定してSQLを実行する</a><a class="headerlink" href="#sqlidsql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SQLIDを元にSQLを実行するには、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/DbConnectionContext.html" title="nablarch.core.db.connection.DbConnectionContext">DbConnectionContext</a> から取得したデータベース接続を使用する。
なお、  <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/DbConnectionContext.html" title="nablarch.core.db.connection.DbConnectionContext">DbConnectionContext</a> には、 <a class="reference internal" href="../../handlers/common/database_connection_management_handler.html#database-connection-management-handler"><span>データベース接続管理ハンドラ</span></a> でデータベース接続を登録する必要がある。</p>
<p>SQLIDと実際に実行されるSQLとのマッピングルールは以下のとおり。</p>
<ul class="simple">
<li>SQLIDの <code class="docutils literal"><span class="pre">#</span></code> までがSQLファイル名となる。</li>
<li>SQLIDの <code class="docutils literal"><span class="pre">#</span></code> 以降がSQLファイル内のSQLIDとなる。</li>
</ul>
<dl class="docutils">
<dt>実装例</dt>
<dd><p class="first">この例では、 SQLIDに、 <code class="docutils literal"><span class="pre">jp.co.tis.sample.action.SampleAction#findUser</span></code> と指定しているため、
SQLファイルはクラスパス配下の <code class="docutils literal"><span class="pre">jp.co.tis.sample.action.SampleAction.sql</span></code> となる。
SQLファイル内のSQLIDは、 <code class="docutils literal"><span class="pre">findUser</span></code> となる。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/AppDbConnection.html" title="nablarch.core.db.connection.AppDbConnection">AppDbConnection</a> や
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlPStatement.html" title="nablarch.core.db.statement.SqlPStatement">SqlPStatement</a> の使用方法は、Javadocを参照。</li>
</ul>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// DbConnectionContextからデータベース接続を取得する。</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDを元にステートメントを生成する。</span>
<span class="n">SqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#findUser&quot;</span><span class="o">);</span>

<span class="c1">// 条件を設定する。</span>
<span class="n">statement</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>

<span class="c1">// 検索処理を実行する。</span>
<span class="n">SqlResultSet</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id44">7.3.1.3.5. ストアードプロシージャを実行する</a><a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ストアードプロシージャを実行する場合も、基本的にはSQLを実行する場合と同じように実装する。</p>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>ストアードプロシージャの実行では、 <a class="reference internal" href="#database-bean"><span>Beanのプロパティ値をSQLのバインド変数に埋め込むことができる</span></a> はサポートしない。
これは、ストアードプロシージャを使用した場合、ロジックがJavaとストアードプロシージャに分散してしまい、
保守性を著しく低下させるため原則使用すべきではないとしているためである。</p>
<p class="last">ただし、既存の資産などでどうしてもストアードプロシージャを使用しなければならないケースが想定されるため、
本機能では非常に簡易的ではあるがストアードプロシージャを実行するためのAPIを提供している。</p>
</div>
<p>以下に例を示す。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlCStatement.html" title="nablarch.core.db.statement.SqlCStatement">SqlCStatement</a> の詳細な使用方法は、Javadocを参照すること。</li>
</ul>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// SQLIDを元にストアードプロシージャ実行用のステートメントを生成する。</span>
<span class="n">SqlCStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareCallBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#execute_sp&quot;</span><span class="o">);</span>

<span class="c1">// IN及びOUTパラメータを設定する。</span>
<span class="n">statement</span><span class="o">.</span><span class="na">registerOutParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Types</span><span class="o">.</span><span class="na">CHAR</span><span class="o">);</span>

<span class="c1">// 実行する。</span>
<span class="n">statement</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

<span class="c1">// OUTパラメータを取得する。</span>
<span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</pre></div>
</div>
</div>
<div class="section" id="database-paging">
<span id="id11"></span><h3><a class="toc-backref" href="#id45">7.3.1.3.6. 検索範囲を指定してSQLを実行する</a><a class="headerlink" href="#database-paging" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ウェブシステムの一覧検索画面などでは、ページング機能を用いて特定の範囲の結果のみを表示することがある。
このような用途向けに本機能では、検索結果の範囲を指定できる機能を提供している。</p>
<dl class="docutils">
<dt>実装例</dt>
<dd><p class="first">データベース接続( <cite>connection</cite> )からステートメントを生成する際に、検索対象の範囲を指定する。
この例では、以下の値を指定しているので、11件目から最大10件のレコードが取得される。</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">開始位置:</th><td class="field-body">11</td>
</tr>
<tr class="field-even field"><th class="field-name">取得件数:</th><td class="field-body">10</td>
</tr>
</tbody>
</table>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// DbConnectionContextからデータベース接続を取得する</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDと検索範囲を指定してステートメントオブジェクトを生成する。</span>
<span class="n">SqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#findUser&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SelectOption</span><span class="o">(</span><span class="mi">11</span><span class="o">,</span> <span class="mi">10</span><span class="o">));</span>

<span class="c1">// 検索処理を実行する</span>
<span class="n">SqlResultSet</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>
</pre></div>
</div>
</dd>
</dl>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">検索範囲が指定された場合、検索用のSQLを取得範囲指定のSQLに書き換えてから実行を行う。
なお、取得範囲指定のSQLは <a class="reference internal" href="#database-dialect"><span>ダイアレクト</span></a> により行われる。</p>
</div>
</div>
<div class="section" id="database-input-bean">
<span id="id12"></span><h3><a class="toc-backref" href="#id46">7.3.1.3.7. Beanオブジェクトを入力としてSQLを実行する</a><a class="headerlink" href="#database-input-bean" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="#database-bean"><span>Beanのプロパティ値をSQLのバインド変数に埋め込むことができる</span></a> で説明したように、Beanオブジェクトを入力としてSQLを実行することができる。</p>
<p>Beanオブジェクトを入力としてSQLを実行する場合は、SQLのINパラメータには名前付きバインド変数を用いる。
名前付きパラメータには、 <code class="docutils literal"><span class="pre">:</span></code> に続けて入力として受け取るBeanのプロパティ名を記述する。</p>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">INパラメータをJDBC標準の <code class="docutils literal"><span class="pre">?</span></code> で記述した場合、 Beanオブジェクトを入力としたSQLの実行は動作しないので注意すること。</p>
</div>
<p>以下に実装例を示す。</p>
<dl class="docutils">
<dt>SQL例</dt>
<dd><p class="first">INパラメータには名前付きパラメータを使用する。</p>
<div class="last highlight-sql"><div class="highlight"><pre><span></span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span>
  <span class="p">(</span>
  <span class="n">id</span><span class="p">,</span>
  <span class="n">name</span>
  <span class="p">)</span> <span class="k">values</span> <span class="p">(</span>
  <span class="p">:</span><span class="n">id</span><span class="p">,</span>
  <span class="p">:</span><span class="n">userName</span>
  <span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>実装例</dt>
<dd><p class="first">Beanオブジェクトに必要な値を設定し、Beanオブジェクトを入力としてSQLを実行する機能を呼び出す。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/AppDbConnection.html" title="nablarch.core.db.connection.AppDbConnection">AppDbConnection</a> や <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/ParameterizedSqlPStatement.html" title="nablarch.core.db.statement.ParameterizedSqlPStatement">ParameterizedSqlPStatement</a> の使用方法は、Javadocを参照。</li>
<li>SQLIDと実行されるSQLの関係については、 <a class="reference internal" href="#database-execute-sqlid"><span>SQLIDを指定してSQLを実行する</span></a> を参照</li>
</ul>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// beanを生成しプロパティに値を設定</span>
<span class="n">UserEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserEntity</span><span class="o">();</span>
<span class="n">entity</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>              <span class="c1">// idプロパティへの値設定</span>
<span class="n">entity</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;なまえ&quot;</span><span class="o">);</span> <span class="c1">// userNameプロパティへの値設定</span>

<span class="c1">// DbConnectionContextからデータベース接続を取得する</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDを元にステートメントを生成する</span>
<span class="n">ParameterizedSqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareParameterizedSqlStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#insertUser&quot;</span><span class="o">);</span>

<span class="c1">// beanのプロパティの値をバインド変数に設定しSQLが実行される</span>
<span class="c1">// SQLの:idにbeanのidプロパティの値が設定される。</span>
<span class="c1">// SQLの:userNameには、beanのuserNameプロパティの値が設定される。</span>
<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeUpdateByObject</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</pre></div>
</div>
</dd>
</dl>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>Beanの代わりに <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/util/Map.html" title="java.util.Map">java.util.Map</a> の実装クラスも指定できる。
Mapを指定した場合は、Mapのキー値と一致するINパラメータに対して、Mapの値が設定される。</p>
<p>なお、Beanを指定した場合は <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/beans/BeanUtil.html" title="nablarch.core.beans.BeanUtil">BeanUtil</a> を使用して、Mapに変換後に処理を行う。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/beans/BeanUtil.html" title="nablarch.core.beans.BeanUtil">BeanUtil</a> で対応していない型がBeanのプロパティに存在した場合、そのプロパティについてはこの機能で使用することが出来ない。</p>
<p class="last"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/beans/BeanUtil.html" title="nablarch.core.beans.BeanUtil">BeanUtil</a> でMapにコピーできる型を増やしたい場合には、 <a class="reference internal" href="../bean_util.html#utility-conversion"><span>BeanUtilの型変換ルール</span></a> を参照し対応すること。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>Beanへのアクセス方法をプロパティからフィールドに変更することができる。
フィールドアクセスに変更する場合には、propertiesファイルに以下の設定を追加する。</p>
<div class="highlight-properties"><div class="highlight"><pre><span></span><span class="na">nablarch.dbAccess.isFieldAccess</span><span class="o">=</span><span class="s">true</span>
</pre></div>
</div>
<p>なお、フィールドアクセスは以下の理由により推奨しない。</p>
<p class="last">本フレームワークのその他の機能(例えば <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/beans/BeanUtil.html" title="nablarch.core.beans.BeanUtil">BeanUtil</a>)では、Beanから値を取得する方法はプロパティアクセスで統一されている。
データベース機能のみフィールドアクセスに変更した場合、プログラマはフィールドアクセスとプロパティアクセスの両方を意識する必要があり、生産性の低下や不具合の原因ともなる。</p>
</div>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id47">7.3.1.3.8. 型を変換する</a><a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベースアクセス(JDBCラッパー)は、データベースとの入出力に使用する変数の型変換をJDBCドライバに委譲する。
よって、入出力に使用する変数の型は、データベースの型及び使用するJDBCドライバの仕様に応じた定義を行う必要がある。</p>
<p>任意の型変換が必要な場合は、データベースとの入出力に使用する変数に対して、アプリケーション側で型変換を行うこととなる。</p>
<ul class="simple">
<li>入力にBeanを使用する場合はBeanのプロパティに値を設定する際、出力にBeanを使用する場合はプロパティから値を取り出した後に型変換を行う。</li>
<li>入力にMapを使用する場合はMapに値を設定する際、出力にMapを使用する場合は値を取り出した後に型変換を行う。</li>
<li>インデックスを指定してバインド変数を設定する際に、バインド変数に設定するオブジェクトを適切な型に変換する。 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlRow.html" title="nablarch.core.db.statement.SqlRow">SqlRow</a> から値を取得する際は、取得後に型変換を行う。</li>
</ul>
</div>
<div class="section" id="database-common-bean">
<span id="id14"></span><h3><a class="toc-backref" href="#id48">7.3.1.3.9. SQL実行時に共通的な値を自動的に設定したい</a><a class="headerlink" href="#database-common-bean" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データ登録時や更新時に毎回設定する値をSQLの実行直前に自動的に設定する機能を提供する。
例えば、登録日時や更新日時といった項目に対して、この機能が使用できる。</p>
<p>この機能は、プロパティに設定されたアノテーションを元に、値の自動設定を行うため、
<a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> を使用した場合のみ有効となる。</p>
<p>以下に使用例を示す。</p>
<dl class="docutils">
<dt>コンポーネント設定ファイル</dt>
<dd><p class="first">この機能を使用するには、コンポーネント設定ファイルに値の自動設定を行うクラスを設定する。</p>
<p>以下の例のように、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html#setUpdatePreHookObjectHandlerList-java.util.List-" title="nablarch.core.db.statement.BasicStatementFactory.setUpdatePreHookObjectHandlerList(java.util.List)">BasicStatementFactory#updatePreHookObjectHandlerList</a> に対して、
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/AutoPropertyHandler.html" title="nablarch.core.db.statement.AutoPropertyHandler">AutoPropertyHandler</a> 実装クラスをlistで設定する。
なお、標準で提供される実装クラスは <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/autoproperty/package-summary.html" title="nablarch.core.db.statement.autoproperty.package-summary">nablarch.core.db.statement.autoproperty</a> パッケージ配下に配置されている。</p>
<p>ここで定義した <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html" title="nablarch.core.db.statement.BasicStatementFactory">BasicStatementFactory</a> コンポーネントは、 <a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a>
で定義したデータベース接続を取得するコンポーネントに設定すること。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;statementFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.BasicStatementFactory&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;updatePreHookObjectHandlerList&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="c">&lt;!-- nablarch.core.db.statement.AutoPropertyHandler実装クラスをlistで設定する--&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>Beanオブジェクト(Entity)</dt>
<dd><p class="first">自動で値を設定したいプロパティにアノテーションを設定する。
なお、標準で提供されるアノテーションは <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/autoproperty/package-summary.html" title="nablarch.core.db.statement.autoproperty.package-summary">nablarch.core.db.statement.autoproperty</a> パッケージ配下に配置されている。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserEntity</span> <span class="o">{</span>
  <span class="c1">// ユーザID</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>

  <span class="c1">// 登録日時</span>
  <span class="c1">// 登録時に自動設定される</span>
  <span class="nd">@CurrentDateTime</span>
  <span class="kd">private</span> <span class="n">Timestamp</span> <span class="n">createdAt</span><span class="o">;</span>

  <span class="c1">// 更新日時</span>
  <span class="c1">// 登録・更新時に自動設定される</span>
  <span class="nd">@CurrentDateTime</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">updatedAt</span><span class="o">;</span>

  <span class="c1">// アクセスメソッドなどは省略</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>SQL</dt>
<dd><p class="first">SQLは、 <a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> と同じように作成する。</p>
<div class="last highlight-sql"><div class="highlight"><pre><span></span><span class="k">insert</span> <span class="k">into</span> <span class="k">user</span> <span class="p">(</span>
  <span class="n">id</span><span class="p">,</span>
  <span class="n">createdAt</span><span class="p">,</span>
  <span class="n">updatedAt</span>
<span class="p">)</span> <span class="k">values</span> <span class="p">(</span>
  <span class="p">:</span><span class="n">id</span><span class="p">,</span>
  <span class="p">:</span><span class="n">createdAt</span><span class="p">,</span>
  <span class="p">:</span><span class="n">updatedAt</span>
<span class="p">)</span>
</pre></div>
</div>
</dd>
<dt>実装例</dt>
<dd><p class="first">基本的には、 <a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> と同じように実装する。
値が自動設定される項目については、ロジックでBeanに対して値を設定する必要が無い。
なお、値を明示的に設定したとしても、SQL実行直前に値の自動設定機能により上書きされる。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// beanを生成しプロパティに値を設定</span>
<span class="c1">// 自動設定項目であるcreatedAtとupdatedAtには値を設定する必要はない</span>
<span class="n">UserEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserEntity</span><span class="o">();</span>
<span class="n">entity</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

<span class="c1">// DbConnectionContextからデータベース接続を取得する</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDを元にステートメントを生成する</span>
<span class="n">ParameterizedSqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareParameterizedSqlStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#insertUser&quot;</span><span class="o">);</span>

<span class="c1">// 自動設定項目に値を設定せずに呼び出す。</span>
<span class="c1">// データベース機能が自動的に値を設定する。</span>
<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeUpdateByObject</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="database-like-condition">
<span id="id15"></span><h3><a class="toc-backref" href="#id49">7.3.1.3.10. like検索を行う</a><a class="headerlink" href="#database-like-condition" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>like検索は、 <a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> を使用し、SQLにはlike検索用の条件を以下のルールで記述する。</p>
<dl class="docutils">
<dt>前方一致の場合</dt>
<dd><p class="first">名前付きパラメータの末尾に <code class="docutils literal"><span class="pre">%</span></code> を記述する。</p>
<p class="last">例: <code class="docutils literal"><span class="pre">name</span> <span class="pre">like</span> <span class="pre">:userName%</span></code></p>
</dd>
<dt>後方一致の場合</dt>
<dd><p class="first">名前付きパラメータの先頭に <code class="docutils literal"><span class="pre">%</span></code> を記述する。</p>
<p class="last">例: <code class="docutils literal"><span class="pre">name</span> <span class="pre">like</span> <span class="pre">:%userName</span></code></p>
</dd>
<dt>途中一致の場合</dt>
<dd><p class="first">名前付きパラメータの前後に <code class="docutils literal"><span class="pre">%</span></code> を記述する。</p>
<p class="last">例: <code class="docutils literal"><span class="pre">name</span> <span class="pre">like</span> <span class="pre">:%userName%</span></code></p>
</dd>
</dl>
<p>like検索時のエスケープ文字及びエスケープ対象文字の定義は、 <a class="reference internal" href="#database-def-escape-char"><span>like検索時のエスケープ文字及びエスケープ対象文字を定義する</span></a> を参照。</p>
<p>以下に実装例を示す。</p>
<dl class="docutils">
<dt>SQL</dt>
<dd><p class="first">上記のルールに従いSQLを定義する。</p>
<div class="last highlight-sql"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="o">*</span>
  <span class="k">from</span> <span class="k">user</span>
 <span class="k">where</span> <span class="n">name</span> <span class="k">like</span> <span class="p">:</span><span class="n">userName</span><span class="o">%</span>
</pre></div>
</div>
</dd>
<dt>実装例</dt>
<dd><p class="first"><a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> と同じようにSQLを実行するだけで、like条件用に値の書き換えやエスケープ処理が行われる。
この例の場合、実際の条件は <code class="docutils literal"><span class="pre">name</span> <span class="pre">like</span> <span class="pre">'な%'</span> <span class="pre">escape</span> <span class="pre">'\'</span></code> となる。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/AppDbConnection.html" title="nablarch.core.db.connection.AppDbConnection">AppDbConnection</a> や <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/ParameterizedSqlPStatement.html" title="nablarch.core.db.statement.ParameterizedSqlPStatement">ParameterizedSqlPStatement</a> の使用方法は、Javadocを参照。</li>
<li>SQLIDと実行されるSQLの関係については、 <a class="reference internal" href="#database-execute-sqlid"><span>SQLIDを指定してSQLを実行する</span></a> を参照</li>
</ul>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// beanを生成しプロパティに値を設定</span>
<span class="n">UserEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserEntity</span><span class="o">();</span>
<span class="n">entity</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;な&quot;</span><span class="o">);</span> <span class="c1">// userNameプロパティへの値設定</span>

<span class="c1">// DbConnectionContextからデータベース接続を取得する</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDを元にステートメントを生成する</span>
<span class="n">ParameterizedSqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareParameterizedSqlStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#findUserByName&quot;</span><span class="o">);</span>

<span class="c1">// beanのプロパティ値をバインド変数に設定しSQLが実行される</span>
<span class="c1">// この例の場合、name like &#39;な%&#39; が実行される</span>
<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="database-def-escape-char">
<span id="id16"></span><h3><a class="toc-backref" href="#id50">7.3.1.3.11. like検索時のエスケープ文字及びエスケープ対象文字を定義する</a><a class="headerlink" href="#database-def-escape-char" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>エスケープ文字及びエスケープ対象文字の定義は、コンポーネント設定ファイルに行う。
なお、エスケープ文字は自動的対象にエスケープとなるため、明示的にエスケープ対象文字に設定する必要はない。</p>
<p>設定を省略した場合は、以下の値を使用する。</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">エスケープ文字:</th><td class="field-body"><code class="docutils literal"><span class="pre">\</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name">エスケープ対象文字:</th><td class="field-body"><code class="docutils literal"><span class="pre">%</span></code> 、 <code class="docutils literal"><span class="pre">_</span></code></td>
</tr>
</tbody>
</table>
<dl class="docutils">
<dt>コンポーネント設定例</dt>
<dd><p class="first">この例ではエスケープ文字に <code class="docutils literal"><span class="pre">\</span></code> を設定し、エスケープ文字には <code class="docutils literal"><span class="pre">%</span></code> 、 <code class="docutils literal"><span class="pre">％</span></code> 、 <code class="docutils literal"><span class="pre">_</span></code> 、 <code class="docutils literal"><span class="pre">＿</span></code> の4文字を設定している。</p>
<p>ここで定義した <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html" title="nablarch.core.db.statement.BasicStatementFactory">BasicStatementFactory</a> コンポーネントは、 <a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a>
で定義したデータベース接続を取得するコンポーネントに設定すること。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;statementFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.BasicStatementFactory&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- エスケープ文字の定義 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;likeEscapeChar&quot;</span> <span class="na">value=</span><span class="s">&quot;\&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- エスケープ対象文字の定義(カンマ区切りで設定する) --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;likeEscapeTargetCharList&quot;</span> <span class="na">value=</span><span class="s">&quot;%,％,_,＿&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="database-use-variable-condition">
<span id="id17"></span><h3><a class="toc-backref" href="#id51">7.3.1.3.12. 可変条件を持つSQLを実行する</a><a class="headerlink" href="#database-use-variable-condition" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>可変条件を持つSQLの実行は、 <a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> を使用し、以下の記法を用いて条件を記述する。</p>
<dl class="docutils">
<dt>可変条件の記述ルール</dt>
<dd><p class="first">可変条件は、 <code class="docutils literal"><span class="pre">$if(プロパティ名)</span> <span class="pre">{SQL文の条件}</span></code> で記述する。
<code class="docutils literal"><span class="pre">$if</span></code> の後のプロパティ名に対応したBeanオブジェクトの値により、その条件が除外される。
除外される条件は以下のとおり。</p>
<ul class="simple">
<li>配列や <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/util/Collection.html" title="java.util.Collection">java.util.Collection</a> の場合は、プロパティ値がnullやサイズ0の場合</li>
<li>上記以外の型の場合は、プロパティ値がnullや空文字列(Stringオブジェクトの場合)</li>
</ul>
<p>なお、 <code class="docutils literal"><span class="pre">$if</span></code> 特殊構文には以下の制約がある。</p>
<ul class="simple">
<li>利用できる箇所はwhere句のみ</li>
<li><code class="docutils literal"><span class="pre">$if</span></code> 内に <code class="docutils literal"><span class="pre">$if</span></code> を使用することはできない</li>
</ul>
<div class="last admonition important">
<p class="first admonition-title">重要</p>
<p class="last">この機能は、ウェブアプリケーションの検索画面のようにユーザの入力内容によって検索条件が変わるような場合に使うものである。
条件だけが異なる複数のSQLを共通化するために使用するものではない。
安易に共通化した場合、SQLを変更した場合に思わぬ不具合を埋め込む原因にもなるため、必ずSQLを複数定義すること。</p>
</div>
</dd>
</dl>
<p>以下に例を示す。</p>
<dl class="docutils">
<dt>SQL</dt>
<dd><p class="first">このSQLの場合、 <code class="docutils literal"><span class="pre">user_name</span></code> と <code class="docutils literal"><span class="pre">user_kbn</span></code> の条件が可変となる。</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>select
  user_id,
  user_name,
  user_kbn
from
  user
where
  $if (userName) {user_name like :user_name%}
  and $if (userKbn) {user_kbn in (&#39;1&#39;, &#39;2&#39;)}
  and birthday = :birthday
</pre></div>
</div>
</dd>
<dt>実装例</dt>
<dd><p class="first"><cite>userName</cite> プロパティのみに値が設定されているので、
可変条件で定義されている <code class="docutils literal"><span class="pre">user_kbn</span></code> は実行時の条件から除外される。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// beanを生成しプロパティに値を設定</span>
<span class="n">UserEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserEntity</span><span class="o">();</span>
<span class="n">entity</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;なまえ&quot;</span><span class="o">);</span>

<span class="c1">// DbConnectionContextからデータベース接続を取得する</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDを元にステートメントを生成する</span>
<span class="c1">// 2番めの引数には、条件を持つBeanオブジェクトを指定する。</span>
<span class="c1">// このBeanオブジェクトの状態を元にSQLの可変条件の組み立てが行われる。</span>
<span class="n">ParameterizedSqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareParameterizedSqlStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#insertUser&quot;</span><span class="o">,</span> <span class="n">entity</span><span class="o">);</span>

<span class="c1">// entityのプロパティの値をバインド変数に設定しSQLが実行される</span>
<span class="n">SqlResultSet</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="insql">
<span id="database-in-condition"></span><h3><a class="toc-backref" href="#id52">7.3.1.3.13. in句の条件数が可変となるSQLを実行する</a><a class="headerlink" href="#insql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>in句の条件数が可変となるSQLの実行は、 <a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> を使用し、以下の記法を用いて条件を記述する。</p>
<dl class="docutils">
<dt>in句の記述ルール</dt>
<dd><p class="first">条件の名前付きパラメータの末尾に <code class="docutils literal"><span class="pre">[]</span></code> を付加する。
また名前付きパラメータに対応するBeanオブジェクトのプロパティの型は、
配列か <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/util/Collection.html" title="java.util.Collection">java.util.Collection</a> (サブタイプ含む) <a class="footnote-reference" href="#collection" id="id18">[1]</a> とする必要がある。</p>
<div class="last admonition tip">
<p class="first admonition-title">補足</p>
<p>in句の条件となるプロパティ値がnullやサイズ0となる場合には、該当条件は必ず可変条件として定義すること。
もし、可変条件としなかった場合でプロパティ値がnullの場合、条件が <code class="docutils literal"><span class="pre">xxxx</span> <span class="pre">in</span> <span class="pre">(null)</span></code> となるため、
検索結果が正しく取得できない可能性がある。</p>
<p class="last">※in句は、条件式(カッコの中)を空にすることはできないため、サイズ0の配列やnullが指定された場合には、条件式を <code class="docutils literal"><span class="pre">in</span> <span class="pre">(null)</span></code> とする仕様としている。</p>
</div>
</dd>
</dl>
<p>以下に例を示す。</p>
<dl class="docutils">
<dt>SQL</dt>
<dd><p class="first">このSQLでは、 <code class="docutils literal"><span class="pre">user_kbn</span></code> のin条件が動的に構築される。
なお、 <code class="docutils literal"><span class="pre">$if</span></code> と併用しているため、 <cite>userKbn</cite> プロパティがnullやサイズが0の場合には条件から除外される。</p>
<div class="last highlight-none"><div class="highlight"><pre><span></span>select
  user_id,
  user_name,
  user_kbn
from
  user
where
  $if (userKbn) {user_kbn in (:userKbn[])}
</pre></div>
</div>
</dd>
<dt>実行例</dt>
<dd><p class="first">この例では、 <cite>userKbn</cite> プロパティに2つの要素が設定されているので、
実行されるSQLの条件は <code class="docutils literal"><span class="pre">userKbn</span> <span class="pre">in</span> <span class="pre">(?,</span> <span class="pre">?)</span></code> となる。</p>
<p>データベースから取得されるのは、 <cite>userKbn</cite> が <code class="docutils literal"><span class="pre">1</span></code> と <code class="docutils literal"><span class="pre">3</span></code> のレコードとなる。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// beanを生成しプロパティに値を設定</span>
<span class="n">UserSearchCondition</span> <span class="n">condition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserSearchCondition</span><span class="o">();</span>
<span class="n">condition</span><span class="o">.</span><span class="na">setUserKbn</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&quot;1&quot;</span><span class="o">,</span> <span class="s">&quot;3&quot;</span><span class="o">));</span>

<span class="c1">// DbConnectionContextからデータベース接続を取得する</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDを元にステートメントを生成する</span>
<span class="c1">// 2番めの引数には、条件を持つBeanオブジェクトを指定する。</span>
<span class="c1">// このBeanオブジェクトの状態を元にSQLのin句の組み立てが行われる。</span>
<span class="n">ParameterizedSqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareParameterizedSqlStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#searchUser&quot;</span><span class="o">,</span> <span class="n">condition</span><span class="o">);</span>

<span class="c1">// conditionのプロパティの値をバインド変数に設定しSQLが実行される</span>
<span class="n">SqlResultSet</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">condition</span><span class="o">);</span>
</pre></div>
</div>
</dd>
</dl>
<table class="docutils footnote" frame="void" id="collection" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id18">[1]</a></td><td><p class="first"><a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> に記載がある通り、プロパティの値は <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/beans/BeanUtil.html" title="nablarch.core.beans.BeanUtil">BeanUtil</a> を使用してMapに変換してから使用する。
このため、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/beans/BeanUtil.html" title="nablarch.core.beans.BeanUtil">BeanUtil</a> でサポートされていない型でプロパティが宣言されていた場合、
in句に条件を設定できないため注意すること。</p>
<p class="last">なお、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/beans/BeanUtil.html" title="nablarch.core.beans.BeanUtil">BeanUtil</a> で変換対象の型を追加する方法は、
<a class="reference internal" href="../bean_util.html#utility-conversion-add-rule"><span>型変換ルールを追加する</span></a> を参照。</p>
</td></tr>
</tbody>
</table>
</div>
<div class="section" id="order-bysql">
<span id="database-make-order-by"></span><h3><a class="toc-backref" href="#id53">7.3.1.3.14. order byのソート項目を実行時に動的に切り替えてSQLを実行する</a><a class="headerlink" href="#order-bysql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>order byのソート項目が可変となるSQLの実行は、 <a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a> を使用し、以下の記法を用いて条件を記述する。</p>
<dl class="docutils">
<dt>order by句の記述ルール</dt>
<dd><p class="first">ソート項目を可変にする場合は、order by句の代わりに <code class="docutils literal"><span class="pre">$sort</span></code> を使用し、以下のように記述する。</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>$sort(プロパティ名) {(ケース1)(ケース2)・・・(ケースn)}

プロパティ名: BeanオブジェクトのソートIDを保持するプロパティ名
ケース: order by句の切り替え候補を表す。
        候補を一意に識別するソートIDとorder by句に指定する文字列(以降はケース本体と称す)を記述する。
        どの候補にも一致しない場合に使用するデフォルトのケースには、ソートIDに&quot;default&quot;を指定する。
</pre></div>
</div>
<ul class="last simple">
<li>各ケースは、ソートIDとケース本体を半角丸括弧で囲んで表現する。</li>
<li>ソートIDとケース本体は、半角スペースで区切る。</li>
<li>ソートIDには半角スペースを使用不可とする。</li>
<li>ケース本体には半角スペースを使用できる。</li>
<li>括弧開き以降で最初に登場する文字列をソートIDとする。</li>
<li>ソートID以降で括弧閉じまでの間をケース本体とする。</li>
<li>ソートIDおよびケース本体はトリミングする。</li>
</ul>
</dd>
</dl>
<p>以下に使用例を示す。</p>
<dl class="docutils">
<dt>SQL</dt>
<dd><div class="first last highlight-none"><div class="highlight"><pre><span></span>select
  user_id,
  user_name
from
  user
where
  user_name = :user_name
$sort(sortId) {
  (user_id_asc  user_id asc)
  (user_id_desc user_id desc)
  (name_asc     user_name asc)
  (name_desc    user_name desc)
  (default      user_id)
}
</pre></div>
</div>
</dd>
<dt>実装例</dt>
<dd><p class="first">この例では、ソートIDに <code class="docutils literal"><span class="pre">name_asc</span></code> を設定しているので、
order by句は <code class="docutils literal"><span class="pre">order</span> <span class="pre">by</span> <span class="pre">user_name</span> <span class="pre">asc</span></code> となる。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// beanを生成しプロパティに値を設定</span>
<span class="n">UserSearchCondition</span> <span class="n">condition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserSearchCondition</span><span class="o">();</span>
<span class="n">condition</span><span class="o">.</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;なまえ&quot;</span><span class="o">);</span>
<span class="n">condition</span><span class="o">.</span><span class="na">setSortId</span><span class="o">(</span><span class="s">&quot;name_asc&quot;</span><span class="o">);</span>      <span class="c1">// ソートIDを設定する</span>

<span class="c1">// DbConnectionContextからデータベース接続を取得する</span>
<span class="n">AppDbConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>

<span class="c1">// SQLIDを元にステートメントを生成する</span>
<span class="c1">// 2番めの引数には、条件を持つBeanオブジェクトを指定する。</span>
<span class="c1">// このBeanオブジェクトの状態を元にSQLのorder by句の組み立てが行われる。</span>
<span class="n">ParameterizedSqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareParameterizedSqlStatementBySqlId</span><span class="o">(</span>
    <span class="s">&quot;jp.co.tis.sample.action.SampleAction#searchUser&quot;</span><span class="o">,</span> <span class="n">condition</span><span class="o">);</span>

<span class="c1">// conditionのプロパティの値をバインド変数に設定しSQLが実行される</span>
<span class="n">SqlResultSet</span> <span class="n">result</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">condition</span><span class="o">);</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="database-binary-column">
<span id="id19"></span><h3><a class="toc-backref" href="#id54">7.3.1.3.15. バイナリ型のカラムにアクセスする</a><a class="headerlink" href="#database-binary-column" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>blob(データベース製品によりバイナリ型の型は異なる)などのバイナリ型のカラムへのアクセス方法について説明する。</p>
<dl class="docutils">
<dt>バイナリ型の値を取得する</dt>
<dd><p class="first">バイナリ型の値を取得する場合には、検索結果オブジェクトの <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlRow.html" title="nablarch.core.db.statement.SqlRow">SqlRow</a> から <cite>byte[]</cite> として値を取得する。</p>
<p>以下に例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">SqlResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>

<span class="n">SqlRow</span> <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

<span class="c1">// 暗号化されたカラムの値をgetBytesを使ってバイナリで取得する</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">encryptedPassword</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">);</span>
</pre></div>
</div>
<div class="last admonition important">
<p class="first admonition-title">重要</p>
<p>上記実装例の場合、カラムの内容が全てJavaのヒープ上に展開される。
このため、非常に大きいサイズのデータを読み込んだ場合、ヒープ領域を圧迫し、システムダウンなどの障害の原因となる。</p>
<p>このため、大量データを読み込む場合には、以下のように <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Blob.html" title="java.sql.Blob">Blob</a> オブジェクトを使用して、ヒープを大量に消費しないようにすること。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="n">SqlResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>

<span class="c1">// Blogとしてデータを取得する</span>
<span class="n">Blob</span> <span class="n">pdf</span> <span class="o">=</span> <span class="o">(</span><span class="n">Blob</span><span class="o">)</span> <span class="n">rows</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;PDF&quot;</span><span class="o">);</span>

<span class="k">try</span> <span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="na">getBinaryStream</span><span class="o">())</span> <span class="o">{</span>
  <span class="c1">// InputStreamからデータを順次読み込み処理を行う。</span>
  <span class="c1">// 一括で読み込んだ場合、全てヒープに展開されるので注意すること</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</dd>
<dt>バイナリ型の値を登録・更新する</dt>
<dd><blockquote class="first">
<div><p>サイズの小さいバイナリ値を登録・更新する場合は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlPStatement.html#setBytes-int-byte:A-" title="nablarch.core.db.statement.SqlPStatement.setBytes(int-byte:A)">SqlPStatement#setByte</a> を使用する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">SqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">getSqlPStatement</span><span class="o">(</span><span class="s">&quot;UPDATE_PASSWORD&quot;</span><span class="o">);</span>

<span class="n">statement</span><span class="o">.</span><span class="na">setBytes</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{</span><span class="mh">0x30</span><span class="o">,</span> <span class="mh">0x31</span><span class="o">,</span> <span class="mh">0x32</span><span class="o">});</span>
<span class="kt">int</span> <span class="n">updateCount</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</pre></div>
</div>
</div></blockquote>
<p>サイズが大きいバイナリ値を登録更新する場合は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlPStatement.html#setBinaryStream-int-java.io.InputStream-int-" title="nablarch.core.db.statement.SqlPStatement.setBinaryStream(int-java.io.InputStream-int)">SqlPStatement#setBinaryStream</a>
を使用して、ファイルなどを表す <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/io/InputStream.html" title="java.io.InputStream">InputStream</a> から直接データベースに値を送信する。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">Path</span> <span class="n">pdf</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;input.pdf&quot;</span><span class="o">);</span>
<span class="k">try</span> <span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newInputStream</span><span class="o">(</span><span class="n">pdf</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">statement</span><span class="o">.</span><span class="na">setBinaryStream</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Files</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">pdf</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="clob">
<span id="database-clob-column"></span><h3><a class="toc-backref" href="#id55">7.3.1.3.16. 桁数の大きい文字列型のカラム(例えばCLOB)にアクセスする</a><a class="headerlink" href="#clob" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>CLOBのような大きいサイズの文字列型カラムへのアクセス方法について解説する。</p>
<dl class="docutils">
<dt>CLOB型の値を取得する</dt>
<dd><p class="first">CLOB型の値を取得する場合は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlRow.html" title="nablarch.core.db.statement.SqlRow">検索結果オブジェクト</a> から文字列型として値を取得する。</p>
<p>以下に例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">SqlResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>
<span class="n">SqlRow</span> <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

<span class="c1">// StringとしてCLOBの値を取得する。</span>
<span class="n">String</span> <span class="n">mailBody</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;mailBody&quot;</span><span class="o">);</span>
</pre></div>
</div>
<div class="last admonition important">
<p class="first admonition-title">重要</p>
<p>上記実装例の場合、カラムの内容が全てJavaのヒープ上に展開される。
このため、非常に大きいサイズのデータを読み込んだ場合、ヒープ領域を圧迫し、システムダウンなどの障害の原因となる。</p>
<p>このため、大量データを読み込む場合には、以下のように <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Clob.html" title="java.sql.Clob">Clob</a> オブジェクトを使用して、
ヒープを大量に消費しないようにすること。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="n">SqlResultSet</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>

<span class="c1">// Clogとしてデータを取得する</span>
<span class="n">Clob</span> <span class="n">mailBody</span> <span class="o">=</span> <span class="o">(</span><span class="n">Clob</span><span class="o">)</span> <span class="n">rows</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;mailBody&quot;</span><span class="o">);</span>

<span class="k">try</span> <span class="o">(</span><span class="n">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">mailBody</span><span class="o">.</span><span class="na">getCharacterStream</span><span class="o">())</span> <span class="o">{</span>
  <span class="c1">// Readerからデータを順次読み込み処理を行う。</span>
  <span class="c1">// 読み込んだデータをヒープ上に全て保持した場合は、ヒープを圧迫するので注意すること。</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</dd>
<dt>CLOB型に値を登録(更新)する</dt>
<dd><p class="first">サイズが小さい値を登録更新する場合は、String型の値を <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlPStatement.html#setString-int-java.lang.String-" title="nablarch.core.db.statement.SqlPStatement.setString(int-java.lang.String)">SqlPStatement#setString</a> を使用して設定する。</p>
<p>以下に例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">statement</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;値&quot;</span><span class="o">);</span>
<span class="n">statement</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</pre></div>
</div>
<p>サイズが大きい値を登録、更新する場合は <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlPStatement.html#setCharacterStream-int-java.io.Reader-int-" title="nablarch.core.db.statement.SqlPStatement.setCharacterStream(int-java.io.Reader-int)">SqlPStatement#setCharacterStream</a>
を使用して、テキストファイルなどを表す <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/io/Reader.html" title="java.io.Reader">Reader</a> 経由でデータベースに値を送信する。</p>
<p>以下に例を示す。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="n">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
<span class="k">try</span> <span class="o">(</span><span class="n">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">newBufferedReader</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">))</span> <span class="o">{</span>
  <span class="c1">// setCharacterStreamを使用してReaderの値を登録する。</span>
  <span class="n">statement</span><span class="o">.</span><span class="na">setCharacterStream</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">reader</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">Files</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">path</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="id20">
<h3><a class="toc-backref" href="#id56">7.3.1.3.17. データベースアクセス時に発生する例外の種類</a><a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベースアクセス時の例外は、大きく分けて以下の4種類が送出される。</p>
<p>これらの例外は全て非チェック例外のため、 <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/SQLException.html" title="java.sql.SQLException">SQLException</a> のように <code class="docutils literal"><span class="pre">try-catch</span></code> で補足する必要はない。</p>
<dl class="docutils">
<dt>データベースアクセスエラー時の例外</dt>
<dd>データベースアクセス時に発生する例外で、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/DbAccessException.html" title="nablarch.core.db.DbAccessException">DbAccessException</a> が送出される。</dd>
<dt>データベース接続エラー時の例外</dt>
<dd><p class="first">データベースアクセスエラー時の例外がデータベース接続エラーを示す場合には、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/exception/DbConnectionException.html" title="nablarch.core.db.connection.exception.DbConnectionException">DbConnectionException</a> が送出される。
この例外は、 <a class="reference internal" href="../../handlers/standalone/retry_handler.html#retry-handler"><span>リトライハンドラ</span></a> により処理される。(<a class="reference internal" href="../../handlers/standalone/retry_handler.html#retry-handler"><span>リトライハンドラ</span></a> 未適用の場合には、実行時例外として扱われる。)</p>
<p class="last">なお、データベース接続エラーの判定には、 <a class="reference internal" href="#database-dialect"><span>ダイアレクト</span></a> が使用される。</p>
</dd>
<dt>SQL実行時の例外</dt>
<dd>SQLの実行に失敗した時に発生する例外で、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/exception/SqlStatementException.html" title="nablarch.core.db.statement.exception.SqlStatementException">SqlStatementException</a> が送出される。</dd>
<dt>SQL実行時の例外が一意制約違反の場合の例外</dt>
<dd><p class="first">SQL実行時の例外が一意制約違反を示す例外の場合は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/exception/DuplicateStatementException.html" title="nablarch.core.db.statement.exception.DuplicateStatementException">DuplicateStatementException</a> が送出される。</p>
<p>一意制約違反をハンドリングしたい場合には、 <a class="reference internal" href="#database-duplicated-error"><span>一意制約違反をハンドリングして処理を行う</span></a> を参照。</p>
<p class="last">なお、一意制約違反の判定には、 <a class="reference internal" href="#database-dialect"><span>ダイアレクト</span></a> が使用される。</p>
</dd>
</dl>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">データベースアクセスエラー発生時の例外を変更したい場合（より細かく分けたい場合）などは、
<a class="reference internal" href="#database-change-exception"><span>データベースアクセス時の例外クラスを切り替える</span></a> を参照すること。</p>
</div>
</div>
<div class="section" id="database-duplicated-error">
<span id="id21"></span><h3><a class="toc-backref" href="#id57">7.3.1.3.18. 一意制約違反をハンドリングして処理を行う</a><a class="headerlink" href="#database-duplicated-error" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>一意制約違反時に何か処理を行う必要がある場合には、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/exception/DuplicateStatementException.html" title="nablarch.core.db.statement.exception.DuplicateStatementException">DuplicateStatementException</a> を <code class="docutils literal"><span class="pre">try-catch</span></code> で補足し処理をする。</p>
<p>なお、一意制約違反の判定には、 <a class="reference internal" href="#database-dialect"><span>ダイアレクト</span></a> が使用される。</p>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>データベース製品によってはSQL実行時に例外が発生した場合に、ロールバックを行うまで一切のSQLを受け付けないものがあるので注意すること。
このような製品の場合には、他の手段で代用できないか検討すること。</p>
<p class="last">例えば、登録処理で一意制約違反が発生した場合に更新処理をしたい場合は、
例外ハンドリングを行うのではなく <cite>merge</cite> 文を使用することでこの問題を回避できる。</p>
</div>
</div>
<div class="section" id="id22">
<h3><a class="toc-backref" href="#id58">7.3.1.3.19. 処理が長いトランザクションはエラーとして処理を中断させる</a><a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>トランザクション管理にて実現する。
詳細は、 <a class="reference internal" href="../transaction.html#transaction-timeout"><span>データベースに対するトランザクションタイムアウトを適用する</span></a> を参照。</p>
</div>
<div class="section" id="database-new-transaction">
<span id="id23"></span><h3><a class="toc-backref" href="#id59">7.3.1.3.20. 現在のトランザクションとは異なるトランザクションでSQLを実行する</a><a class="headerlink" href="#database-new-transaction" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベース接続管理ハンドラ及びトランザクション制御ハンドラで開始したトランザクションではなく、
個別のトランザクションを使用してデータベースアクセスを行いたい場合がある。</p>
<p>例えば、業務処理が失敗した場合でも必ずデータベースへの変更を確定したい場合には、
現在のトランザクションとは異なるトランザクションを定義してデータベースにアクセスする。</p>
<p>個別トランザクションを使用するには、以下の手順が必要となる。</p>
<ol class="arabic simple">
<li>コンポーネント設定ファイルに <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html" title="nablarch.core.db.transaction.SimpleDbTransactionManager">SimpleDbTransactionManager</a> を定義する。</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html" title="nablarch.core.db.transaction.SimpleDbTransactionManager">SimpleDbTransactionManager</a> をシステムリポジトリから取得し、新たなトランザクションでSQLを実行する。
（システムリポジトリから取得するのではなく、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html" title="nablarch.core.db.transaction.SimpleDbTransactionManager">SimpleDbTransactionManager</a> を設定して使用してもよい)</li>
</ol>
<p>以下に使用例を示す。</p>
<dl class="docutils">
<dt>コンポーネント設定ファイル</dt>
<dd><p class="first">コンポーネント設定ファイルに  <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html" title="nablarch.core.db.transaction.SimpleDbTransactionManager">SimpleDbTransactionManager</a> を定義する。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html#setConnectionFactory-nablarch.core.db.connection.ConnectionFactory-" title="nablarch.core.db.transaction.SimpleDbTransactionManager.setConnectionFactory(nablarch.core.db.connection.ConnectionFactory)">connectionFactory</a> プロパティに <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/ConnectionFactory.html" title="nablarch.core.db.connection.ConnectionFactory">ConnectionFactory</a> 実装クラスを設定する。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/ConnectionFactory.html" title="nablarch.core.db.connection.ConnectionFactory">ConnectionFactory</a> 実装クラスの詳細は、 <a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a> を参照。</li>
<li><dl class="first docutils">
<dt><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html#setTransactionFactory-nablarch.core.transaction.TransactionFactory-" title="nablarch.core.db.transaction.SimpleDbTransactionManager.setTransactionFactory(nablarch.core.transaction.TransactionFactory)">transactionFactory</a> プロパティに <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/transaction/TransactionFactory.html" title="nablarch.core.transaction.TransactionFactory">TransactionFactory</a> 実装クラスを設定する。</dt>
<dd><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/transaction/TransactionFactory.html" title="nablarch.core.transaction.TransactionFactory">TransactionFactory</a> 実装クラスの詳細は、 <a class="reference internal" href="../transaction.html#transaction-database"><span>データベースに対するトランザクション制御を行う</span></a> を参照。</dd>
</dl>
</li>
</ul>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;update-login-failed-count-transaction&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.transaction.SimpleDbTransactionManager&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- connectionFactoryプロパティにConnectionFactory実装クラスを設定する --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;connectionFactory&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- transactionFactoryプロパティにTransactionFactory実装クラスを設定する --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;transactionFactory&quot;</span> <span class="na">ref=</span><span class="s">&quot;transactionFactory&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- トランザクションを識別するための名前を設定する --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dbTransactionName&quot;</span> <span class="na">value=</span><span class="s">&quot;update-login-failed-count-transaction&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>実装例</dt>
<dd><p class="first">コンポーネント設定ファイルに設定した <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html" title="nablarch.core.db.transaction.SimpleDbTransactionManager">SimpleDbTransactionManager</a> を使って、SQLを実行する。
なお、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionManager.html" title="nablarch.core.db.transaction.SimpleDbTransactionManager">SimpleDbTransactionManager</a> を直接使うのではなくトランザクション制御を行う、
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/transaction/SimpleDbTransactionExecutor.html" title="nablarch.core.db.transaction.SimpleDbTransactionExecutor">SimpleDbTransactionExecutor</a> を使用すること。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// システムリポジトリからSimpleDbTransactionManagerを取得する</span>
<span class="n">SimpleDbTransactionManager</span> <span class="n">dbTransactionManager</span> <span class="o">=</span>
    <span class="n">SystemRepository</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;update-login-failed-count-transaction&quot;</span><span class="o">);</span>

<span class="c1">// SimpleDbTransactionManagerをコンストラクタに指定して実行する</span>
<span class="n">SqlResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDbTransactionExecutor</span><span class="o">&lt;</span><span class="n">SqlResultSet</span><span class="o">&gt;(</span><span class="n">dbTransactionManager</span><span class="o">)</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">SqlResultSet</span> <span class="nf">execute</span><span class="o">(</span><span class="n">AppDbConnection</span> <span class="n">connection</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">SqlPStatement</span> <span class="n">statement</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatementBySqlId</span><span class="o">(</span>
        <span class="s">&quot;jp.co.tis.sample.action.SampleAction#findUser&quot;</span><span class="o">);</span>
    <span class="n">statement</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">statement</span><span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}.</span><span class="na">doTransaction</span><span class="o">();</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="database-use-cache">
<span id="id24"></span><h3><a class="toc-backref" href="#id60">7.3.1.3.21. 検索結果をキャッシュする（同じSQLで同じ条件の場合にキャッシュしたデータを扱いたい)</a><a class="headerlink" href="#database-use-cache" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>更新時間が決まっているデータや、頻繁にアクセスされるが必ず最新のデータを返す必要がない場合には、
データベースの負荷を軽減させるために検索結果をキャッシュすることが出来る。</p>
<p>この機能は、以下のような機能で有効に利用できる。</p>
<ul class="simple">
<li>売り上げランキングのように結果が厳密に最新である必要が無く大量に参照されるデータ</li>
<li>データ更新タイミングが夜間のみで日中は更新されないデータ</li>
</ul>
<dl class="docutils">
<dt>制約</dt>
<dd><dl class="first last docutils">
<dt>LOB型について</dt>
<dd><p class="first">LOB(BLOB型やCLOB型)のカラムを取得した場合、実際にDBに格納されたデータが取得されるのではなく、LOBロケータが取得される。
実際の値を取得する場合は、このLOBロケータ経由で値を取得する。</p>
<p class="last">このLOBロケータの有効期間は、RDBMS毎の実装に依存している。
通常、 <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" title="java.sql.ResultSet">java.sql.ResultSet</a> や <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" title="java.sql.Connection">java.sql.Connection</a> がクローズされた時点でアクセスできなくなる。
このため、 <cite>ResultSet</cite> や <cite>Connection</cite> よりも生存期間が長いキャッシュにはBLOB、CLOB型を含めることができない。</p>
</dd>
<dt>アプリケーションの冗長化について</dt>
<dd><p class="first">デフォルトで提供するキャッシュを保持するコンポーネントはJVMのヒープ上にキャッシュを保持する。
このため、アプリケーションを冗長化構成とした場合、アプリケーションごとに検索結果がキャッシュされることになる。</p>
<p>このため、キャッシュタイミングが異なるため、それぞれのアプリケーションで異なるキャッシュを保持する可能性がある。</p>
<p class="last">アプリケーションサーバを冗長化している場合で、ラウンドロビンでロードバランサを行う場合は、
毎回異なるサーバにアクセスする可能性がある。
もし、サーバごとに異なるキャッシュを保持していた場合、リクエストの都度異なる結果が画面表示される可能性があるので注意すること。</p>
</dd>
</dl>
</dd>
</dl>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">この機能は、参照系のデータベースアクセスを省略可能な場合に省略し、システム負荷を軽減することを目的としており、
データベースアクセス（SQL）の高速化を目的としているものではない。
このため、SQLの高速化を目的として使用してはならない。そのような場合には、SQLのチューニングを実施すること。</p>
</div>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">この機能は、データベースの値の更新を監視してキャッシュの最新化を行うことはない。
このため、常に最新のデータを表示する必要がある機能では使用しないこと。</p>
</div>
<p>以下に使用例を示す。</p>
<dl class="docutils">
<dt>コンポーネント設定ファイル</dt>
<dd><p class="first">以下の手順に従い、検索結果のキャッシュを有効化する設定を行う。</p>
<ol class="arabic simple">
<li>クエリ結果をキャッシュするコンポーネントの定義</li>
<li>SQLID毎の検索結果のキャッシュ設定</li>
<li>検索結果をキャッシュするSQL実行コンポーネントの定義</li>
</ol>
<dl class="last docutils">
<dt>クエリ結果のキャッシュクラスのコンポーネントの定義</dt>
<dd><p class="first">デフォルトで提供されるクエリ結果をキャッシュするクラスの <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/cache/InMemoryResultSetCache.html" title="nablarch.core.db.cache.InMemoryResultSetCache">InMemoryResultSetCache</a> を設定する。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;resultSetCache&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.cache.InMemoryResultSetCache&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;cacheSize&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;systemTimeProvider&quot;</span> <span class="na">ref=</span><span class="s">&quot;systemTimeProvider&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>SQLID毎のキャッシュ設定</dt>
<dd><p class="first">SQLID毎のキャッシュ設定を行う。
デフォルトで提供される <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/cache/expirable/BasicExpirationSetting.html" title="nablarch.core.cache.expirable.BasicExpirationSetting">BasicExpirationSetting</a> では、SQLID毎にキャッシュの有効期限が設定できる。</p>
<p>有効期限には、以下の単位が使用できる。</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">ms:</th><td class="field-body">ミリ秒</td>
</tr>
<tr class="field-even field"><th class="field-name">sec:</th><td class="field-body">秒</td>
</tr>
<tr class="field-odd field"><th class="field-name">min:</th><td class="field-body">分</td>
</tr>
<tr class="field-even field"><th class="field-name">h:</th><td class="field-body">時</td>
</tr>
</tbody>
</table>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- キャッシュ有効期限設定 --&gt;</span>
  <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;expirationSetting&quot;</span>
      <span class="na">class=</span><span class="s">&quot;nablarch.core.cache.expirable.BasicExpirationSetting&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;expiration&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;map&gt;</span>
        <span class="c">&lt;!-- keyにSQLIDを設定し、valueに有効期限を設定する --&gt;</span>
        <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;please.change.me.tutorial.ss11AA.W11AA01Action#SELECT&quot;</span> <span class="na">value=</span><span class="s">&quot;100ms&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;please.change.me.tutorial.ss11AA.W11AA02Action#SELECT&quot;</span> <span class="na">value=</span><span class="s">&quot;30sec&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>

  <span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>検索結果をキャッシュするSQL実行コンポーネントの定義</dt>
<dd><p class="first">検索結果をキャッシュさせるためには、SQL実行コンポーネントの生成クラスに <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/cache/statement/CacheableStatementFactory.html" title="nablarch.core.db.cache.statement.CacheableStatementFactory">CacheableStatementFactory</a> を設定する。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/cache/statement/CacheableStatementFactory.html" title="nablarch.core.db.cache.statement.CacheableStatementFactory">CacheableStatementFactory</a> は、 デフォルトで提供される
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html" title="nablarch.core.db.statement.BasicStatementFactory">BasicStatementFactory</a> を継承しているため、
基本的な設定値は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html" title="nablarch.core.db.statement.BasicStatementFactory">BasicStatementFactory</a> と同じである。</p>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/cache/statement/CacheableStatementFactory.html#setExpirationSetting-nablarch.core.cache.expirable.ExpirationSetting-" title="nablarch.core.db.cache.statement.CacheableStatementFactory.setExpirationSetting(nablarch.core.cache.expirable.ExpirationSetting)">expirationSetting</a> 及び
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/cache/statement/CacheableStatementFactory.html#setResultSetCache-nablarch.core.db.cache.ResultSetCache-" title="nablarch.core.db.cache.statement.CacheableStatementFactory.setResultSetCache(nablarch.core.db.cache.ResultSetCache)">resultSetCache</a> プロパティに対しては、上で設定したクエリー結果のキャッシュコンポーネントと
SQLID毎のキャッシュ設定のコンポーネントを設定すること。</p>
<p>ここで定義した <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/cache/statement/CacheableStatementFactory.html" title="nablarch.core.db.cache.statement.CacheableStatementFactory">CacheableStatementFactory</a> コンポーネントは、
<a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a> で定義したデータベース接続を取得するコンポーネントに設定すること。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- キャッシュ可能なステートメントを生成するCacheableStatementFactoryを設定する --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;cacheableStatementFactory&quot;</span>
           <span class="na">class=</span><span class="s">&quot;nablarch.core.db.cache.CacheableStatementFactory&quot;</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- 有効期限設定 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;expirationSetting&quot;</span> <span class="na">ref=</span><span class="s">&quot;expirationSetting&quot;</span><span class="nt">/&gt;</span>
  <span class="c">&lt;!-- キャッシュ実装 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;resultSetCache&quot;</span> <span class="na">ref=</span><span class="s">&quot;resultSetCache&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>実装例</dt>
<dd><p class="first">SQLを使ったデータベースアクセスは、キャッシュ有無によって変わることはない。
以下と同じように実装すれば良い。</p>
<ul class="last simple">
<li><a class="reference internal" href="#database-execute-sqlid"><span>SQLIDを指定してSQLを実行する</span></a></li>
<li><a class="reference internal" href="#database-input-bean"><span>Beanオブジェクトを入力としてSQLを実行する</span></a></li>
</ul>
</dd>
</dl>
</dd>
</dl>
</div>
<div class="section" id="java-sql-connection">
<h3><a class="toc-backref" href="#id61">7.3.1.3.22. <cite>java.sql.Connection</cite> を使って処理を行う</a><a class="headerlink" href="#java-sql-connection" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>JDBCのネイティブなデータベース接続( <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" title="java.sql.Connection">java.sql.Connection</a> )を扱いたい場合がある。
例えば、 <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/DatabaseMetaData.html" title="java.sql.DatabaseMetaData">java.sql.DatabaseMetaData</a> を使用したい場合がこれに該当する。</p>
<p>この場合は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/DbConnectionContext.html" title="nablarch.core.db.connection.DbConnectionContext">DbConnectionContext</a> から取得した
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/TransactionManagerConnection.html" title="nablarch.core.db.connection.TransactionManagerConnection">TransactionManagerConnection</a> から <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" title="java.sql.Connection">java.sql.Connection</a> を取得することで対応できる。</p>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last"><a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" title="java.sql.Connection">java.sql.Connection</a> を使用した場合、チェック例外である <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/SQLException.html" title="java.sql.SQLException">java.sql.SQLException</a> をハンドリングして例外制御を行う必要がある。
この例外制御は実装を誤ると、障害が検知されなかったり障害時の調査ができないなどの問題が発生することがある。
このため、どうしても <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" title="java.sql.Connection">java.sql.Connection</a> を使わないと満たせない要件がない限り、この機能は使用しないこと。</p>
</div>
<p>以下に例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">TransactionManagerConnection</span> <span class="n">managerConnection</span> <span class="o">=</span> <span class="n">DbConnectionContext</span><span class="o">.</span><span class="na">getTransactionManagerConnection</span><span class="o">();</span>
<span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">managerConnection</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
<span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="na">getMetaData</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="database-replace-schema">
<span id="id25"></span><h3><a class="toc-backref" href="#id62">7.3.1.3.23. SQL文中のスキーマを環境毎に切り替える</a><a class="headerlink" href="#database-replace-schema" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>特定のSQL（テーブル）のみ別のスキーマを参照したい場合、通常はSQL文に明示的にスキーマを記述するが
(例: <code class="docutils literal"><span class="pre">SELECT</span> <span class="pre">*</span> <span class="pre">FROM</span> <span class="pre">A_SCHEMA.TABLE1</span></code>)、環境によって参照したいスキーマ名が異なるケースがある（下記の例を参照）。</p>
<p><strong>TABLE1の参照先スキーマ</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="66%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">環境</th>
<th class="head">スキーマ</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>本番環境</td>
<td>A_SCHEMA</td>
</tr>
<tr class="row-odd"><td>テスト環境</td>
<td>B_SCHEMA</td>
</tr>
</tbody>
</table>
<p>このケースでは、SQL文中にスキーマ名を明示的に記述する方法を使うことができない。</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- スキーマ名を指定してSELECT</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">A_SCHEMA</span><span class="p">.</span><span class="n">TABLE1</span>  <span class="c1">-- 本番では動作するがテスト環境では動作しない</span>
</pre></div>
</div>
<p>このような場合のために、SQL文中のスキーマを環境毎に切り替える機能を提供する。</p>
<p>まず、SQL文にスキーマを置き換えるためのプレースホルダー <code class="docutils literal"><span class="pre">#SCHEMA#</span></code> <a class="footnote-reference" href="#schema" id="id26">[2]</a>を記載する。</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- スキーマ名を指定してSELECT</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="o">#</span><span class="k">SCHEMA</span><span class="o">#</span><span class="p">.</span><span class="n">TABLE1</span>
</pre></div>
</div>
<table class="docutils footnote" frame="void" id="schema" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id26">[2]</a></td><td>このプレースホルダーの文字列は固定である。</td></tr>
</tbody>
</table>
<p>プレースホルダーを置き換えるために、以下の例のように<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicSqlLoader.html" title="nablarch.core.db.statement.BasicSqlLoader">BasicSqlLoader</a> を設定する。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;statementFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.BasicStatementFactory&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sqlLoader&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.BasicSqlLoader&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlLoaderCallback&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;list&gt;</span>
        <span class="c">&lt;!-- SQL文中の#SCHEMA#を指定した値で置き換え --&gt;</span>
        <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.sqlloader.SchemaReplacer&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;schemaName&quot;</span> <span class="na">value=</span><span class="s">&quot;${nablarch.schemaReplacer.schemaName}&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/component&gt;</span>
      <span class="nt">&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;/component&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p>プレースホルダーをどのような値に置き換えるかは、
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/sqlloader/SchemaReplacer.html" title="nablarch.core.db.statement.sqlloader.SchemaReplacer">SchemaReplacer</a>
のプロパティ<code class="docutils literal"><span class="pre">schemaName</span></code>に設定する。
上記の例では、置き換え後の値を <code class="docutils literal"><span class="pre">nablarch.schemaReplacer.schemaName</span></code> という環境依存値に設定している。この値を環境毎に切り替えることにより、SQL文中のスキーマをその環境に応じたものに置き換えることができる（切替方法の詳細については <a class="reference internal" href="../../setting_guide/ManagingEnvironmentalConfiguration/index.html#how-to-switch-env-values"><span>環境ごとに環境設定値を切り替える方法</span></a> を参照）。</p>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">本機能によるSQL文中のスキーマ置き換えは単純な文字列置換処理であり、スキーマが存在するか、スキーマ置き換え後のSQLが妥当であるかといったチェックは行われない（SQL文実行時にエラーとなる）。</p>
</div>
</div>
</div>
<div class="section" id="id27">
<h2><a class="toc-backref" href="#id63">7.3.1.4. 拡張例</a><a class="headerlink" href="#id27" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="database-add-connection-factory">
<span id="id28"></span><h3><a class="toc-backref" href="#id64">7.3.1.4.1. データベースへの接続法を追加する</a><a class="headerlink" href="#database-add-connection-factory" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベースの接続方法を追加する手順を説明する。
例えば、OSSのコネクションプールライブラリを使用する場合などは、この手順に従い作業すると良い。</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/ConnectionFactorySupport.html" title="nablarch.core.db.connection.ConnectionFactorySupport">ConnectionFactorySupport</a> を継承し、データベース接続を生成するクラスを作成する。</li>
<li>作成したクラスをコンポーネント設定ファイルに設定する。( <a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a> を参照)</li>
</ol>
</div>
<div class="section" id="database-add-dialect">
<span id="id29"></span><h3><a class="toc-backref" href="#id65">7.3.1.4.2. ダイアレクトを追加する</a><a class="headerlink" href="#database-add-dialect" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ダイアレクトを追加する手順を説明する。</p>
<p>例えば、使用するデータベース製品に対応したダイアレクトがない場合や、特定機能の使用可否を切り替えたい場合にはダイアレクトを追加する必要がある。</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/dialect/DefaultDialect.html" title="nablarch.core.db.dialect.DefaultDialect">DefaultDialect</a> を継承し、 データベース製品に対応したダイアレクトを作成する。</li>
<li>作成したダイアレクトをコンポーネント設定ファイルに設定する ( <a class="reference internal" href="#database-use-dialect"><span>データベース製品に対応したダイアレクトを使用する</span></a> を参照)</li>
</ol>
</div>
<div class="section" id="database-change-exception">
<span id="id30"></span><h3><a class="toc-backref" href="#id66">7.3.1.4.3. データベースアクセス時の例外クラスを切り替える</a><a class="headerlink" href="#database-change-exception" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>データベースアクセス時の例外クラスを切り替える手順を説明する。</p>
<p>例えば、デッドロックエラーの例外クラスを変更したい場合には、この手順に従い作業すると良い。</p>
<ol class="arabic simple">
<li>データベースアクセスエラーを生成する <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/DbAccessExceptionFactory.html" title="nablarch.core.db.connection.DbAccessExceptionFactory">DbAccessExceptionFactory</a> の実装クラスを作成する。</li>
<li>SQL実行時エラーを生成する <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlStatementExceptionFactory.html" title="nablarch.core.db.statement.SqlStatementExceptionFactory">SqlStatementExceptionFactory</a> の実装クラスを作成する。</li>
<li>作成したクラスをコンポーネント設定ファイルに定義する。</li>
</ol>
<p>以下に詳細な手順を示す。</p>
<dl class="docutils">
<dt><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/DbAccessExceptionFactory.html" title="nablarch.core.db.connection.DbAccessExceptionFactory">DbAccessExceptionFactory</a> の実装クラスを作成する</dt>
<dd>データベース接続取得時及びトランザクション制御時(commitやrollback)に発生させる <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/DbAccessException.html" title="nablarch.core.db.DbAccessException">DbAccessException</a> を変更したい場合は、
このインタフェースの実装クラスを作成する。</dd>
<dt><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlStatementExceptionFactory.html" title="nablarch.core.db.statement.SqlStatementExceptionFactory">SqlStatementExceptionFactory</a> の実装クラスを作成する</dt>
<dd>SQL実行時に発生させる <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/exception/SqlStatementException.html" title="nablarch.core.db.statement.exception.SqlStatementException">SqlStatementException</a> を変更したい場合は、 このインタフェースの実装クラスを作成する。</dd>
<dt>コンポーネント設定ファイルに定義する</dt>
<dd><p class="first"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/connection/DbAccessExceptionFactory.html" title="nablarch.core.db.connection.DbAccessExceptionFactory">DbAccessExceptionFactory</a> の実装クラスは、 <a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a>
で定義したデータベース接続を取得するコンポーネントに設定する必要がある。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleDbAccessExceptionFactory&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/SqlStatementExceptionFactory.html" title="nablarch.core.db.statement.SqlStatementExceptionFactory">SqlStatementExceptionFactory</a> の実装クラスは、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html" title="nablarch.core.db.statement.BasicStatementFactory">BasicStatementFactory</a> に対して設定する。
なお、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/db/statement/BasicStatementFactory.html" title="nablarch.core.db.statement.BasicStatementFactory">BasicStatementFactory</a> は、 <a class="reference internal" href="#database-connect"><span>データベースに対する接続設定を行う</span></a> で定義したデータベース接続を取得するコンポーネントに設定する必要がある。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;statementFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.statement.BasicStatementFactory&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sqlStatementExceptionFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleStatementExceptionFactory&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>

    <hr/>

    <div role="contentinfo">
        <p>
            &copy; Copyright 2010-2021, TIS Inc.
        </p>
    </div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'5u20',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../_static/custom.js"></script>
      <script type="text/javascript" src="../../../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>