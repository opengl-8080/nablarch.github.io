


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv='content-language' content='ja'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.7. メール送信 &mdash; ∇Nablarch  5u20 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  

  
  <link rel="canonical" href="https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/mail.html" />
  
    <link rel="top" title="∇Nablarch  5u20 ドキュメント" href="../../../index.html"/>
        <link rel="up" title="7. Nablarchが提供するライブラリ" href="index.html"/>
        <link rel="next" title="7.8. トランザクション管理" href="transaction.html"/>
        <link rel="prev" title="7.6.2. HTTPメッセージング" href="system_messaging/http_system_messaging.html"/>
 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
  
  <a href="../../../index.html" id="sidebar-title" class="icon"> ∇Nablarch 
  

  
    <div id="sidebar-version">Version: 5u20</div>
  </a>

  <div role="search">
    <form id="google-search-form" class="wy-form" method="get" action="https://www.google.co.jp/search">
      <input type="text" name="text" placeholder="Search docs on google" id="text"/>
      <input type="hidden" name="q" id="q"/>
    </form>
  </div>
    
    

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  
  
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_nablarch/index.html">Nablarchについて</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/concept.html">Nablarchのコンセプト</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#robustness">Robustness</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#testability">Testability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#ready-to-use">Ready-to-Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/mvn_module.html">Nablarch のモジュール一覧</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/license.html">Nablarchのライセンスについて</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Nablarchアプリケーションフレームワーク</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">アプリケーションフレームワーク</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../nablarch/index.html">1. Nablarchアプリケーションフレームワークとは</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web/index.html">2. ウェブアプリケーション編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web_service/index.html">3. ウェブサービス編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../batch/index.html">4. バッチアプリケーション編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../messaging/index.html">5. メッセージング編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html">6. Nablarchの提供する標準ハンドラ</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">7. Nablarchが提供するライブラリ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../blank_project/index.html">8. ブランクプロジェクト</a></li>
<li class="toctree-l3"><a class="reference internal" href="../setting_guide/index.html">9. Nablarchアプリケーションフレームワーク設定ガイド</a></li>
<li class="toctree-l3"><a class="reference internal" href="../configuration/index.html">10. デフォルト設定一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cloud_native/index.html">11. Nablarchクラウドネイティブ対応</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adaptors/index.html">アダプタ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/log_adaptor.html">logアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/router_adaptor.html">ルーティングアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/webspheremq_adaptor.html">IBM WebSphere MQアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/jaxrs_adaptor.html">JAX-RSアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/doma_adaptor.html">Domaアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/jsr310_adaptor.html">JSR310(Date and Time API)アダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_freemarker_adaptor.html">E-mail FreeMarkerアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_thymeleaf_adaptor.html">E-mail Thymeleafアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_velocity_adaptor.html">E-mail Velocityアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/web_thymeleaf_adaptor.html">ウェブアプリケーション Thymeleafアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/lettuce_adaptor.html">Lettuceアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/slf4j_adaptor.html">SLF4Jアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/micrometer_adaptor.html">Micrometerアダプタ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../example/index.html">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../example/index.html#id1">環境構築手順について</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example/index.html#id2">アプリケーションの実行手順について</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../extension_components/index.html">Nablarch拡張コンポーネント</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/report/index.html">1. 帳票ライブラリ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#id2">1.1. 概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#id3">1.2. 要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#id7">1.3. 構造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#report-template">1.4. 実装例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html">2. ワークフローライブラリ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#id3">2.1. 機能概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#id6">2.2. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#id7">2.3. 使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#xor">2.4. XORゲートウェイの進行先ノードの判定方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#workflow-multi-completion">2.5. マルチインスタンスの完了条件の判定方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/workflow/tool/index.html">3. ワークフロー定義データ生成ツール</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/tool/index.html#id3">3.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/tool/index.html#id4">3.2. 使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/etl/index.html">4. ETL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id3">4.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#etl-phase">4.2. ETLの各フェーズの仕様</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id5">4.3. ETLを使用するバッチの設計ポイント</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id9">4.4. 使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id18">4.5. 拡張例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/etl/etl_maven_plugin.html">5. ETL Mavenプラグイン</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/etl_maven_plugin.html#id2">5.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/etl_maven_plugin.html#id3">5.2. 使用方法</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../development_tools/index.html">Nablarch開発ツール</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html">1. 効率的なJava静的チェック</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#code-analysis">1.1. 構文チェックを行う</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#code-format">1.2. フォーマットを統一する</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#api">1.3. 許可していないAPIが使用されていないかチェックする</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/ui_dev/index.html">2. フロントエンド上級者向けのUI開発基盤</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/ui_dev/doc/index.html">2.1. Nablarch UI開発基盤 解説書</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/ui_dev/guide/index.html">2.2. JSP/HTML作成ガイド</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/ui_dev/guide/widget_usage/widget_list.html">2.3. UI部品の実装サンプルで提供しているウィジェットの一覧</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/testing_framework/index.html">3. テスティングフレームワーク</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/05_UnitTestGuide/index.html">3.1. 単体テスト実施方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/06_TestFWGuide/index.html">3.2. 自動テストフレームワークの使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/08_TestTools/index.html">3.3. プログラミング工程で使用するツール</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/toolbox/index.html">4. アプリケーション開発時に使える便利なツール</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/JspStaticAnalysis/index.html">4.1. JSP静的解析ツール</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/SqlExecutor/SqlExecutor.html">4.2. Nablarch SQL Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/JspVerifier/JspVerifier.html">4.3. 業務画面JSP検証ツール</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Nablarch実装例集</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/01/index.html">データベースを用いたパスワード認証機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/0101_PBKDF2PasswordEncryptor.html">PBKDF2を用いたパスワード暗号化機能サンプル</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id12">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/02/index.html">バリデーション機能の拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#extendedvalidation-mailaddressvalidator">メールアドレスバリデーション</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#extendedvalidation-japanesetelnumbervalidator">日本電話番号バリデーション</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#id12">コード値精査</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/03/index.html">検索結果の一覧表示</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id5">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id8">使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchinfo">ListSearchInfoクラス</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult">listSearchResultタグ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-sort">検索結果の並び替え</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-nopaging">1画面にすべての検索結果を一覧表示する場合の実装方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-defaultcondition">デフォルトの検索条件で検索した結果を初期表示する場合の実装方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-setting">検索結果の一覧表示機能のデフォルト値設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-customize">業務アプリケーションへのサンプル実装(タグファイル)の取り込み方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-tagreference">タグリファレンス</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/04/index.html">フォーマッタ機能の拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/04/0401_ExtendedDataFormatter.html">データフォーマッタの拡張</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/04/0402_ExtendedFieldType.html">データフォーマッタ機能におけるフィールドタイプの拡張</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/05/index.html">データベースを用いたファイル管理機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id2">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id6">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id7">機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id10">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id15">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/06/index.html">CAPTCHA機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/06_Captcha_guide.html">CAPTCHA機能の組み込み手順</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id21">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/07/index.html">UserAgent情報取得機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id1">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id3">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id8">設定の記述</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id11">使用例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/08/index.html">HTMLメール送信機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id1">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id3">要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id14">実装例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/09/index.html">bouncycastleを使用した電子署名つきメールの送信サンプルの使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id3">環境準備</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id4">電子署名付きメール送信機能の構造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id5">設定ファイルの準備</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id7">実行方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/10/index.html">ログ集計サンプルの使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/10/index.html#id3">提供サンプル一覧</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/11/index.html">メッセージング基盤テストシミュレータサンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id4">用途</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id8">特徴</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id12">要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id15">使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id18">拡張例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../nablarch_api/index.html">Nablarch API</a></li>
</ul>

  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">∇Nablarch </a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Nablarchアプリケーションフレームワーク</a> &raquo;</li>
      
          <li><a href="../index.html">アプリケーションフレームワーク</a> &raquo;</li>
      
          <li><a href="index.html">7. Nablarchが提供するライブラリ</a> &raquo;</li>
      
    <li>7.7. メール送信</li>
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/nablarch" class="fa fa-github">GitHub</a>
    </li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://nablarch.github.io/docs/LATEST/doc/en/index.html" class="en">English</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mail">
<span id="id1"></span><h1>7.7. メール送信<a class="headerlink" href="#mail" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id3" id="id23">機能概要</a><ul>
<li><a class="reference internal" href="#mail-template" id="id24">テンプレートを使った定型メールを送信できる。</a></li>
<li><a class="reference internal" href="#id5" id="id25">キャンペーン通知のような大量メールの一斉送信には対応していない</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id26">モジュール一覧</a></li>
<li><a class="reference internal" href="#id7" id="id27">使用方法</a><ul>
<li><a class="reference internal" href="#mail-settings" id="id28">メール送信を使うための設定を行う</a></li>
<li><a class="reference internal" href="#mail-request" id="id29">メール送信要求を登録する</a></li>
<li><a class="reference internal" href="#mail-send" id="id30">メールを送信する(メール送信バッチを実行する)</a></li>
<li><a class="reference internal" href="#mail-mail-error-process" id="id31">メール送信時のエラー処理</a></li>
<li><a class="reference internal" href="#mail-mail-multi-process" id="id32">メール送信をマルチプロセス化する</a></li>
<li><a class="reference internal" href="#mail-mail-header-injection" id="id33">メールヘッダインジェクション攻撃への対策</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mail-mail-extension-sample" id="id34">拡張例</a><ul>
<li><a class="reference internal" href="#id15" id="id35">電子署名を付加したりメール本文を暗号化するなどメール送信処理を変更する</a></li>
<li><a class="reference internal" href="#id16" id="id36">メール送信に失敗した際の処理を変更する</a></li>
<li><a class="reference internal" href="#id17" id="id37">メール送信要求時に利用するトランザクションを指定する</a></li>
</ul>
</li>
</ul>
</div>
<p>メールを送信する機能を提供する。</p>
<p>この機能では、ディレードオンライン処理と呼ばれる方式を採用しており、
メール送信を即時に行うのではなく、一旦、メール送信要求をデータベースに格納しておき、
<a class="reference internal" href="../batch/nablarch_batch/architecture.html#nablarch-batch-resident-batch"><span>常駐バッチ</span></a> を使い非同期にメール送信を行う。</p>
<a class="reference internal image-reference" href="../../../_images/mail_system.png"><img alt="../../../_images/mail_system.png" src="../../../_images/mail_system.png" /></a>
<p>この方式を採用した理由は以下の通り。</p>
<ul class="simple">
<li>メール送信要求を出すアプリケーションで、メール送信を業務トランザクションに含めることができる。</li>
<li>メールサーバやネットワークの障害により、メール送信が失敗しても、アプリケーションの処理に影響を与えない。</li>
</ul>
<p>この機能では、上記方式を実現するため、2つの機能を提供する。</p>
<ul class="simple">
<li><a class="reference internal" href="#mail-request"><span>メール送信要求をデータベースに登録する機能</span></a></li>
<li><a class="reference internal" href="#mail-send"><span>メール送信要求に基づいてメールを送信するバッチ機能</span></a></li>
</ul>
<p>アプリケーションがメール送信要求を出す毎に1つのメール送信要求を作成し、
メール送信要求1つにつきメールを1通送信する。</p>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">本機能は、即時にメール送信を行うAPIは提供していない。
この場合は、 <a href="https://javamail.java.net/nonav/docs/api/" target="_blank">JavaMail API(外部サイト、英語)</a> を直接使用すること。</p>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id23">7.7.1. 機能概要</a><a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="mail-template">
<span id="id4"></span><h3><a class="toc-backref" href="#id24">7.7.1.1. テンプレートを使った定型メールを送信できる。</a><a class="headerlink" href="#mail-template" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>システムのメール送信では、登録完了通知メールのように、同じ文言で、一部の項目のみ異なるメールを送信することが多い。
そこで、本機能では、テンプレートを用意しておき、プレースホルダを変換して、件名と本文を作成する機能を提供している。
機能の詳細は、 <a class="reference internal" href="#mail-request"><span>メール送信要求を登録する</span></a> を参照。</p>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>Nablarch 5u13からテンプレートエンジンを使用した定型メールがサポートされた。</p>
<p>5u12までの定型メール機能もテンプレートエンジンの1つとして残されており、
<code class="docutils literal"><span class="pre">TinyTemplateEngineMailProcessor</span></code> を設定することで使用可能だが、以下のように機能が限定的である。</p>
<ul class="simple">
<li>プレースホルダを置換できる値は単純な文字列のみで、構造化されたオブジェクトをサポートしていない</li>
<li>条件分岐や繰り返しといった制御構文をサポートしていない</li>
</ul>
<p>既存の定型メール機能の代わりに、より高機能な下記のテンプレートエンジンを使用した定型メール機能を推奨する。</p>
<ul class="last simple">
<li><a class="reference internal" href="../../adaptors/mail_sender_freemarker_adaptor.html#mail-sender-freemarker-adaptor"><span>E-mail FreeMarkerアダプタ</span></a></li>
<li><a class="reference internal" href="../../adaptors/mail_sender_thymeleaf_adaptor.html#mail-sender-thymeleaf-adaptor"><span>E-mail Thymeleafアダプタ</span></a></li>
<li><a class="reference internal" href="../../adaptors/mail_sender_velocity_adaptor.html#mail-sender-velocity-adaptor"><span>E-mail Velocityアダプタ</span></a></li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id25">7.7.1.2. キャンペーン通知のような大量メールの一斉送信には対応していない</a><a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>本機能では、キャンペーン通知のような一斉送信には対応していない。
下記に当てはまる場合は、プロダクトの利用を推奨する。</p>
<ul class="simple">
<li>キャンペーン通知やメールマガジンなど、一括で大量のメールを送信する。</li>
<li>配信したメールの開封率、クリックカウントの効果を測定する。</li>
<li>メールアドレスからクライアント(例えば、フィーチャーフォンか否か)を判別し、送信するメールを切り替える。</li>
</ul>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id26">7.7.2. モジュール一覧</a><a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-mail-sender<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- メール送信要求IDの採番に使用する --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-common-idgenerator<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-common-idgenerator-jdbc<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id27">7.7.3. 使用方法</a><a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="mail-settings">
<span id="id8"></span><h3><a class="toc-backref" href="#id28">7.7.3.1. メール送信を使うための設定を行う</a><a class="headerlink" href="#mail-settings" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>この機能では、データベースを使用してメール送信に使うデータを管理する。
テーブルのレイアウトは以下となる。</p>
<table border="1" class="colwidths-given white-space-normal docutils" id="id18">
<caption><span class="caption-text">メール送信要求</span><a class="headerlink" href="#id18" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col width="24%" />
<col width="18%" />
<col width="58%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>メール送信要求ID <code class="docutils literal"><span class="pre">PK</span></code></td>
<td>文字列型</td>
<td>メール送信要求を一意に識別するID</td>
</tr>
<tr class="row-even"><td>メール送信パターンID（任意項目）</td>
<td>文字列型</td>
<td>メールの送信方法のパターンを識別するためのID。 <br /> パターンを使用した未送信データの抽出をする場合に定義する。（ <a class="reference internal" href="#mail-mail-send-pattern"><span>未送信のデータを抽出する際の条件</span></a> を参照）</td>
</tr>
<tr class="row-odd"><td>メール送信バッチのプロセスID（任意項目）</td>
<td>文字列型</td>
<td>マルチプロセス実行時に各プロセスがレコードを悲観ロックするために使用するカラム。 <br /> マルチプロセス実行する場合に定義する。（ <a class="reference internal" href="#mail-mail-multi-process"><span>メール送信をマルチプロセス化する</span></a> を参照）</td>
</tr>
<tr class="row-even"><td>件名</td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>送信者メールアドレス</td>
<td>文字列型</td>
<td>メールのFromヘッダに指定するメールアドレス</td>
</tr>
<tr class="row-even"><td>返信先メールアドレス</td>
<td>文字列型</td>
<td>メールのReply-Toヘッダに指定するメールアドレス</td>
</tr>
<tr class="row-odd"><td>差戻し先メールアドレス</td>
<td>文字列型</td>
<td>メールのReturn-Pathヘッダに指定するメールアドレス</td>
</tr>
<tr class="row-even"><td>文字セット</td>
<td>文字列型</td>
<td>メールのContent-Typeヘッダに指定する文字セット</td>
</tr>
<tr class="row-odd"><td>ステータス</td>
<td>文字列型</td>
<td>メールの送信状態(未送信／送信済／送信失敗)を表すコード値</td>
</tr>
<tr class="row-even"><td>要求日時</td>
<td>タイムスタンプ型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>送信日時</td>
<td>タイムスタンプ型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>本文</td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given white-space-normal docutils" id="id19">
<caption><span class="caption-text">メール送信先</span><a class="headerlink" href="#id19" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col width="24%" />
<col width="18%" />
<col width="58%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>メール送信要求ID <code class="docutils literal"><span class="pre">PK</span></code></td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>連番 <code class="docutils literal"><span class="pre">PK</span></code></td>
<td>数値型</td>
<td>一つのメール送信要求内の連番</td>
</tr>
<tr class="row-odd"><td>送信先区分</td>
<td>文字列型</td>
<td>メールの送信先区分(TO／CC／BCC)を表すコード値</td>
</tr>
<tr class="row-even"><td>メールアドレス</td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given white-space-normal docutils" id="id20">
<caption><span class="caption-text">メール添付ファイル</span><a class="headerlink" href="#id20" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col width="24%" />
<col width="18%" />
<col width="58%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>メール送信要求ID <code class="docutils literal"><span class="pre">PK</span></code></td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>連番 <code class="docutils literal"><span class="pre">PK</span></code></td>
<td>数値型</td>
<td>一つのメール送信要求内の連番</td>
</tr>
<tr class="row-odd"><td>添付ファイル名</td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>Content-Type</td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>添付ファイル</td>
<td>バイト配列型</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<table border="1" class="colwidths-given white-space-normal docutils" id="id21">
<caption><span class="caption-text">メールテンプレート</span><a class="headerlink" href="#id21" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col width="24%" />
<col width="18%" />
<col width="58%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>メールテンプレートID <code class="docutils literal"><span class="pre">PK</span></code></td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>言語 <code class="docutils literal"><span class="pre">PK</span></code></td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>件名</td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>本文</td>
<td>文字列型</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>文字セット</td>
<td>文字列型</td>
<td>メール送信時に指定する文字セット</td>
</tr>
</tbody>
</table>
<p>メール送信を使うには、以下の設定を行う。</p>
<ul class="simple">
<li><a class="reference internal" href="#mail-common-settings"><span>メール送信要求とメール送信バッチの共通設定</span></a></li>
<li><a class="reference internal" href="#mail-mail-requester-settings"><span>メール送信要求の設定</span></a></li>
<li><a class="reference internal" href="#mail-mail-sender-settings"><span>メール送信バッチの設定</span></a></li>
</ul>
<dl class="docutils" id="mail-common-settings">
<dt>メール送信要求とメール送信バッチの共通設定</dt>
<dd><p class="first">共通設定では、以下の設定を行う。</p>
<ul class="simple">
<li><a class="reference internal" href="#mail-common-settings-table-schema"><span>テーブルスキーマ</span></a></li>
<li><a class="reference internal" href="#mail-common-settings-mail-config"><span>コード値とメッセージ</span></a></li>
</ul>
<dl class="docutils" id="mail-common-settings-table-schema">
<dt>テーブルスキーマ</dt>
<dd><p class="first">次のクラスの設定をコンポーネント定義に追加する。
設定項目の詳細はリンク先のJavadocを参照。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequestTable.html" title="nablarch.common.mail.MailRequestTable">MailRequestTable</a> (メール送信要求テーブル)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRecipientTable.html" title="nablarch.common.mail.MailRecipientTable">MailRecipientTable</a> (メール送信先テーブル)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailAttachedFileTable.html" title="nablarch.common.mail.MailAttachedFileTable">MailAttachedFileTable</a> (添付ファイルテーブル)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailTemplateTable.html" title="nablarch.common.mail.MailTemplateTable">MailTemplateTable</a> (メールテンプレートテーブル)</li>
</ul>
<p>設定例を以下に示す。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- メール送信要求テーブルのスキーマ --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailRequestTable&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailRequestTable&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- テーブル名とカラム名を指定する。ここでは省略する。 --&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- メール送信先テーブルのスキーマ --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailRecipientTable&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailRecipientTable&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- テーブル名とカラム名を指定する。ここでは省略する。 --&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- 添付ファイルテーブルのスキーマ --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailAttachedFileTable&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailAttachedFileTable&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- テーブル名とカラム名を指定する。ここでは省略する。 --&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- メールテンプレートテーブルのスキーマ --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailTemplateTable&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailTemplateTable&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- テーブル名とカラム名を指定する。ここでは省略する。 --&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- 初期化設定 --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;initializer&quot;</span>
           <span class="na">class=</span><span class="s">&quot;nablarch.core.repository.initialization.BasicApplicationInitializer&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;initializeList&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="c">&lt;!-- 他のコンポーネントは省略 --&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;mailRequestTable&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;mailRecipientTable&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;mailAttachedFileTable&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;mailTemplateTable&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">MailRequestTableのmailSendPatternIdColumnNameプロパティ, sendProcessIdColumnNameプロパティは任意項目であり、機能を使用したい場合に設定する。
mailSendPatternIdColumnNameプロパティについては <a class="reference internal" href="#mail-mail-send-pattern"><span>未送信のデータを抽出する際の条件</span></a> を、
sendProcessIdColumnNameプロパティについては <a class="reference internal" href="#mail-mail-multi-process"><span>メール送信をマルチプロセス化する</span></a> を参照すること。</p>
</div>
<dl class="last docutils" id="mail-common-settings-mail-config">
<dt>コード値とメッセージ</dt>
<dd><p class="first">メール送信に使用するコード値、メッセージID、障害コードを設定する。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailConfig.html" title="nablarch.common.mail.MailConfig">MailConfig</a> の設定をコンポーネント定義に追加する。
設定項目の詳細は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailConfig.html" title="nablarch.common.mail.MailConfig">MailConfigのJavadoc</a> を参照。</p>
<p>設定例を以下に示す。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailConfig&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailConfig&quot;</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- メール送信要求IDの採番対象識別ID --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailRequestSbnId&quot;</span> <span class="na">value=</span><span class="s">&quot;MAIL_REQUEST_ID&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- メールの送信先区分(TO／CC／BCC)を表すコード値 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;recipientTypeTO&quot;</span> <span class="na">value=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;recipientTypeCC&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;recipientTypeBCC&quot;</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- メールの送信状態(未送信／送信済／送信失敗)を表すコード値 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusUnsent&quot;</span> <span class="na">value=</span><span class="s">&quot;0&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusSent&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;statusFailure&quot;</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- メール送信要求件数出力時のメッセージID --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailRequestCountMessageId&quot;</span> <span class="na">value=</span><span class="s">&quot;mail.request.count&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- メール送信成功時のメッセージID --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sendSuccessMessageId&quot;</span> <span class="na">value=</span><span class="s">&quot;mail.send.success&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- 送信失敗時の障害コード --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sendFailureCode&quot;</span> <span class="na">value=</span><span class="s">&quot;mail.send.failure&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- 送信失敗時の終了コード --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;abnormalEndExitCode&quot;</span> <span class="na">value=</span><span class="s">&quot;199&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</dd>
</dl>
<dl class="docutils" id="mail-mail-requester-settings">
<dt>メール送信要求の設定</dt>
<dd><p class="first">以下のクラスをコンポーネント定義に追加する。
設定項目の詳細はリンク先のJavadocを参照。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequester.html" title="nablarch.common.mail.MailRequester">MailRequester</a> (メール送信要求をデータベースに登録するコンポーネント)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequestConfig.html" title="nablarch.common.mail.MailRequestConfig">MailRequestConfig</a> (メール送信要求時の設定値を保持するクラス)</li>
</ul>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequester.html" title="nablarch.common.mail.MailRequester">MailRequester</a> は、
メール送信要求をデータベースに登録する際、
<a class="reference internal" href="database/generator.html#generator"><span>採番</span></a> を使ってメール送信要求IDを生成する。
そのため、 <a class="reference internal" href="database/generator.html#generator"><span>採番</span></a> の設定も別途必要となる。</p>
<p>設定例を以下に示す。</p>
<dl class="docutils">
<dt>ポイント</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequester.html" title="nablarch.common.mail.MailRequester">MailRequester</a> は名前でルックアップされるため、
コンポーネント名に <code class="docutils literal"><span class="pre">mailRequester</span></code> と指定する。</li>
</ul>
</dd>
</dl>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- メール送信要求コンポーネント。 --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailRequester&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailRequester&quot;</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- メール送信要求時の設定値(以下のコンポーネント定義を参照) --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailRequestConfig&quot;</span> <span class="na">ref=</span><span class="s">&quot;mailRequestConfig&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- メール送信要求IDの採番に使用するIdGenerator --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailRequestIdGenerator&quot;</span> <span class="na">ref=</span><span class="s">&quot;idGenerator&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- テーブルのスキーマ --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailRequestTable&quot;</span> <span class="na">ref=</span><span class="s">&quot;mailRequestTable&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailRecipientTable&quot;</span> <span class="na">ref=</span><span class="s">&quot;mailRecipientTable&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailAttachedFileTable&quot;</span> <span class="na">ref=</span><span class="s">&quot;mailAttachedFileTable&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;templateEngineMailProcessor&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.TinyTemplateEngineMailProcessor&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailTemplateTable&quot;</span> <span class="na">ref=</span><span class="s">&quot;mailTemplateTable&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/component&gt;</span>
  <span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- メール送信要求時の設定値 --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailRequestConfig&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailRequestConfig&quot;</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- デフォルトの返信先メールアドレス --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultReplyTo&quot;</span> <span class="na">value=</span><span class="s">&quot;default.reply.to@nablarch.sample&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- デフォルトの差戻し先メールアドレス --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultReturnPath&quot;</span> <span class="na">value=</span><span class="s">&quot;default.return.path@nablarch.sample&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- デフォルトの文字セット --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;defaultCharset&quot;</span> <span class="na">value=</span><span class="s">&quot;ISO-2022-JP&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- 最大宛先数 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxRecipientCount&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- 最大添付ファイルサイズ(byte数で記述) --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxAttachedFileSize&quot;</span> <span class="na">value=</span><span class="s">&quot;2097152&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
<p>※説明のため <code class="docutils literal"><span class="pre">TinyTemplateEngineMailProcessor</span></code> を設定しているが限定的な機能しか持たないため、FreeMarkerなどのテンプレートエンジンの使用を推奨する。
詳しくは <a class="reference internal" href="#mail-template"><span>テンプレートを使った定型メールを送信できる。</span></a> を参照。</p>
<dl class="docutils" id="mail-mail-sender-settings">
<dt>メール送信バッチの設定</dt>
<dd><p class="first">メール送信バッチが使用するSMTPサーバーへの接続情報を設定する。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSessionConfig.html" title="nablarch.common.mail.MailSessionConfig">MailSessionConfig</a> をコンポーネント定義に追加する。
設定項目の詳細は、リンク先のJavadocを参照。</p>
<p>設定例を以下に示す。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailSessionConfig&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailSessionConfig&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailSmtpHost&quot;</span> <span class="na">value=</span><span class="s">&quot;localhost&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailHost&quot;</span> <span class="na">value=</span><span class="s">&quot;localhost&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailSmtpPort&quot;</span> <span class="na">value=</span><span class="s">&quot;25&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailSmtpConnectionTimeout&quot;</span> <span class="na">value=</span><span class="s">&quot;100000&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailSmtpTimeout&quot;</span> <span class="na">value=</span><span class="s">&quot;100000&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="mail-request">
<span id="id9"></span><h3><a class="toc-backref" href="#id29">7.7.3.2. メール送信要求を登録する</a><a class="headerlink" href="#mail-request" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>メール送信要求の登録には、以下のクラスを使用する。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequester.html" title="nablarch.common.mail.MailRequester">MailRequester</a> (メール送信要求をデータベースに登録する)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailUtil.html" title="nablarch.common.mail.MailUtil">MailUtil</a> ( <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequester.html" title="nablarch.common.mail.MailRequester">MailRequester</a> を取得する)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/FreeTextMailContext.html" title="nablarch.common.mail.FreeTextMailContext">FreeTextMailContext</a> (非定型メールの送信要求)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/TemplateMailContext.html" title="nablarch.common.mail.TemplateMailContext">TemplateMailContext</a> (定型メールの送信要求)</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/AttachedFile.html" title="nablarch.common.mail.AttachedFile">AttachedFile</a> (添付ファイル)</li>
</ul>
<p>この機能では、フリーフォーマットの非定型メールと、
予め登録しておいたテンプレートを使用する定型メールに対応しており、
それぞれに対応したクラスを使用して、メール送信要求を作成する。</p>
<p>ここでは、定型メールの実装例を以下に示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// メール送信要求を作成する。</span>
<span class="n">TemplateMailContext</span> <span class="n">mailRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TemplateMailContext</span><span class="o">();</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setFrom</span><span class="o">(</span><span class="s">&quot;from@tis.co.jp&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">addTo</span><span class="o">(</span><span class="s">&quot;to@tis.co.jp&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">addCc</span><span class="o">(</span><span class="s">&quot;cc@tis.co.jp&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">addBcc</span><span class="o">(</span><span class="s">&quot;bcc@tis.co.jp&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setSubject</span><span class="o">(</span><span class="s">&quot;件名&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setTemplateId</span><span class="o">(</span><span class="s">&quot;テンプレートID&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setLang</span><span class="o">(</span><span class="s">&quot;ja&quot;</span><span class="o">);</span>

<span class="c1">// テンプレートのプレースホルダに対する値を設定する。</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;名前&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="s">&quot;address&quot;</span><span class="o">,</span> <span class="s">&quot;住所&quot;</span><span class="o">);</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="s">&quot;tel&quot;</span><span class="o">,</span> <span class="s">&quot;電話番号&quot;</span><span class="o">);</span>
<span class="c1">// 以下のように値にnullを設定した場合、空文字列で置き換えが行われる。</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">setVariable</span><span class="o">(</span><span class="s">&quot;opeion&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

<span class="c1">// 添付ファイルを設定する。</span>
<span class="n">AttachedFile</span> <span class="n">attachedFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AttachedFile</span><span class="o">(</span><span class="s">&quot;text/plain&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;path/to/file&quot;</span><span class="o">));</span>
<span class="n">mailRequest</span><span class="o">.</span><span class="na">addAttachedFile</span><span class="o">(</span><span class="n">attachedFile</span><span class="o">);</span>

<span class="c1">// メール送信要求を登録する。</span>
<span class="n">MailRequester</span> <span class="n">requester</span> <span class="o">=</span> <span class="n">MailUtil</span><span class="o">.</span><span class="na">getMailRequester</span><span class="o">();</span>
<span class="n">String</span> <span class="n">mailRequestId</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="na">requestToSend</span><span class="o">(</span><span class="n">mailRequest</span><span class="o">);</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>定型メールで、テンプレートのプレースホルダに対する値を設定する場合は、以下の点に注意する。</p>
<ul class="last simple">
<li>キーに <code class="docutils literal"><span class="pre">null</span></code> を指定した場合は、例外を送出する。</li>
<li>値に <code class="docutils literal"><span class="pre">null</span></code> を指定した場合、空文字列で置き換えを行う。</li>
<li>テンプレートのプレースホルダと、プレースホルダに対して設定されたキー/値の整合性をチェックしない。
そのため、テンプレート中にプレースホルダがあるにも関わらず、値が設定されなかった場合、プレースホルダが変換されずにメールが送信される。
反対に、対応するプレースホルダがない値は、単に無視され、メールが送信される。</li>
</ul>
</div>
</div>
<div class="section" id="mail-send">
<span id="id10"></span><h3><a class="toc-backref" href="#id30">7.7.3.3. メールを送信する(メール送信バッチを実行する)</a><a class="headerlink" href="#mail-send" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>メール送信バッチには、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a> を使用する。
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a> は、 <a class="reference internal" href="../batch/nablarch_batch/architecture.html#nablarch-batch-resident-batch"><span>常駐バッチ</span></a>
を使用して動作させるバッチアクションとして作成している。</p>
<p>メール送信処理では、障害発生時に同一のメールが複数送信されないように、以下のような処理の流れとなっている。
これにより、メール送信成功時にはステータスが確実に送信済みとなっているため、二重送信を防止できる。</p>
<dl class="docutils">
<dt>メール送信の処理の流れ</dt>
<dd><a class="first last reference internal image-reference" href="../../../_images/mail_sender_flow.png"><img alt="../../../_images/mail_sender_flow.png" src="../../../_images/mail_sender_flow.png" /></a>
</dd>
</dl>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">メール送信失敗時に行うステータス更新(送信失敗への変更)で例外(例えばデータベースやネットワーク障害時に発生する)が発生した場合は、ステータスが送信済みのままとなる。
この場合は、該当データに対してパッチを適用(ステータスを送信失敗へ変更する)する必要がある。
なお、例外にはパッチ適用を促すメッセージが付加されている。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">上記図の通りステータスの更新処理は別トランザクションで実行される。
このため、これらの処理で使用するためのトランザクション設定が必要となる。
このトランザクションのコンポーネント名は <code class="docutils literal"><span class="pre">statusUpdateTransaction</span></code> としてコンポーネント設定ファイルに登録する必要がある。
詳細は、 <a class="reference internal" href="database/database.html#database-new-transaction"><span>現在のトランザクションとは異なるトランザクションでSQLを実行する</span></a> を参照。</p>
</div>
<p>以下に実行例を示す。
実行方法の詳細については、 <a class="reference internal" href="../handlers/standalone/main.html#main-run-application"><span>アプリケーションを起動する</span></a> を参照。</p>
<dl class="docutils">
<dt>ポイント</dt>
<dd><ul class="first last simple">
<li>requestPathオプションで <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a> を指定する。</li>
</ul>
</dd>
</dl>
<div class="highlight-bash"><div class="highlight"><pre><span></span>java nablarch.fw.launcher.Main <span class="se">\</span>
  -diConfig file:./mail-batch-config.xml <span class="se">\</span>
  -requestPath nablarch.common.mail.MailSender/SENDMAIL00 <span class="se">\</span>
  -userId mailBatchUser
</pre></div>
</div>
<dl class="docutils" id="mail-mail-send-pattern">
<dt>未送信のデータを抽出する際の条件</dt>
<dd><p class="first"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a> は、
メール送信要求テーブルから未送信のデータを抽出し、メール送信を行う。
未送信のデータを抽出する際の条件は、次の2つから選択可能となっている。</p>
<blockquote>
<div><ul class="simple">
<li>テーブル全体から未送信のデータを抽出する</li>
<li>メール送信パターンID毎に未送信のデータを抽出する</li>
</ul>
</div></blockquote>
<p>メール送信パターンIDを使うケースとしては、
例えば、送信までの時間をできるだけ短くしたい優先度が高いメールと、
1時間に1回程度の間隔で送信すればよい優先度の低いメールを扱うようなシステムが考えられる。</p>
<p>メール送信パターンID毎に未送信のデータを抽出する場合には、
監視対象のメール送信パターンID毎にメール送信バッチのプロセスを起動する。
そのため、プロセス起動時には、処理対象のメール送信パターンID(mailSendPatternId)を起動引数に指定する。</p>
<p>以下に実行例を示す。</p>
<dl class="docutils">
<dt>ポイント</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">mailSendPatternId</span></code> という名前のオプションでメール送信パターンIDを指定する。</li>
</ul>
</dd>
</dl>
<div class="last highlight-bash"><div class="highlight"><pre><span></span>java nablarch.fw.launcher.Main <span class="se">\</span>
  -diConfig file:./mail-batch-config.xml <span class="se">\</span>
  -requestPath nablarch.common.mail.MailSender/SENDMAIL00 <span class="se">\</span>
  -userId mailBatchUser
  -mailSendPatternId <span class="m">02</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="mail-mail-error-process">
<span id="id11"></span><h3><a class="toc-backref" href="#id31">7.7.3.4. メール送信時のエラー処理</a><a class="headerlink" href="#mail-mail-error-process" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a> は、外部からの入力データ(アドレスやヘッダー)に起因する例外やメール送信失敗の例外が発生した場合、
対象のメール送信要求のステータスを送信失敗にして次のメール送信処理を行う。
また、上記以外の例外が発生した場合は、メール送信要求のステータスを送信失敗にしてリトライする。</p>
<p>以下の表に例外の種類とそのエラー処理を示す。</p>
<blockquote>
<div><table border="1" class="white-space-normal docutils" id="id22">
<caption><span class="caption-text">メール送信時の例外と処理</span><a class="headerlink" href="#id22" title="このテーブルへのパーマリンク">¶</a></caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">例外</th>
<th class="head">処理</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>送信要求のメールアドレス変換時の <a class="reference external" href="https://javamail.java.net/nonav/docs/api/javax/mail/internet/AddressException.html">JavaMailのAddressException</a></td>
<td>変換に失敗したアドレスをログ出力(ログレベル: ERROR)する。</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#mail-mail-header-injection"><span>メールヘッダインジェクション攻撃への対策</span></a> での <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/InvalidCharacterException.html" title="nablarch.common.mail.InvalidCharacterException">InvalidCharacterException</a></td>
<td>ヘッダー文字列をログ出力(ログレベル: ERROR)する。</td>
</tr>
<tr class="row-even"><td>メール送信失敗時の <a class="reference external" href="https://javamail.java.net/nonav/docs/api/javax/mail/SendFailedException.html">JavaMailのSendFailureException</a></td>
<td>送信されたアドレス、送信されなかったアドレス、不正なアドレスをログ出力(ログレベル: ERROR)する。</td>
</tr>
<tr class="row-odd"><td>上記以外のメール送信時の <a class="reference external" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Exception.html" title="java.lang.Exception">Exception</a></td>
<td>例外をラップしてリトライ例外を送出する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>なお、ステータスの送信失敗への更新に失敗した場合、または、リトライ上限に達した場合、メール送信バッチは異常終了する。</p>
<blockquote>
<div><div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">送信失敗の検知は、別プロセスでログファイルをチェックするなどして対応する必要がある。</p>
</div>
</div></blockquote>
<p>ログ出力の処理を変更したい場合や、リトライの処理を変更したい場合は、 <a class="reference internal" href="#mail-mail-extension-sample"><span>拡張例</span></a> を参照すること。</p>
</div>
<div class="section" id="mail-mail-multi-process">
<span id="id12"></span><h3><a class="toc-backref" href="#id32">7.7.3.5. メール送信をマルチプロセス化する</a><a class="headerlink" href="#mail-mail-multi-process" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>メール送信をマルチプロセス化する場合（例えば冗長構成のサーバで実行する場合）、
メール送信要求テーブルのプロセスIDカラムを使用して悲観ロックを行い、複数のプロセスが同一の送信要求を処理しないようにする。
この機能を利用するには、 次の設定が必要となる。</p>
<blockquote>
<div><ol class="arabic simple">
<li>メール送信要求テーブルにメール送信バッチのプロセスIDのカラムを定義する</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequestTable.html" title="nablarch.common.mail.MailRequestTable">MailRequestTable</a> のsendProcessIdColumnNameのプロパティの値にメール送信バッチのプロセスIDのカラム名を設定し、コンポーネント定義に追加する</li>
<li>メール送信バッチのプロセスID更新用のトランザクションを <code class="docutils literal"><span class="pre">mailMultiProcessTransaction</span></code> の名前でコンポーネント定義に追加する(トランザクションの設定方法は <a class="reference internal" href="database/database.html#database-new-transaction"><span>現在のトランザクションとは異なるトランザクションでSQLを実行する</span></a> を参照)</li>
</ol>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">2. の設定がされていない場合、排他制御がされないため１件のメール送信要求を複数プロセスが処理する可能性がある。
しかし、見かけ上メール送信バッチが動作するため、設定漏れを検知しづらい。
メール送信をマルチプロセス化する場合は上記の設定を漏れなく行うこと。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="mail-mail-header-injection">
<span id="id13"></span><h3><a class="toc-backref" href="#id33">7.7.3.6. メールヘッダインジェクション攻撃への対策</a><a class="headerlink" href="#mail-mail-header-injection" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>メールヘッダインジェクション攻撃への根本的対策として、以下の対策を実施する必要がある。</p>
<ul class="simple">
<li>メールヘッダは固定値を使用する。外部からの入力値を使用しない。</li>
<li>プログラミング言語の標準APIを使用してメール送信を行う。Javaの場合は <a href="https://javamail.java.net/nonav/docs/api/" target="_blank">JavaMail API(外部サイト、英語)</a> を使用する。</li>
</ul>
<dl class="docutils">
<dt>メールヘッダは固定値を使用する。外部からの入力値を使用しない。</dt>
<dd>これについては、プロジェクトで対応する。
固定値にできない場合は、改行コードを変換するか、取り除く対応をプロジェクトで行う。</dd>
<dt>プログラミング言語の標準APIを使用してメール送信を行う。Javaの場合は <a href="https://javamail.java.net/nonav/docs/api/" target="_blank">JavaMail API(外部サイト、英語)</a> を使用する。</dt>
<dd><p class="first">本機能では <a href="https://javamail.java.net/nonav/docs/api/" target="_blank">JavaMail API(外部サイト、英語)</a> を利用している。
しかし、 <a href="https://javamail.java.net/nonav/docs/api/" target="_blank">JavaMail API(外部サイト、英語)</a> を利用しても、一部のメールヘッダの項目に改行コードが含まれていてもメール送信可能な項目がある。
そのため、保険的対策として、これらの項目に対して改行コードが含まれている場合にはメール送信を実施しないチェック機能を設けている。
改行コードが含まれていた場合には、
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/InvalidCharacterException.html" title="nablarch.common.mail.InvalidCharacterException">InvalidCharacterException</a>
の送出およびログ出力(ログレベル: ERROR)を行い、該当のメールは送信処理を失敗として扱うこととする。</p>
<p>この保険的対策は、脆弱性となる可能性のある以下の項目を対象としている。</p>
<ul class="last simple">
<li>件名</li>
<li>差し戻し先メールアドレス</li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="mail-mail-extension-sample">
<span id="id14"></span><h2><a class="toc-backref" href="#id34">7.7.4. 拡張例</a><a class="headerlink" href="#mail-mail-extension-sample" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id35">7.7.4.1. 電子署名を付加したりメール本文を暗号化するなどメール送信処理を変更する</a><a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a> は、
メール送信要求やテンプレートで指定された内容をそのまま送信する。
アプリケーション要件によっては、電子署名を付加したりメール本文を暗号化する必要が出てくる。</p>
<p>そのような場合は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a>
を継承したクラスをプロジェクトで作成して対応する。
詳細は、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSenderのJavadoc</a> を参照。</p>
</div>
<div class="section" id="id16">
<h3><a class="toc-backref" href="#id36">7.7.4.2. メール送信に失敗した際の処理を変更する</a><a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>メール送信に失敗した際のエラー処理(詳細は <a class="reference internal" href="#mail-mail-error-process"><span>メール送信時のエラー処理</span></a> を参照)を、例えば、ログレベルを変更したり、
リトライ対象の例外を変更するなど、アプリケーションの要件によって変更したい場合がある。</p>
<p>そのような場合は、上の例と同様、<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailSender.html" title="nablarch.common.mail.MailSender">MailSender</a> を継承したクラスを作成して対応する。</p>
</div>
<div class="section" id="id17">
<h3><a class="toc-backref" href="#id37">7.7.4.3. メール送信要求時に利用するトランザクションを指定する</a><a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>業務アプリケーションが失敗してもメール送信要求を確実に行いたい場合など、
メール送信要求 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/mail/MailRequester.html" title="nablarch.common.mail.MailRequester">MailRequester</a> とメール送信要求IDの <a class="reference internal" href="database/generator.html#generator"><span>採番</span></a>
で実行されるトランザクションを、業務アプリケーションのトランザクションとは独立して指定したい場合がある。</p>
<p>その場合の設定例を以下に示す。</p>
<blockquote>
<div><dl class="docutils">
<dt>ポイント</dt>
<dd><ul class="first last simple">
<li>トランザクションマネージャとメール送信要求IDの採番で指定するトランザクション名を同じにする。</li>
</ul>
</dd>
</dl>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- メール送信要求コンポーネント --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailRequester&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.mail.MailRequester&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- メール送信に用いるトランザクションを指定 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;mailTransactionManager&quot;</span> <span class="na">ref=</span><span class="s">&quot;txManager&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- トランザクションマネージャ  --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;txManager&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.db.transaction.SimpleDbTransactionManager&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dbTransactionName&quot;</span> <span class="na">value=</span><span class="s">&quot;mail-transaction&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- メール送信要求IDジェネレータ --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;mailRequestIdGenerator&quot;</span>
    <span class="na">class=</span><span class="s">&quot;nablarch.common.idgenerator.TableIdGenerator&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- トランザクションマネージャで指定したトランザクション名を指定 --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;dbTransactionName&quot;</span> <span class="na">value=</span><span class="s">&quot;mail-transaction&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>

    <hr/>

    <div role="contentinfo">
        <p>
            &copy; Copyright 2010-2021, TIS Inc.
        </p>
    </div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'5u20',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/custom.js"></script>
      <script type="text/javascript" src="../../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>