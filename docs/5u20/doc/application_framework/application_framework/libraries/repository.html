


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv='content-language' content='ja'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.2. システムリポジトリ &mdash; ∇Nablarch  5u20 ドキュメント</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  

  
  <link rel="canonical" href="https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/repository.html" />
  
    <link rel="top" title="∇Nablarch  5u20 ドキュメント" href="../../../index.html"/>
        <link rel="up" title="7. Nablarchが提供するライブラリ" href="index.html"/>
        <link rel="next" title="7.3. データベースアクセス" href="database_management.html"/>
        <link rel="prev" title="7.1.1.2.5. メッセージングログの出力" href="log/messaging_log.html"/>
 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
  
  <a href="../../../index.html" id="sidebar-title" class="icon"> ∇Nablarch 
  

  
    <div id="sidebar-version">Version: 5u20</div>
  </a>

  <div role="search">
    <form id="google-search-form" class="wy-form" method="get" action="https://www.google.co.jp/search">
      <input type="text" name="text" placeholder="Search docs on google" id="text"/>
      <input type="hidden" name="q" id="q"/>
    </form>
  </div>
    
    

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  
  
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_nablarch/index.html">Nablarchについて</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/concept.html">Nablarchのコンセプト</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#robustness">Robustness</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#testability">Testability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#ready-to-use">Ready-to-Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/mvn_module.html">Nablarch のモジュール一覧</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/license.html">Nablarchのライセンスについて</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Nablarchアプリケーションフレームワーク</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">アプリケーションフレームワーク</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../nablarch/index.html">1. Nablarchアプリケーションフレームワークとは</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web/index.html">2. ウェブアプリケーション編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web_service/index.html">3. ウェブサービス編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../batch/index.html">4. バッチアプリケーション編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../messaging/index.html">5. メッセージング編</a></li>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html">6. Nablarchの提供する標準ハンドラ</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">7. Nablarchが提供するライブラリ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../blank_project/index.html">8. ブランクプロジェクト</a></li>
<li class="toctree-l3"><a class="reference internal" href="../setting_guide/index.html">9. Nablarchアプリケーションフレームワーク設定ガイド</a></li>
<li class="toctree-l3"><a class="reference internal" href="../configuration/index.html">10. デフォルト設定一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cloud_native/index.html">11. Nablarchクラウドネイティブ対応</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adaptors/index.html">アダプタ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/log_adaptor.html">logアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/router_adaptor.html">ルーティングアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/webspheremq_adaptor.html">IBM WebSphere MQアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/jaxrs_adaptor.html">JAX-RSアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/doma_adaptor.html">Domaアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/jsr310_adaptor.html">JSR310(Date and Time API)アダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_freemarker_adaptor.html">E-mail FreeMarkerアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_thymeleaf_adaptor.html">E-mail Thymeleafアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_velocity_adaptor.html">E-mail Velocityアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/web_thymeleaf_adaptor.html">ウェブアプリケーション Thymeleafアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/lettuce_adaptor.html">Lettuceアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/slf4j_adaptor.html">SLF4Jアダプタ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/micrometer_adaptor.html">Micrometerアダプタ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../example/index.html">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../example/index.html#id1">環境構築手順について</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example/index.html#id2">アプリケーションの実行手順について</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../extension_components/index.html">Nablarch拡張コンポーネント</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/report/index.html">1. 帳票ライブラリ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#id2">1.1. 概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#id3">1.2. 要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#id7">1.3. 構造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/report/index.html#report-template">1.4. 実装例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html">2. ワークフローライブラリ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#id3">2.1. 機能概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#id6">2.2. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#id7">2.3. 使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#xor">2.4. XORゲートウェイの進行先ノードの判定方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html#workflow-multi-completion">2.5. マルチインスタンスの完了条件の判定方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/workflow/tool/index.html">3. ワークフロー定義データ生成ツール</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/tool/index.html#id3">3.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/workflow/tool/index.html#id4">3.2. 使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/etl/index.html">4. ETL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id3">4.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#etl-phase">4.2. ETLの各フェーズの仕様</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id5">4.3. ETLを使用するバッチの設計ポイント</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id9">4.4. 使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/index.html#id18">4.5. 拡張例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/etl/etl_maven_plugin.html">5. ETL Mavenプラグイン</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/etl_maven_plugin.html#id2">5.1. モジュール一覧</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../extension_components/etl/etl_maven_plugin.html#id3">5.2. 使用方法</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../development_tools/index.html">Nablarch開発ツール</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html">1. 効率的なJava静的チェック</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#code-analysis">1.1. 構文チェックを行う</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#code-format">1.2. フォーマットを統一する</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#api">1.3. 許可していないAPIが使用されていないかチェックする</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/ui_dev/index.html">2. フロントエンド上級者向けのUI開発基盤</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/ui_dev/doc/index.html">2.1. Nablarch UI開発基盤 解説書</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/ui_dev/guide/index.html">2.2. JSP/HTML作成ガイド</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/ui_dev/guide/widget_usage/widget_list.html">2.3. UI部品の実装サンプルで提供しているウィジェットの一覧</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/testing_framework/index.html">3. テスティングフレームワーク</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/05_UnitTestGuide/index.html">3.1. 単体テスト実施方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/06_TestFWGuide/index.html">3.2. 自動テストフレームワークの使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/08_TestTools/index.html">3.3. プログラミング工程で使用するツール</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/toolbox/index.html">4. アプリケーション開発時に使える便利なツール</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/JspStaticAnalysis/index.html">4.1. JSP静的解析ツール</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/SqlExecutor/SqlExecutor.html">4.2. Nablarch SQL Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/JspVerifier/JspVerifier.html">4.3. 業務画面JSP検証ツール</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Nablarch実装例集</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/01/index.html">データベースを用いたパスワード認証機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/0101_PBKDF2PasswordEncryptor.html">PBKDF2を用いたパスワード暗号化機能サンプル</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#id12">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/02/index.html">バリデーション機能の拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#extendedvalidation-mailaddressvalidator">メールアドレスバリデーション</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#extendedvalidation-japanesetelnumbervalidator">日本電話番号バリデーション</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#id12">コード値精査</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/03/index.html">検索結果の一覧表示</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id5">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#id8">使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchinfo">ListSearchInfoクラス</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult">listSearchResultタグ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-sort">検索結果の並び替え</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-nopaging">1画面にすべての検索結果を一覧表示する場合の実装方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-defaultcondition">デフォルトの検索条件で検索した結果を初期表示する場合の実装方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-setting">検索結果の一覧表示機能のデフォルト値設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-customize">業務アプリケーションへのサンプル実装(タグファイル)の取り込み方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-tagreference">タグリファレンス</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/04/index.html">フォーマッタ機能の拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/04/0401_ExtendedDataFormatter.html">データフォーマッタの拡張</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/04/0402_ExtendedFieldType.html">データフォーマッタ機能におけるフィールドタイプの拡張</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/05/index.html">データベースを用いたファイル管理機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id2">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id6">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id7">機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id10">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#id15">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/06/index.html">CAPTCHA機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/06_Captcha_guide.html">CAPTCHA機能の組み込み手順</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id3">提供パッケージ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id4">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#id21">使用方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/07/index.html">UserAgent情報取得機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id1">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id3">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id8">設定の記述</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#id11">使用例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/08/index.html">HTMLメール送信機能サンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id1">概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id3">要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id6">構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#id14">実装例</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/09/index.html">bouncycastleを使用した電子署名つきメールの送信サンプルの使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id3">環境準備</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id4">電子署名付きメール送信機能の構造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id5">設定ファイルの準備</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#id7">実行方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/10/index.html">ログ集計サンプルの使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/10/index.html#id3">提供サンプル一覧</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/11/index.html">メッセージング基盤テストシミュレータサンプル</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id4">用途</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id8">特徴</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id12">要求</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id15">使用方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#id18">拡張例</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../nablarch_api/index.html">Nablarch API</a></li>
</ul>

  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">∇Nablarch </a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Nablarchアプリケーションフレームワーク</a> &raquo;</li>
      
          <li><a href="../index.html">アプリケーションフレームワーク</a> &raquo;</li>
      
          <li><a href="index.html">7. Nablarchが提供するライブラリ</a> &raquo;</li>
      
    <li>7.2. システムリポジトリ</li>
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/nablarch" class="fa fa-github">GitHub</a>
    </li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://nablarch.github.io/docs/LATEST/doc/en/index.html" class="en">English</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="repository">
<span id="id1"></span><h1>7.2. システムリポジトリ<a class="headerlink" href="#repository" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#id3" id="id23">機能概要</a><ul>
<li><a class="reference internal" href="#di" id="id24">DIコンテナによるオブジェクトの構築ができる</a></li>
<li><a class="reference internal" href="#id4" id="id25">オブジェクトの初期化ができる</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5" id="id26">モジュール一覧</a></li>
<li><a class="reference internal" href="#id6" id="id27">使用方法</a><ul>
<li><a class="reference internal" href="#xml" id="id28">xmlにルートノードを定義する</a></li>
<li><a class="reference internal" href="#java-beans" id="id29">Java Beansオブジェクトを設定する</a></li>
<li><a class="reference internal" href="#repository-override-bean" id="id30">Java Beansオブジェクトの設定を上書きする</a></li>
<li><a class="reference internal" href="#repository-property-type" id="id31">文字列や数値、真偽値を設定値として使う</a></li>
<li><a class="reference internal" href="#listmap" id="id32">ListやMapを設定値として使う</a></li>
<li><a class="reference internal" href="#repository-autowired" id="id33">コンポーネントを自動的にインジェクションする</a></li>
<li><a class="reference internal" href="#repository-split-xml" id="id34">コンポーネント設定ファイル(xml)を分割する</a></li>
<li><a class="reference internal" href="#repository-environment-configuration" id="id35">依存値を設定する</a></li>
<li><a class="reference internal" href="#repository-user-environment-configuration" id="id36">コンポーネント設定ファイルから環境依存値を参照する</a></li>
<li><a class="reference internal" href="#repository-overwrite-environment-configuration" id="id37">システムプロパティを使って環境依存値を上書きする</a></li>
<li><a class="reference internal" href="#os" id="id38">OS環境変数を使って環境依存値を上書きする</a></li>
<li><a class="reference internal" href="#repository-factory-injection" id="id39">ファクトリクラスで生成したオブジェクトをインジェクションする</a></li>
<li><a class="reference internal" href="#repository-inject-annotation-component" id="id40">アノテーションを付与したクラスのオブジェクトを構築する</a><ul>
<li><a class="reference internal" href="#id16" id="id41">使用方法</a></li>
<li><a class="reference internal" href="#id17" id="id42">コンストラクタインジェクションを使用する</a></li>
<li><a class="reference internal" href="#actiondi" id="id43">ActionクラスをDIコンテナで管理する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#repository-initialize-object" id="id44">オブジェクトの初期化処理を行う</a></li>
<li><a class="reference internal" href="#repository-dispose-object" id="id45">オブジェクトの廃棄処理を行う</a></li>
<li><a class="reference internal" href="#repository-use-system-repository" id="id46">DIコンテナの情報をシステムリポジトリに設定する</a></li>
<li><a class="reference internal" href="#repository-get-object" id="id47">システムリポジトリからオブジェクトを取得する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#repository-environment-configuration-file-rule" id="id48">環境設定ファイルの記述ルール</a></li>
</ul>
</div>
<p>アプリケーションを実装する際に様々な箇所で使用されるオブジェクトや、設定値などを管理する機能を提供する。</p>
<p>この機能では、以下の事ができる。</p>
<ul class="simple">
<li>環境毎に異なる可能性のあるロジック(生成されるクラスやプロパティの値)を、 外部ファイルに定義できる。</li>
<li>外部ファイルの定義を元に、オブジェクト間の関連を構築できる。(DIコンテナ機能を持つ)</li>
</ul>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id23">7.2.1. 機能概要</a><a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="di">
<h3><a class="toc-backref" href="#id24">7.2.1.1. DIコンテナによるオブジェクトの構築ができる</a><a class="headerlink" href="#di" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>DIコンテナ機能を使うことで、 <a class="reference internal" href="#repository-root-node"><span>xml</span></a> に定義されたコンポーネントの定義または
<a class="reference internal" href="#repository-inject-annotation-component"><span>アノテーションを付与したクラス</span></a> を元にオブジェクトを構築できる。
構築されるオブジェクトは <strong>シングルトン</strong> となる。</p>
<p>DIコンテナ機能では、以下のことができる。</p>
<ul class="simple">
<li><a class="reference internal" href="#repository-definition-bean"><span>setterインジェクションができる。</span></a></li>
<li><a class="reference internal" href="#repository-property-type"><span>文字列や数値、真偽値を使用できる。</span></a></li>
<li><a class="reference internal" href="#repository-map-list"><span>ListやMapをインジェクションできる。</span></a></li>
<li><a class="reference internal" href="#repository-autowired"><span>型や名前が一致するsetterへの自動インジェクションができる。</span></a></li>
<li><a class="reference internal" href="#repository-factory-injection"><span>ファクトリインジェクションができる。</span></a></li>
<li><a class="reference internal" href="#repository-inject-annotation-component"><span>アノテーションを付与したクラスのオブジェクトが構築できる。</span></a></li>
<li><a class="reference internal" href="#repository-environment-configuration"><span>環境依存値を管理できる。</span></a></li>
</ul>
<p>アプリケーションからはDIコンテナに直接アクセスするのではなく、システムリポジトリ経由でアクセスする。
詳細は、 <a class="reference internal" href="#repository-use-system-repository"><span>DIコンテナの情報をシステムリポジトリに設定する</span></a> を参照。</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id25">7.2.1.2. オブジェクトの初期化ができる</a><a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>オブジェクト構築後に任意の初期化処理を実行できる。</p>
<p>オブジェクトの依存関係によっては、初期化順に制約が発生することが考えられるため、
この機能ではオブジェクトの初期化順が指定できる。</p>
<p>詳細は、 <a class="reference internal" href="#repository-initialize-object"><span>オブジェクトの初期化処理を行う</span></a> を参照。</p>
</div>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id26">7.2.2. モジュール一覧</a><a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-core<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-core-repository<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id27">7.2.3. 使用方法</a><a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="xml">
<span id="repository-root-node"></span><h3><a class="toc-backref" href="#id28">7.2.3.1. xmlにルートノードを定義する</a><a class="headerlink" href="#xml" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>コンポーネント設定ファイル(xml)のルートノードは、 <cite>component-configuration</cite> とする。
<cite>schemaLocation</cite> を正しく設定すると、IDEで各要素や属性のドキュメントが参照できたり、補完機能が有効活用できる。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component-configuration</span> <span class="na">xmlns=</span><span class="s">&quot;http://tis.co.jp/nablarch/component-configuration&quot;</span>
   <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://tis.co.jp/nablarch/component-configuration /component-configuration.xsd&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;/component-configuration&gt;</span>
</pre></div>
</div>
<p>xmlへのコンポーネント定義方法の詳細は、以下を参照。</p>
<ul class="simple">
<li><a class="reference internal" href="#repository-definition-bean"><span>Java Beansオブジェクトを設定する</span></a></li>
<li><a class="reference internal" href="#repository-override-bean"><span>Java Beansオブジェクトの設定を上書きする</span></a></li>
<li><a class="reference internal" href="#repository-property-type"><span>文字列や数値、真偽値を設定値として使う</span></a></li>
<li><a class="reference internal" href="#repository-map-list"><span>ListやMapを設定値として使う</span></a></li>
<li><a class="reference internal" href="#repository-autowired"><span>コンポーネントを自動的にインジェクションする</span></a></li>
<li><a class="reference internal" href="#repository-environment-configuration"><span>依存値を設定する</span></a></li>
<li><a class="reference internal" href="#repository-user-environment-configuration"><span>コンポーネント設定ファイルから環境依存値を参照する</span></a></li>
<li><a class="reference internal" href="#repository-factory-injection"><span>ファクトリクラスで生成したオブジェクトをインジェクションする</span></a></li>
<li><a class="reference internal" href="#repository-initialize-object"><span>オブジェクトの初期化処理を行う</span></a></li>
<li><a class="reference internal" href="#repository-split-xml"><span>コンポーネント設定ファイル(xml)を分割する</span></a></li>
</ul>
</div>
<div class="section" id="java-beans">
<span id="repository-definition-bean"></span><h3><a class="toc-backref" href="#id29">7.2.3.2. Java Beansオブジェクトを設定する</a><a class="headerlink" href="#java-beans" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Java Beansオブジェクトは、component要素を用いて定義する。</p>
<ul class="simple">
<li>class属性にDIコンテナで管理するクラスのFQCNを設定する。</li>
<li>name属性を使って任意の名前を設定できる。</li>
<li>property子要素を使って、setterインジェクションができる。</li>
<li>propertyの子要素にcomponentを定義できる。</li>
<li>propertyのref属性を使って、他で定義したcomponentをsetterインジェクションできる。</li>
</ul>
<p>以下に例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- component要素を使ってJava Beansオブジェクトを設定する --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sample&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;component&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!--</span>
<span class="c">   property要素を使ってsetterインジェクションを行う</span>
<span class="c">   この例では、sampleという名前でcomponent定義されたオブジェクトがインジェクションされる</span>
<span class="c">   --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sample&quot;</span> <span class="na">ref=</span><span class="s">&quot;sample&quot;</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- ref属性を使わずに、propertyの子要素にcomponentを定義することもできる --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;obj&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleObject&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/property&gt;</span>

  <span class="c">&lt;!-- リテラル値をsetterインジェクションする --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;limit&quot;</span> <span class="na">value=</span><span class="s">&quot;100&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;component/&gt;</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>生成されるインスタンスはシングルトンとなる。このため、以下の点に注意すること。</p>
<ul class="simple">
<li>インスタンスはシングルトンとなるため、取得の度に生成されるのではない（プロトタイプでない）。</li>
<li>アプリケーションが終了するまでインスタンスは破棄されない。</li>
</ul>
<p>この理解を誤ると、深刻な不具合を埋め込むこととなるので特に注意が必要である。
例えば、生成されるインスタンスをプロトタイプと勘違いした場合、あるリクエストでユーザAの入力値をコンポーネントに設定し、
別のユーザBのリクエストでその値を使用してしまう、というような重大な不具合を起こす可能性がある。</p>
<p class="last">意図的にアプリケーション全体でコンポーネントの状態を変更、共有する場合は、そのコンポーネントはスレッドセーフでなければならない。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>オブジェクトはcomponent要素単位にインスタンスが生成される。例えば、以下のように2箇所でcomponentを定義した場合別々のインスタンスが生成される。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- SampleBeanのインスタンスが2つリポジトリに登録される --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sample1&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sample2&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">ネストして定義したcomponentについても、リポジトリ上はグローバル領域に保持されるため、名前を指定してオブジェクトを取得できる。
オブジェクトの取得方法は、 <a class="reference internal" href="#repository-get-object"><span>システムリポジトリからオブジェクトを取得する</span></a> を参照。</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p class="last">staticなプロパティ(staticなsetterメソッド)に対するインジェクションは行われない。
インジェクション対象となるプロパティがstaticであった場合には、DIコンテナの構築時に例外が送出される。</p>
</div>
</div>
<div class="section" id="repository-override-bean">
<span id="id7"></span><h3><a class="toc-backref" href="#id30">7.2.3.3. Java Beansオブジェクトの設定を上書きする</a><a class="headerlink" href="#repository-override-bean" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>componentタグのname属性が同じオブジェクトを登録することで、前に読み込まれたオブジェクトの設定を上書きできる。
この機能は、テスト時にプロダクション環境用のオブジェクトをテスト用のオブジェクト(モック)に置き換える際に利用できる。</p>
<p>オブジェクトを上書きする場合は、同じ名前のオブジェクトを登録するだけで自動的に後で読み込まれたオブジェクトが優先される。</p>
<p>以下に例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sample&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;prop&quot;</span> <span class="na">value=</span><span class="s">&quot;message&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- 同じ名前でコンポーネントを定義して上書きする --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sample&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.MockSampleBean&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>上の例のように異なるクラスを設定すると、上書き前のpropertyへの設定は全て破棄される。
これは、同じインタフェースを実装していても、同じpropertyを持っているとは限らないためである。</p>
<p>ただし、同じクラスを設定した場合、上書き前のpropertyへの設定が上書き後のクラスに全て引き継がれる。
このため、上書き後の設定で特定propertyへの設定を削除することはできない。
例えば、以下の様な上書き設定をした場合、上書き後の設定にはproperty要素は存在していないが、
上書き前のpropの値が引き継がれるため、propにはmessageが設定された状態となる。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sample&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;prop&quot;</span> <span class="na">value=</span><span class="s">&quot;message&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!--</span>
<span class="c">propertyを設定していないが、上書き前のpropの値が引き継がれる</span>
<span class="c"> --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sample&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="repository-property-type">
<span id="id8"></span><h3><a class="toc-backref" href="#id31">7.2.3.4. 文字列や数値、真偽値を設定値として使う</a><a class="headerlink" href="#repository-property-type" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>プロパティの型が以下の型の場合、リテラル表記で値を簡易的に設定できる。</p>
<ul class="simple">
<li>java.lang.String</li>
<li>java.lang.String[]</li>
<li>java.lang.Integer(int)</li>
<li>java.lang.Integer[](int[])</li>
<li>java.lang.Long(long)</li>
<li>java.lang.Boolean(boolean)</li>
</ul>
<p>以下に設定例を示す。</p>
<dl class="docutils">
<dt>java.lang.String</dt>
<dd><p class="first">java.lang.String型に値を設定する場合、value属性にリテラルで設定する値を記述する。</p>
<p>この例では、strプロパティに対して「あいうえお」が設定される。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;str&quot;</span> <span class="na">value=</span><span class="s">&quot;あいうえお&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</dd>
<dt>java.lang.String[]</dt>
<dd><p class="first">java.lang.String[]型に値を設定する場合、value属性に値をカンマ(,)区切りで設定する。
カンマで区切られた値が、配列の1つの要素となる。</p>
<p>この例では、arrayプロパティに対して「[あ, い, う, え, お]」が設定される。
なお、区切り文字である <code class="docutils literal"><span class="pre">,</span></code> を要素として設定することはできない。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;array&quot;</span> <span class="na">value=</span><span class="s">&quot;あ,い,う,え,お&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</dd>
<dt>java.lang.Integer(int)</dt>
<dd><p class="first">java.lang.Integer型及びint型に値を設定する場合、value属性に設定する値を記述する。
設定できる値は、 <cite>Integer#valueOf</cite> により変換できる値。</p>
<p>この例では、Integer(int)型のnumプロパティに対して「12345」が設定される。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;num&quot;</span> <span class="na">value=</span><span class="s">&quot;12345&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</dd>
<dt>java.lang.Integer[](int[])</dt>
<dd>java.lang.String[]と同じように、value属性に値をカンマ(,)区切りで設定する。
各要素に設定できる値は、 <cite>Integer#valueOf</cite> により変換できる値。</dd>
<dt>java.lang.Long(long)</dt>
<dd>java.lang.Integer(int)と同じように、value属性に設定する値を記述する。
設定できる値は、 <cite>Long#valueOf</cite> により変換できる値。</dd>
<dt>java.lang.Boolean(boolean)</dt>
<dd><p class="first">java.lang.Boolean型に値を設定する場合、value属性にリテラルで設定する値を記述する。
設定できる値は、 <cite>Boolean#valueOf</cite> により変換できる値。</p>
<p>この例では、Boolean(boolean)型のboolプロパティに対して「true」が設定される。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;bool&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="listmap">
<span id="repository-map-list"></span><h3><a class="toc-backref" href="#id32">7.2.3.5. ListやMapを設定値として使う</a><a class="headerlink" href="#listmap" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>list要素やmap要素を使ってコンポーネント設定をすることで、ListやMapを受け取るpropertyに対するsetterインジェクションが行える。</p>
<dl class="docutils">
<dt>list要素を使ったListの設定</dt>
<dd><p class="first">list要素には、文字列または任意のJava Beansオブジェクトを設定することができる。</p>
<p>この例では、SampleBeanのstringListプロパティに対して、[string1, string2, string3]を持つ文字列のListが設定される。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;stringList&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="nt">&lt;value&gt;</span>string1<span class="nt">&lt;/value&gt;</span>
      <span class="nt">&lt;value&gt;</span>string2<span class="nt">&lt;/value&gt;</span>
      <span class="nt">&lt;value&gt;</span>string3<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p>list要素にも任意の名前を設定でき、property要素で名前参照することができる。
この例は、上の例と同じ設定となる。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;list</span> <span class="na">name=</span><span class="s">&quot;strList&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;value&gt;</span>string1<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;value&gt;</span>string2<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;value&gt;</span>string3<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/list&gt;</span>

<span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.ListSample&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- strListという名前のListを設定する --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;stringList&quot;</span> <span class="na">ref=</span><span class="s">&quot;strList&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p>この例では、handlersプロパティに対して、 <cite>SampleHandler1</cite> 、 <cite>SampleHandler2</cite> 、 <cite>SampleHandler3</cite> を持つJava BeansオブジェクトのListが設定される。
なお、下の例にもあるがcomponent-ref要素を使用することで、名前参照することができる。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleHandler3&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleHandler3&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.ListSample&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;handlers&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleHandler1&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleHandler2&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;sampleHandler3&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>map要素を使ったMapの設定</dt>
<dd><p class="first">この例では、mapプロパティに対してentryに「{key1=1, key2=2, key3=3}」を持つMapが設定される。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;map&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;key1&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;key2&quot;</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;key3&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/map&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</pre></div>
</div>
<p>mapにも任意の名前を設定でき、property要素で名前参照することができる。
この例は、上の例と同じ設定となる。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>  <span class="nt">&lt;map</span> <span class="na">name=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;key1&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;key2&quot;</span> <span class="na">value=</span><span class="s">&quot;2&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;key3&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/map&gt;</span>

<span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.ListSample&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- mapという名前のMapを設定する --&gt;</span>
<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;map&quot;</span> <span class="na">ref=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p>value-component要素を使用することで、任意のBeanをMapの値として設定することもできる。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;settings&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;map&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;sample1&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;value-component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean1&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entry&gt;</span>
    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;sample2&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;value-component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean2&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/entry&gt;</span>
  <span class="nt">&lt;/map&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</pre></div>
</div>
</dd>
</dl>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>mapやlistのname属性が同じものを複数定義した場合は、先に定義されたものが有効となる。
これは、 <a class="reference internal" href="#repository-override-bean"><span>beanの上書き</span></a> と異なる挙動であるため注意すること。</p>
<p class="last">もし、環境毎にmapやlistの情報を変更したい場合には、環境毎読み込むファイルを変えることで対応すること。</p>
</div>
</div>
<div class="section" id="repository-autowired">
<span id="id9"></span><h3><a class="toc-backref" href="#id33">7.2.3.6. コンポーネントを自動的にインジェクションする</a><a class="headerlink" href="#repository-autowired" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>コンポーネントのpropertyタグの定義を省略した場合でも、自動的にコンポーネントをインジェクションする機能を提供する。
この機能ではcomponent要素のautowireType属性を使用することで、自動インジェクションタイプを指定することができる。</p>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>自動インジェクション機能を使用すると以下の問題があるため、autowireType属性には明示的に <cite>None</cite> を指定することを推奨する。</p>
<ul class="last simple">
<li>最終的に生成されるオブジェクトの状態が、コンポーネント設定ファイル(xml)から読み取れない。</li>
<li>任意項目のプロパティ定義を省略した場合に、想定していないオブジェクトが自動的にインジェクションされてしまう可能性がある。</li>
<li>型による自動インジェクションを使用し、派生開発で同一の型のオブジェクトの設定が増えた場合、
propertyの定義が必要になるためメンテナンス性が悪い。</li>
</ul>
</div>
<p>autowireType属性に指定可能なタイプは以下の通り。</p>
<dl class="docutils">
<dt>ByType</dt>
<dd>DIコンテナ上にそのプロパティの型が1つしか存在しない場合に、そのコンポーネントを自動的にインジェクションする。
デフォルトではこのタイプが使用される。</dd>
<dt>ByName</dt>
<dd>プロパティ名と一致する名称のコンポーネントが存在する場合に、そのコンポーネントを自動的にインジェクションする。
なお、プロパティとコンポーネントの型が一致しない場合はエラーとなる。</dd>
<dt>None</dt>
<dd>自動インジェクションを行わない。</dd>
</dl>
<p>デフォルト(ByType)の設定で自動インジェクションする例を以下に示す。</p>
<dl class="docutils">
<dt>インジェクション対象のクラスを作成する</dt>
<dd><p class="first">インジェクション対象のインタフェース及び実装クラスを作成する。
この例では、インタフェースを作成しているが、インタフェースの作成は必須ではない。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SampleComponent</span> <span class="o">{</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BasicSampleComponent</span> <span class="kd">implements</span> <span class="n">SampleComponent</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>インジェクション対象のオブジェクトを使用するクラスを作成する</dt>
<dd><p class="first">上記で作成したクラスを使って処理を行うクラスを作成する。
このクラスは、setterインジェクションで上記のクラスを受け取る。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleClient</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">SampleComponent</span> <span class="n">component</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSampleComponent</span><span class="o">(</span><span class="n">SampleComponent</span> <span class="n">component</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">component</span> <span class="o">=</span> <span class="n">component</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>コンポーネント設定ファイルにコンポーネントを定義する</dt>
<dd><p class="first">この例では、 <cite>SampleClient</cite> に <cite>sampleComponent</cite> propertyを定義していないが、<cite>SampleComponent</cite>を実装したクラスの設定が1つだけなので、
<cite>sampleComponent</cite> propertyには自動的に <cite>BasicSampleComponent</cite> が設定される。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.BasicSampleComponent&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleClient&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleClient&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>上記の設定は、以下のように明示的にpropertyを定義した場合と同じ動作となる。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.BasicSampleComponent&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleClient&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleClient&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="na">ref=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="repository-split-xml">
<span id="id10"></span><h3><a class="toc-backref" href="#id34">7.2.3.7. コンポーネント設定ファイル(xml)を分割する</a><a class="headerlink" href="#repository-split-xml" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>全ての定義を1つのコンポーネント設定ファイルに定義するとxmlが巨大となり、メンテナンス性が悪くなる問題がある。
このため、xmlファイルを複数ファイルに分割できる機能を提供している。</p>
<p>xmlファイルを分割する際には、機能単位などある程度の粒度でファイルを分割すると良い。
分割したxmlファイルは、import要素で読み込む事ができる。</p>
<p>以下に例を示す。</p>
<p>この例では、3つのxmlファイルがロードされる。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;import</span> <span class="na">file=</span><span class="s">&quot;library/database.xml&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;import</span> <span class="na">file=</span><span class="s">&quot;library/validation.xml&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;import</span> <span class="na">file=</span><span class="s">&quot;handler/multipart.xml&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="repository-environment-configuration">
<span id="id11"></span><h3><a class="toc-backref" href="#id35">7.2.3.8. 依存値を設定する</a><a class="headerlink" href="#repository-environment-configuration" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>テスト環境や本番環境で異なる値(データベースの接続情報やディレクトリのパスなど)は、環境設定ファイルで管理できる。</p>
<p>環境設定ファイルは、以下のようにシンプルなkey-value形式で記述する。
詳細な記述ルールは、 <a class="reference internal" href="#repository-environment-configuration-file-rule"><span>環境設定ファイルの記述ルール</span></a> を参照。</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>database.url <span class="o">=</span> jdbc:h2:mem:sample
database.user <span class="o">=</span> sa
database.password <span class="o">=</span> sa
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">環境設定値のキー値が重複していた場合、後に定義されたものが有効となるため注意すること。</p>
</div>
<p>以下に例を示す。</p>
<dl class="docutils">
<dt>環境依存値</dt>
<dd><div class="first last highlight-bash"><div class="highlight"><pre><span></span>database.url <span class="o">=</span> jdbc:h2:mem:sample
database.user <span class="o">=</span> sa
database.password <span class="o">=</span> sa
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="repository-user-environment-configuration">
<span id="id12"></span><h3><a class="toc-backref" href="#id36">7.2.3.9. コンポーネント設定ファイルから環境依存値を参照する</a><a class="headerlink" href="#repository-user-environment-configuration" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>コンポーネント設定ファイル(xml)から環境設定ファイルを読み込み、Java Beansオブジェクトの設定値として使用できる。</p>
<p>DIコンテナで管理するオブジェクトに対して環境依存値を設定(インジェクション)する場合は、
コンポーネント設定ファイルに環境依存値のキー値を <code class="docutils literal"><span class="pre">${</span></code> と <code class="docutils literal"><span class="pre">}</span></code> で囲んで記述する。</p>
<p>なお、この記法を環境設定ファイルで使用することはできない。(環境設定ファイル内では、他の環境依存値は参照できない。)</p>
<p>以下に例を示す。</p>
<dl class="docutils">
<dt>環境設定ファイル</dt>
<dd><div class="first last highlight-bash"><div class="highlight"><pre><span></span>database.url <span class="o">=</span> jdbc:h2:mem:sample
database.user <span class="o">=</span> sa
database.password <span class="o">=</span> sa
</pre></div>
</div>
</dd>
<dt>コンポーネント設定ファイル</dt>
<dd><p class="first">環境設定ファイルを読み込む場合には、config-file要素を使用する。
この例のようにファイル名指定で読み込んだり、特定ディレクトリ配下のファイルを一括で読み込むことができる。</p>
<p>上記の環境設定ファイルの名前が「database.properties」の場合、 <cite>JdbcDataSource</cite> の <cite>url</cite> には、「jdbc:h2:mem:sample」が設定される。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- database.propertiesファイルの読み込み --&gt;</span>
<span class="nt">&lt;config-file</span> <span class="na">file=</span><span class="s">&quot;database.properties&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;org.h2.jdbcx.JdbcDataSource&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;url&quot;</span> <span class="na">value=</span><span class="s">&quot;${database.url}&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p>環境設定ファイルにはconfigファイルとpropertiesファイルの二種類があり、configファイルはnablarchの独自仕様によりパースされ、
propertiesファイルはjava.util.Propertiesによりパースされる。configファイルはnablarchの独自仕様であることから
環境設定ファイルにはpropertiesファイルを推奨する。</p>
<p class="last">環境設定ファイルの仕様は、 <a class="reference internal" href="#repository-environment-configuration-file-rule"><span>環境設定ファイルの記述ルール</span></a> を参照。</p>
</dd>
</dl>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last">環境設定ファイルで定義されていない環境依存値のキーをコンポーネント設定ファイルに記載した場合、ConfigurationLoadExceptionが送出される。</p>
</div>
</div>
<div class="section" id="repository-overwrite-environment-configuration">
<span id="id13"></span><h3><a class="toc-backref" href="#id37">7.2.3.10. システムプロパティを使って環境依存値を上書きする</a><a class="headerlink" href="#repository-overwrite-environment-configuration" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>環境依存値は、システムプロパティ( <cite>java.lang.System#getProperties()</cite> で取得できる値)で上書きできる。
システムプロパティは、環境設定ファイルに設定した値より優先されるため、vmオプションで容易に設定値を上書きすることができる。</p>
<p>例えば、特定のバッチアプリケーションだけ設定値を変えたいといった場合に、システムプロパティを使用して環境依存値を上書きするといったことができる。</p>
<p>以下に例を示す。</p>
<p>環境設定ファイル</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">message</span><span class="o">=</span>上書きされるメッセージ
</pre></div>
</div>
</div></blockquote>
<dl class="docutils">
<dt>システムプロパティで値を上書きする</dt>
<dd><p class="first">javaコマンドの <code class="docutils literal"><span class="pre">-D</span></code> オプションでシステムプロパティを設定することで、環境設定ファイルの値を上書きすることができる。
この例の場合、 <cite>message</cite> の値は「上書きするメッセージ」となる。</p>
<p class="last">java -Dmessage=上書きするメッセージ</p>
</dd>
</dl>
</div>
<div class="section" id="os">
<span id="repository-overwrite-environment-configuration-by-os-env-var"></span><h3><a class="toc-backref" href="#id38">7.2.3.11. OS環境変数を使って環境依存値を上書きする</a><a class="headerlink" href="#os" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下で説明する設定を行うことで、環境依存値をOS環境変数で上書きできるようになる。</p>
<dl class="docutils">
<dt>OS環境変数による上書きを有効にするための設定方法</dt>
<dd><p class="first">環境依存値を上書きする仕組みは、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/ExternalizedComponentDefinitionLoader.html" title="nablarch.core.repository.di.config.externalize.ExternalizedComponentDefinitionLoader">ExternalizedComponentDefinitionLoader</a> インタフェースを実装したクラスによって実現されている。</p>
<p>この実装クラスは、 <code class="docutils literal"><span class="pre">java.util.ServiceLoader</span></code> を使ってロードされる。
サービスプロバイダを何も設定していない場合は、デフォルトで <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/SystemPropertyExternalizedLoader.html" title="nablarch.core.repository.di.config.externalize.SystemPropertyExternalizedLoader">SystemPropertyExternalizedLoader</a> が使用される。
このクラスはシステムプロパティで上書きを行うクラスとなっており、前節で説明したシステムプロパティによる上書きはこのクラスによって実現されている。</p>
<p>OS環境変数で環境依存値を上書きする場合は、実装クラスとして <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/OsEnvironmentVariableExternalizedLoader.html" title="nablarch.core.repository.di.config.externalize.OsEnvironmentVariableExternalizedLoader">OsEnvironmentVariableExternalizedLoader</a> を使用する。</p>
<p>具体的な設定は、次のようにして行う。</p>
<ol class="arabic simple">
<li>クラスパス直下に <code class="docutils literal"><span class="pre">META-INF/services</span></code> というディレクトリを作成する</li>
<li>上で作成したディレクトリの中に、 <code class="docutils literal"><span class="pre">nablarch.core.repository.di.config.externalize.ExternalizedComponentDefinitionLoader</span></code> という名前のテキストファイルを作成する</li>
<li>ファイルの中に、使用する実装クラスの完全修飾名を改行区切りで列挙する</li>
</ol>
<p>例えば、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/OsEnvironmentVariableExternalizedLoader.html" title="nablarch.core.repository.di.config.externalize.OsEnvironmentVariableExternalizedLoader">OsEnvironmentVariableExternalizedLoader</a> を使用する場合は、 <code class="docutils literal"><span class="pre">nablarch.core.repository.di.config.externalize.ExternalizedComponentDefinitionLoader</span></code> の中身を以下のように記述する。</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>nablarch.core.repository.di.config.externalize.OsEnvironmentVariableExternalizedLoader
</pre></div>
</div>
<p>複数の実装クラスを組み合わせる場合は、以下のように改行区切りで列挙することもできる。</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>nablarch.core.repository.di.config.externalize.OsEnvironmentVariableExternalizedLoader
nablarch.core.repository.di.config.externalize.SystemPropertyExternalizedLoader
</pre></div>
</div>
<p class="last">複数の実装クラスを指定した場合は、上から順番に上書きが行われる。
したがって、同じ名前の環境依存値をそれぞれの方法で上書きした場合は、一番下に記述したクラスによる上書きが最終的に採用されることになる。
上記例の場合は、OS環境変数で設定した値よりもシステムプロパティで設定した値の方が優先されることになる。</p>
</dd>
</dl>
<dl class="docutils" id="repository-overwrite-environment-configuration-by-os-env-var-naming-rule">
<dt>OS環境変数の名前について</dt>
<dd><p class="first">Linuxでは、OS環境変数の名前に <code class="docutils literal"><span class="pre">.</span></code> や <code class="docutils literal"><span class="pre">-</span></code> を使用できない。
したがって、 <code class="docutils literal"><span class="pre">example.error-message</span></code> のような名前の環境依存値があった場合に、これを上書きするためのOS環境変数をそのままの名前で定義することはできない。</p>
<p>Nablarchではこの問題を回避するために、環境依存値の名前に以下の変換を行ったうえでOS環境変数を検索するようにしている。</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">.</span></code> と <code class="docutils literal"><span class="pre">-</span></code> を <code class="docutils literal"><span class="pre">_</span></code> に置換する</li>
<li>アルファベットを大文字に変換する</li>
</ol>
<p>つまり、 <code class="docutils literal"><span class="pre">example.error-message</span></code> という名前の環境依存値は、 <code class="docutils literal"><span class="pre">EXAMPLE_ERROR_MESSAGE</span></code> という名前でOS環境変数を定義することで上書きできる。</p>
<p class="last">Windows ではOS環境変数に <code class="docutils literal"><span class="pre">.</span></code> や <code class="docutils literal"><span class="pre">-</span></code> を使用できるが、上記変換処理は実行時のOSに関係なく行っている。
したがって、 <code class="docutils literal"><span class="pre">example.error-message</span></code> を上書きするためのOS環境変数は、Windowsでも <code class="docutils literal"><span class="pre">EXAMPLE_ERROR_MESSAGE</span></code> という名前で定義しなければならない。</p>
</dd>
</dl>
</div>
<div class="section" id="repository-factory-injection">
<span id="id14"></span><h3><a class="toc-backref" href="#id39">7.2.3.12. ファクトリクラスで生成したオブジェクトをインジェクションする</a><a class="headerlink" href="#repository-factory-injection" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Java Beansとして実装されているクラスであれば、setterインジェクションを使用して値を設定しオブジェクトを生成することができる。
しかし、ベンダー提供やOSSなどのJava Beansとして実装されていないオブジェクトをシステムリポジトリで管理したい場合がある。</p>
<p>この場合は、ファクトリクラスを作成しファクトリクラス経由でオブジェクトを生成することで、これらのクラスをシステムリポジトリで管理できるようになる。</p>
<p>以下に手順を示す。</p>
<dl class="docutils">
<dt>ファクトリクラスを作成する</dt>
<dd><p class="first">ファクトリクラスは、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/ComponentFactory.html" title="nablarch.core.repository.di.ComponentFactory">ComponentFactory</a> インタフェースを実装し作成する。</p>
<dl class="last docutils">
<dt>実装例</dt>
<dd><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleComponentFactory</span> <span class="kd">implements</span> <span class="n">ComponentFactory</span><span class="o">&lt;</span><span class="n">SampleComponent</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// 生成するオブジェクトへの設定値</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">configValue</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setConfigValue</span><span class="o">(</span><span class="n">String</span> <span class="n">configValue</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">configValue</span> <span class="o">=</span> <span class="n">configValue</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">SampleComponent</span> <span class="nf">createObject</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// オブジェクトを生成する。</span>
    <span class="c1">// この例では、このクラスにsetterインジェクションした値を使ってオブジェクトを生成する。</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">SampleComponent</span><span class="o">(</span><span class="n">configValue</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
</dd>
<dt>コンポーネント設定ファイルにファクトリクラスを設定する</dt>
<dd><p class="first">ファクトリクラスを通常のコンポーネントと同じように設定することで、
自動的にファクトリクラスが生成したオブジェクトが設定される。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- ファクトリクラスの定義 --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponentFactory&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configValue&quot;</span> <span class="na">value=</span><span class="s">&quot;設定値&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="c">&lt;!-- ファクトリクラスで生成したオブジェクトを設定するクラス --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.SampleBean&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- sampleObjectプロパティにファクトリクラスで生成したオブジェクトが設定される --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;sampleObject&quot;</span> <span class="na">ref=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>Nablarchではファクトリクラスの入れ子に対応していない。
つまり、ファクトリクラスのプロパティに他のファクトリクラスを指定できない。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponentFactory&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ファクトリクラスの入れ子 --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;property&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;sample.OtherSampleComponentFactory&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p class="last">この場合は、1つのファクトリクラス内で入れ子のファクトリクラスで構築するオブジェクトも含めてオブジェクトを構築するか、
入れ子のファクトリクラスで構築するオブジェクトを生成するCreator/Builder/Providerといったクラスを作成し、
コンポーネントとしてインジェクションすることで対応すること。</p>
</div>
</div>
<div class="section" id="repository-inject-annotation-component">
<span id="id15"></span><h3><a class="toc-backref" href="#id40">7.2.3.13. アノテーションを付与したクラスのオブジェクトを構築する</a><a class="headerlink" href="#repository-inject-annotation-component" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/SystemRepositoryComponent.html" title="nablarch.core.repository.di.config.externalize.annotation.SystemRepositoryComponent">SystemRepositoryComponent</a> を
クラスに付与することで、 <a class="reference internal" href="#repository-definition-bean"><span>XMLに設定</span></a> を書かなくともDIコンテナの管理対象とすることができる。</p>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>本機能は、クラスパス配下のリソースを独自のファイルシステムで管理している一部のウェブアプリケーションサーバーでは使用できない。</p>
<p>例えば、JbossやWildflyでは、vfsと呼ばれるバーチャルファイルシステムで
クラスパス配下のリソースが管理されるため、 <code class="docutils literal"><span class="pre">SystemRepositoryComponent</span></code> アノテーションで注釈されたクラスの検索ができない。</p>
<p class="last">そのようなウェブアプリケーションサーバーを使用する場合は、コンポーネントの定義は従来通り <a class="reference internal" href="#repository-definition-bean"><span>XMLに定義</span></a> すること。</p>
</div>
<div class="section" id="id16">
<h4><a class="toc-backref" href="#id41">7.2.3.13.1. 使用方法</a><a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h4>
<dl class="docutils">
<dt>収集対象のパッケージを特定するクラスを作成する。</dt>
<dd><p class="first"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/SystemRepositoryComponent.html" title="nablarch.core.repository.di.config.externalize.annotation.SystemRepositoryComponent">SystemRepositoryComponent</a> が付与された
クラスの収集は <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/ExternalizedComponentDefinitionLoader.html" title="nablarch.core.repository.di.config.externalize.ExternalizedComponentDefinitionLoader">ExternalizedComponentDefinitionLoader</a> インタフェースを実装したクラスで行っている。
このクラスは <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/AnnotationComponentDefinitionLoader.html" title="nablarch.core.repository.di.config.externalize.AnnotationComponentDefinitionLoader">AnnotationComponentDefinitionLoader</a> という抽象クラスで、収集対象の基点となるパッケージを返す
<a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/AnnotationComponentDefinitionLoader.html#getBasePackage--" title="nablarch.core.repository.di.config.externalize.AnnotationComponentDefinitionLoader.getBasePackage()">getBasePackage</a> という抽象メソッドを持っている。</p>
<p>各プロジェクトのパッケージ名に合わせて収集が行われるよう上記の抽象メソッドをオーバーライドする。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleComponentDefinitionLoader</span> <span class="kd">extends</span> <span class="n">AnnotationComponentDefinitionLoader</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getBasePackage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;com.example&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>作成したクラスをサービスプロバイダとして設定する。</dt>
<dd><code class="docutils literal"><span class="pre">java.util.ServiceLoader</span></code> でロードされるよう <a class="reference internal" href="#repository-overwrite-environment-configuration-by-os-env-var"><span>OS環境変数による上書きを有効にするための設定方法</span></a> と同様
<code class="docutils literal"><span class="pre">nablarch.core.repository.di.config.externalize.ExternalizedComponentDefinitionLoader</span></code> というファイルを作成し上記のクラスの完全修飾名を記述する。</dd>
<dt>DIコンテナで管理したいクラスにアノテーションを付与する。</dt>
<dd><p class="first"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/SystemRepositoryComponent.html" title="nablarch.core.repository.di.config.externalize.annotation.SystemRepositoryComponent">SystemRepositoryComponent</a> を付与することでDIコンテナで管理される。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@SystemRepositoryComponent</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleAction</span> <span class="o">{</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="id17">
<h4><a class="toc-backref" href="#id42">7.2.3.13.2. コンストラクタインジェクションを使用する</a><a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/SystemRepositoryComponent.html" title="nablarch.core.repository.di.config.externalize.annotation.SystemRepositoryComponent">SystemRepositoryComponent</a> が付与されたクラスは構築時に以下の条件を満たすことでコンストラクタインジェクションが実行される。</p>
<ul class="simple">
<li>コンストラクタが1つだけ定義されている</li>
<li>コンストラクタが引数をもつ</li>
</ul>
<p>条件を満たす場合、以下の仕様でインジェクションされる。</p>
<ul class="simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/ConfigValue.html" title="nablarch.core.repository.di.config.externalize.annotation.ConfigValue">ConfigValue</a> が付与されている引数には設定値がインジェクションされる</li>
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/ComponentRef.html" title="nablarch.core.repository.di.config.externalize.annotation.ComponentRef">ComponentRef</a> が付与されている引数にはDIコンテナに登録されたコンポーネントがインジェクションされる</li>
<li>上記いずれのアノテーションも付与されていない場合は<ul>
<li>引数の型に一致するコンポーネントがDIコンテナ上に1つしか存在しない場合は、そのコンポーネントを自動的にインジェクションする</li>
<li>引数の型に一致するコンポーネントがDIコンテナ上に存在しないまたは複数存在する場合は、何もインジェクションしない</li>
</ul>
</li>
</ul>
<dl class="docutils">
<dt>設定値をインジェクションする</dt>
<dd><p class="first">コンストラクタ引数に <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/ConfigValue.html" title="nablarch.core.repository.di.config.externalize.annotation.ConfigValue">ConfigValue</a> を
付与することでアノテーションの <code class="docutils literal"><span class="pre">value</span></code> に設定した値がインジェクションされる。
使用可能な設定値の型は <a class="reference internal" href="#repository-property-type"><span>文字列や数値、真偽値を設定値として使う</span></a> に準ずる。</p>
<p><a class="reference internal" href="#repository-user-environment-configuration"><span>コンポーネント設定ファイルから環境依存値を参照する</span></a> 場合同様
環境依存値のキー値を <code class="docutils literal"><span class="pre">${</span></code> と <code class="docutils literal"><span class="pre">}</span></code> で囲んで記述することができる。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@SystemRepositoryComponent</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">errorMessageId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ExampleService</span><span class="o">(</span><span class="nd">@ConfigValue</span><span class="o">(</span><span class="s">&quot;${example.service.errorMessageId}&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">errorMessageId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">errorMessageId</span> <span class="o">=</span> <span class="n">errorMessageId</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>コンポーネントをインジェクションする</dt>
<dd><p class="first">コンストラクタ引数に <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/annotation/ComponentRef.html" title="nablarch.core.repository.di.config.externalize.annotation.ComponentRef">ComponentRef</a> を
付与することでアノテーションの <code class="docutils literal"><span class="pre">value</span></code> に設定した名前のコンポーネントがインジェクションされる。</p>
<p>以下の例では <code class="docutils literal"><span class="pre">lettuceRedisClientProvider</span></code> という名前で定義されたコンポーネントがインジェクションされる。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@SystemRepositoryComponent</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleService</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">LettuceRedisClient</span> <span class="n">client</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">ExampleService</span><span class="o">(</span><span class="nd">@ComponentRef</span><span class="o">(</span><span class="s">&quot;lettuceRedisClientProvider&quot;</span><span class="o">)</span> <span class="n">LettuceRedisClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
  <span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>コンストラクタインジェクションは <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/ConstructorInjectionComponentCreator.html" title="nablarch.core.repository.di.config.ConstructorInjectionComponentCreator">ConstructorInjectionComponentCreator</a> というクラスで実現している。
<code class="docutils literal"><span class="pre">AnnotationComponentDefinitionLoader</span></code> の <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/config/externalize/AnnotationComponentDefinitionLoader.html#newComponentCreator--" title="nablarch.core.repository.di.config.externalize.AnnotationComponentDefinitionLoader.newComponentCreator()">newComponentCreator</a>
をオーバーライドすることで、アノテーションを付与したクラスのオブジェクト構築時に任意の処理を行う <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/di/ComponentCreator.html" title="nablarch.core.repository.di.ComponentCreator">ComponentCreator</a> 実装に差し替えることができる。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleComponentDefinitionLoader</span> <span class="kd">extends</span> <span class="n">AnnotationComponentDefinitionLoader</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="n">String</span> <span class="nf">getBasePackage</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">&quot;com.example&quot;</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="n">ComponentCreator</span> <span class="nf">newComponentCreator</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 任意のComponentCreator実装クラスに変更する。</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">ExampleComponentCreator</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="actiondi">
<h4><a class="toc-backref" href="#id43">7.2.3.13.3. ActionクラスをDIコンテナで管理する</a><a class="headerlink" href="#actiondi" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>アノテーションをActionクラスに付与することでDIコンテナで管理することが可能となる。
Nablarchで用意されたディスパッチハンドラ（ <a class="reference internal" href="../../adaptors/router_adaptor.html#router-adaptor"><span>ルーティングアダプタ</span></a> 、 <a class="reference internal" href="../handlers/common/request_path_java_package_mapping.html#request-path-java-package-mapping"><span>リクエストディスパッチハンドラ</span></a> 、
<a class="reference internal" href="../handlers/web/http_request_java_package_mapping.html#http-request-java-package-mapping"><span>HTTPリクエストディスパッチハンドラ</span></a> ）では
ディスパッチ先のクラスはディスパッチハンドラ内でインスタンス化される。
そのため、ActionクラスをDIコンテナに登録する場合は、ディスパッチ先のクラスをシステムリポジトリから取得するよう <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/fw/handler/DelegateFactory.html" title="nablarch.fw.handler.DelegateFactory">DelegateFactory</a> を
差し替える必要がある。差し替えは以下のように <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/fw/handler/DispatchHandler.html#setDelegateFactory-nablarch.fw.handler.DelegateFactory-" title="nablarch.fw.handler.DispatchHandler.setDelegateFactory(nablarch.fw.handler.DelegateFactory)">DispatchHandler#setDelegateFactory</a> にて設定する。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;packageMapping&quot;</span> <span class="na">class=</span><span class="s">&quot;nablarch.integration.router.RoutesMapping&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ディスパッチ先をシステムリポジトリから取得するDelegateFactory --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;delegateFactory&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.fw.handler.SystemRepositoryDelegateFactory&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
  <span class="c">&lt;!-- その他のプロパティは省略 --&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="repository-initialize-object">
<span id="id18"></span><h3><a class="toc-backref" href="#id44">7.2.3.14. オブジェクトの初期化処理を行う</a><a class="headerlink" href="#repository-initialize-object" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>オブジェクトの初期化処理を行うためには、以下の手順が必要となる。</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/initialization/Initializable.html" title="nablarch.core.repository.initialization.Initializable">Initializable</a> インタフェースを実装する。</li>
<li>コンポーネント設定ファイルに初期化対象のリストを設定する。</li>
</ol>
<p>以下に詳細な手順を示す。</p>
<dl class="docutils">
<dt>Initializableインタフェースを実装する</dt>
<dd><p class="first"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/initialization/Initializable.html#initialize--" title="nablarch.core.repository.initialization.Initializable.initialize()">initialize</a> で初期化処理を行う。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleComponent</span> <span class="kd">implements</span> <span class="n">Initializable</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// プロパティにインジェクションされた値などを元に初期化処理を行う</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>コンポーネント設定ファイルに初期化対象のリストを設定する</dt>
<dd><p class="first">初期化対象のオブジェクトを <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/initialization/BasicApplicationInitializer.html" title="nablarch.core.repository.initialization.BasicApplicationInitializer">BasicApplicationInitializer</a> に設定する。</p>
<p>初期化対象のオブジェクトの初期化順を意識する必要がある場合は、先に初期化を行いたいオブジェクトをより上に設定する。
下の設定例の場合、以下の順で初期化が行われる。</p>
<ol class="arabic simple">
<li><cite>sampleObject1</cite></li>
<li><cite>sampleObject2</cite></li>
<li><cite>sampleObject3</cite></li>
</ol>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/initialization/BasicApplicationInitializer.html" title="nablarch.core.repository.initialization.BasicApplicationInitializer">BasicApplicationInitializer</a> のコンポーネント名は、 必ず <strong>initializer</strong> とすること。</p>
</div>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- 初期化対象のオブジェクトの設定 --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleObject1&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleObject2&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent2&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleObject3&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent3&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;initializer&quot;</span>
    <span class="na">class=</span><span class="s">&quot;nablarch.core.repository.initialization.BasicApplicationInitializer&quot;</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- initializeListプロパティにlist要素で初期化対象のオブジェクトを列挙する --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;initializeList&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;sampleObject1&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;sampleObject2&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;sampleObject3&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="repository-dispose-object">
<span id="id19"></span><h3><a class="toc-backref" href="#id45">7.2.3.15. オブジェクトの廃棄処理を行う</a><a class="headerlink" href="#repository-dispose-object" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>オブジェクトの廃棄処理を行うためには、以下の手順が必要となる。</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/Disposable.html" title="nablarch.core.repository.disposal.Disposable">Disposable</a> インタフェースを実装する。</li>
<li>コンポーネント設定ファイルに廃棄対象のリストを設定する。</li>
</ol>
<p>以下に詳細な手順を示す。</p>
<dl class="docutils">
<dt>Disposableインタフェースを実装する</dt>
<dd><p class="first"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/Disposable.html#dispose--" title="nablarch.core.repository.disposal.Disposable.dispose()">dispose</a> で廃棄処理を行う。</p>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleComponent</span> <span class="kd">implements</span> <span class="n">Disposable</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispose</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
    <span class="c1">// リソースの解放など、廃棄処理を行う</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>コンポーネント設定ファイルに廃棄対象のリストを設定する</dt>
<dd><p class="first">廃棄対象のオブジェクトを <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/BasicApplicationDisposer.html" title="nablarch.core.repository.disposal.BasicApplicationDisposer">BasicApplicationDisposer</a> に設定する。</p>
<p>廃棄対象のオブジェクトの廃棄順を意識する必要がある場合は、先に廃棄を行いたいオブジェクトをより <strong>下に設定する</strong> 。
下の設定例の場合、以下の順で廃棄処理が行われる。</p>
<ol class="arabic simple">
<li><cite>sampleObject1</cite></li>
<li><cite>sampleObject2</cite></li>
<li><cite>sampleObject3</cite></li>
</ol>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p class="last"><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/BasicApplicationDisposer.html" title="nablarch.core.repository.disposal.BasicApplicationDisposer">BasicApplicationDisposer</a> のコンポーネント名は、 必ず <strong>disposer</strong> とすること。</p>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- 廃棄対象のオブジェクトの設定 --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleObject1&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent1&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleObject2&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent2&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleObject3&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent3&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;disposer&quot;</span>
    <span class="na">class=</span><span class="s">&quot;nablarch.core.repository.disposal.BasicApplicationDisposer&quot;</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- disposableListプロパティにlist要素で廃棄対象のオブジェクトを列挙する --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;disposableList&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;sampleObject3&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;sampleObject2&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;component-ref</span> <span class="na">name=</span><span class="s">&quot;sampleObject1&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">BasicApplicationDisposer</span></code> には <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/BasicApplicationDisposer.html#addDisposable-nablarch.core.repository.disposal.Disposable-" title="nablarch.core.repository.disposal.BasicApplicationDisposer.addDisposable(nablarch.core.repository.disposal.Disposable)">addDisposable</a> というメソッドが用意されており、コンポーネント生成後に任意の <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/Disposable.html" title="nablarch.core.repository.disposal.Disposable">Disposable</a> を追加できる。</p>
<div class="line-block">
<div class="line">この <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/BasicApplicationDisposer.html#addDisposable-nablarch.core.repository.disposal.Disposable-" title="nablarch.core.repository.disposal.BasicApplicationDisposer.addDisposable(nablarch.core.repository.disposal.Disposable)">addDisposable</a> で追加される <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/Disposable.html" title="nablarch.core.repository.disposal.Disposable">Disposable</a> は、そのインスタンスが生成された順番で追加されることが予想される。</div>
<div class="line">その場合、廃棄処理はインスタンス生成とは逆の順序で行うことが望ましい（例：JDBCの <code class="docutils literal"><span class="pre">Connection</span></code>, <code class="docutils literal"><span class="pre">Statement</span></code>, <code class="docutils literal"><span class="pre">ResultSet</span></code>）。</div>
</div>
<p class="last">このため、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/BasicApplicationDisposer.html" title="nablarch.core.repository.disposal.BasicApplicationDisposer">BasicApplicationDisposer</a> では <code class="docutils literal"><span class="pre">disposableList</span></code> に設定されている順序とは逆の順序で廃棄処理を呼ぶようになっている。</p>
</dd>
<dt>Closeableオブジェクトを廃棄対象リストに設定する</dt>
<dd><p class="first"><code class="docutils literal"><span class="pre">java.io.Closeable</span></code> を実装したコンポーネントであれば、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/disposal/DisposableAdaptor.html" title="nablarch.core.repository.disposal.DisposableAdaptor">DisposableAdaptor</a> を用いることで、次のように廃棄対象リストに簡単に設定できる。</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- java.io.Closeable を実装したコンポーネント --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;closeableComponent&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.CloseableComponent&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;disposer&quot;</span>
    <span class="na">class=</span><span class="s">&quot;nablarch.core.repository.disposal.BasicApplicationDisposer&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;disposableList&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.core.repository.disposal.DisposableAdaptor&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- DisposableAdaptor の target プロパティに、 Closeable を実装したコンポーネントを設定する --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;target&quot;</span> <span class="na">ref=</span><span class="s">&quot;closeableComponent&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>

<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="repository-use-system-repository">
<span id="id20"></span><h3><a class="toc-backref" href="#id46">7.2.3.16. DIコンテナの情報をシステムリポジトリに設定する</a><a class="headerlink" href="#repository-use-system-repository" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>DIコンテナの情報をシステムリポジトリにロードすることで、アプリケーション内の全ての箇所からDIコンテナ上のオブジェクトにアクセスできる。</p>
<p>コンポーネント設定ファイルをロードし、システムリポジトリに設定する例を以下に示す。</p>
<p>この例では、 <code class="docutils literal"><span class="pre">web-boot.xml</span></code> を元に構築されたDIコンテナの情報がシステムリポジトリに設定される。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">XmlComponentDefinitionLoader</span> <span class="n">loader</span>
    <span class="o">=</span> <span class="k">new</span> <span class="n">XmlComponentDefinitionLoader</span><span class="o">(</span><span class="s">&quot;web-boot.xml&quot;</span><span class="o">);</span>
<span class="n">SystemRepository</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="n">DiContainer</span><span class="o">(</span><span class="n">loader</span><span class="o">));</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">重要</p>
<p>DIコンテナの情報をシステムリポジトリへ登録する処理は、Nablarchが提供する以下のクラスで実施される。
このため、個別にこのような実装を行うことは基本的にない。</p>
<ul class="last simple">
<li>ServletContextListenerの実装クラス</li>
<li>独立型アプリケーションの起動クラス</li>
</ul>
</div>
</div>
<div class="section" id="repository-get-object">
<span id="id21"></span><h3><a class="toc-backref" href="#id47">7.2.3.17. システムリポジトリからオブジェクトを取得する</a><a class="headerlink" href="#repository-get-object" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>システムリポジトリ上からオブジェクトを取得する場合には、 <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/SystemRepository.html" title="nablarch.core.repository.SystemRepository">SystemRepository</a> クラスを使用する。</p>
<p>なお、システムリポジトリには事前にDIコンテナの情報を設定しておく必要がある。
詳細は、 <a class="reference internal" href="#repository-use-system-repository"><span>DIコンテナの情報をシステムリポジトリに設定する</span></a> を参照。</p>
<p>以下のように、component要素(listやmap要素を含む)に設定したname属性の値を指定して、オブジェクトを取得できる。</p>
<dl class="docutils">
<dt>コンポーネント定義</dt>
<dd><div class="first last highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;sampleComponent&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.SampleComponent&quot;</span> <span class="nt">/&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;component&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.Component&quot;</span> <span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;component2&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;component2&quot;</span> <span class="na">class=</span><span class="s">&quot;sample.Component2&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>取得例</dt>
<dd><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// SystemRepository#getを使用して取得する。</span>
<span class="n">SampleComponent</span> <span class="n">sample</span> <span class="o">=</span> <span class="n">SystemRepository</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;sampleComponent&quot;</span><span class="o">);</span>

<span class="c1">// ネストしたcomponentは、親の名前と自身の名前を&quot;.&quot;で連結し取得する。</span>
<span class="n">Component2</span> <span class="n">component2</span> <span class="o">=</span> <span class="n">SystemRepository</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;component.component2&quot;</span><span class="o">);</span>
</pre></div>
</div>
</dd>
</dl>
</div>
</div>
<div class="section" id="repository-environment-configuration-file-rule">
<span id="id22"></span><h2><a class="toc-backref" href="#id48">7.2.4. 環境設定ファイルの記述ルール</a><a class="headerlink" href="#repository-environment-configuration-file-rule" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>環境設定ファイルにはconfigファイルとpropertiesファイルの二種類があり、ここでは各環境設定ファイルの記述ルールについて説明する。</p>
<dl class="docutils">
<dt>propertisファイルの仕様</dt>
<dd>JavaのPropertiesの仕様に基づいて解析される。</dd>
<dt>configファイルの仕様</dt>
<dd><p class="first">以下、configファイルの仕様について説明する。</p>
<dl class="last docutils">
<dt>設定値の記述形式</dt>
<dd><p class="first">設定値は、 キーと値を <code class="docutils literal"><span class="pre">=</span></code> で区切って記述する。</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span><span class="nv">key1</span><span class="o">=</span>value1
<span class="nv">key2</span><span class="o">=</span>value2
</pre></div>
</div>
</dd>
<dt>コメントの記述</dt>
<dd><p class="first">コメントは、 <code class="docutils literal"><span class="pre">#</span></code> を用いた行コメントのみサポートする。
行中に <code class="docutils literal"><span class="pre">#</span></code> が存在した場合は、それ以降をコメントとして扱う。</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># コメントです</span>
<span class="nv">key</span> <span class="o">=</span> value   <span class="c1"># コメントです</span>
</pre></div>
</div>
</dd>
<dt>複数行にまたがった設定値の記述</dt>
<dd><p class="first">行末に <code class="docutils literal"><span class="pre">\</span></code> を記述することで、複数行にまたがって設定値を記述することができる。</p>
<p>下の例の場合、設定値の組み合わせは以下のようになる。</p>
<ul class="simple">
<li>key -&gt; value</li>
<li>key2 -&gt; value,value2</li>
<li>key3 -&gt; abcdefg</li>
</ul>
<div class="last highlight-bash"><div class="highlight"><pre><span></span><span class="nv">key</span> <span class="o">=</span> value
<span class="nv">key2</span> <span class="o">=</span> value,<span class="se">\</span>
value2
<span class="nv">key3</span> <span class="o">=</span> abcd<span class="se">\ </span>   <span class="c1"># ここにコメントを定義できる</span>
efg
</pre></div>
</div>
</dd>
<dt>予約語のエスケープ</dt>
<dd><p class="first">以下の予約語を一般文字として扱う場合は、 <code class="docutils literal"><span class="pre">\</span></code> を用いてエスケープを行う。</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">#</span></code></li>
<li><code class="docutils literal"><span class="pre">=</span></code></li>
<li><code class="docutils literal"><span class="pre">\</span></code></li>
</ul>
<p>下の例の場合、設定値の組み合わせは以下のようになる。</p>
<ul class="simple">
<li>key -&gt; a=a</li>
<li>key2 -&gt; #コメントではない</li>
<li>key3 -&gt; あ\い</li>
</ul>
<div class="last highlight-bash"><div class="highlight"><pre><span></span><span class="nv">key</span> <span class="o">=</span> a<span class="se">\=</span>a
<span class="nv">key2</span> <span class="o">=</span> <span class="se">\#</span>コメントではない
<span class="nv">key3</span> <span class="o">=</span> あ<span class="se">\\</span>い
</pre></div>
</div>
</dd>
</dl>
</dd>
</dl>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>半角スペースについて、configファイルでは半角スペースのみの値には対応していないが、propertiesファイルでは数値参照文字を設定することで扱うことができる。</p>
<div class="last highlight-bash"><div class="highlight"><pre><span></span><span class="nv">key</span> <span class="o">=</span> <span class="se">\u</span><span class="m">0020</span>
</pre></div>
</div>
</div>
<div class="admonition tip">
<p class="first admonition-title">補足</p>
<p>値が空の場合の挙動について、configファイルでは値が空の場合キーごと読み込まれないが、propertiesファイルでは空文字として扱われる。
そのため、コンポーネント設定ファイルから環境依存値を参照する際の挙動が異なるため注意が必要となる。</p>
<p>以下のようなコンポーネント設定と環境設定ファイルを定義した場合の挙動は下記の通り。</p>
<ul class="simple">
<li>環境設定ファイルがconfigファイルの場合 <code class="docutils literal"><span class="pre">config.value</span></code> は存在しないため例外が送出される。(※)</li>
<li>環境設定ファイルがpropertiesファイルの場合、コンポーネントの <code class="docutils literal"><span class="pre">property</span></code> には空文字が設定される。</li>
</ul>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;property&quot;</span> <span class="na">value=</span><span class="s">&quot;${config.value}&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># 値が空の設定値</span>
config.value<span class="o">=</span>
</pre></div>
</div>
<p class="last">※5u18までのNablarchでは設定値が存在しない場合は例外は送出されず、WARNINGレベルのログが出力され <code class="docutils literal"><span class="pre">property</span></code> に&#8221;${config.value}&#8221;という文字列が設定される。</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>

    <hr/>

    <div role="contentinfo">
        <p>
            &copy; Copyright 2010-2021, TIS Inc.
        </p>
    </div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'5u20',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/custom.js"></script>
      <script type="text/javascript" src="../../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>