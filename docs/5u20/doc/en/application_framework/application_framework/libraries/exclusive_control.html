


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv='content-language' content='ja'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.12. Exclusive Control &mdash; ∇Nablarch  5u20 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  

  
  <link rel="canonical" href="https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/exclusive_control.html" />
  
    <link rel="top" title="∇Nablarch  5u20 documentation" href="../../../index.html"/>
        <link rel="up" title="7. Libraries Provided by Nablarch" href="index.html"/>
        <link rel="next" title="7.13. Code Management" href="code.html"/>
        <link rel="prev" title="7.11. Message Management" href="message.html"/>
 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
  
  <a href="../../../index.html" id="sidebar-title" class="icon"> ∇Nablarch 
  

  
    <div id="sidebar-version">Version: 5u20</div>
  </a>

  <div role="search">
    <form id="google-search-form" class="wy-form" method="get" action="https://www.google.co.jp/search">
      <input type="text" name="text" placeholder="Search docs on google" id="text"/>
      <input type="hidden" name="q" id="q"/>
    </form>
  </div>
    
    

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  
  
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_nablarch/index.html">What is the Nablarch?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/concept.html">Nablarch Concept</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#robustness">Robustness</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#testability">Testability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../about_nablarch/concept.html#ready-to-use">Ready-to-Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/mvn_module.html">Module List of Nablarch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_nablarch/license.html">Information on Nablarch License</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Nablarch Application Framework</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Application Framework</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../nablarch/index.html">1. What is Nablarch Application Framework?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web/index.html">2. Web Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../web_service/index.html">3. Web Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="../batch/index.html">4. Batch Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../messaging/index.html">5. Messaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../handlers/index.html">6. Standard Handler Provided by Nablarch</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">7. Libraries Provided by Nablarch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../blank_project/index.html">8. Blank Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../setting_guide/index.html">9. Nablarch Application Framework Configuration Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../configuration/index.html">10. Default Configuration List</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cloud_native/index.html">11. Nablarch Cloud Native Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adaptors/index.html">Adaptor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/log_adaptor.html">log Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/router_adaptor.html">Routing Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/webspheremq_adaptor.html">IBM WebSphere MQ Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/jaxrs_adaptor.html">JAX-RS Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/doma_adaptor.html">Doma Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/jsr310_adaptor.html">JSR310(Date and Time API)Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_freemarker_adaptor.html">E-mail FreeMarker Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_thymeleaf_adaptor.html">E-mail Thymeleaf Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/mail_sender_velocity_adaptor.html">E-mail Velocity Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/web_thymeleaf_adaptor.html">Web Application Thymeleaf Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/lettuce_adaptor.html">Lettuce Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/slf4j_adaptor.html">SLF4J Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adaptors/micrometer_adaptor.html">Micrometer Adapter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../example/index.html">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../example/index.html#procedure-to-build-the-environment">Procedure to build the environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../example/index.html#application-execution-procedure">Application execution procedure</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../extension_components/index.html">Nablarch extension component</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/report/index.html">1. Form library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/workflow/doc/index.html">2. Workflow library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/workflow/tool/index.html">3. Workflow definition data generation tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/etl/index.html">4. ETL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../extension_components/etl/etl_maven_plugin.html">5. ETL Maven plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../development_tools/index.html">Nablarch development tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html">1. Efficient Java Static Checks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#conduct-syntax-check">1.1. Conduct syntax check</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#unify-the-format">1.2. Unify the format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/java_static_analysis/index.html#check-if-unauthorized-apis-are-being-used">1.3. Check if unauthorized APIs are being used</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/ui_dev/index.html">2. Front-end UI development platform for advanced users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/testing_framework/index.html">3. Testing framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/05_UnitTestGuide/index.html">3.1. How to Execute Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/06_TestFWGuide/index.html">3.2. How to Use the Automated Test Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/testing_framework/guide/development_guide/08_TestTools/index.html">3.3. Tools Used in the Programming Phase</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../development_tools/toolbox/index.html">4. Useful Tools When Developing Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/JspStaticAnalysis/index.html">4.1. JSP Static Analysis Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/SqlExecutor/SqlExecutor.html">4.2. Nablarch SQL Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../development_tools/toolbox/JspVerifier/JspVerifier.html">4.3. Job Screen JSP Validation Tool</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Nablarch Implementation Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/01/index.html">Sample Password Encryption Function Using Database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/0101_PBKDF2PasswordEncryptor.html">Sample Password Encryption Function Using PBKDF2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/01/index.html#how-to-use">How to Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/02/index.html">Extended Validation Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#email-address-validation">Email address validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#validation-of-japan-telephone-numbers">Validation of Japan telephone numbers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/02/index.html#code-value-validation">Code value validation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/03/index.html">Display a List of Search Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#how-to-use">How to Use</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchinfo-class">ListSearchInfo class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#listsearchresult-tag">listSearchResult tag</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#sort-search-results">Sort search results</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#how-to-implement-displaying-a-list-of-all-search-results-on-a-single-screen">How to implement displaying a list of all search results on a single screen</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#how-to-implement-the-initial-display-of-search-results-with-the-default-search-conditions">How to implement the initial display of search results with the default search conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#default-settings-for-the-search-result-list-display-function">Default settings for the search result list display function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#how-to-import-a-sample-implementation-tag-file-into-the-business-application">How to import a sample implementation (tag file) into the business application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/03/index.html#tag-reference">Tag Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/04/index.html">Extended Formatter Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/04/0401_ExtendedDataFormatter.html">Data Formatter Expansion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/04/0402_ExtendedFieldType.html">Field Type Expansion in the Data Formatter Function</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/05/index.html">Sample File Management Function Using Database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/05/index.html#how-to-use">How to Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/06/index.html">CAPTCHA Function Sample</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/06_Captcha_guide.html">How to Incorporate the CAPTCHA Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/06/index.html#how-to-use">How to Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/07/index.html">Sample UserAgent Information Acquisition Function</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#description-of-configuration">Description of configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/07/index.html#use-case">Use case</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/08/index.html">Sample of HTML Email Send Function</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#request">Request</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/08/index.html#implementation-examples">Implementation examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/09/index.html">How to Use a Sample to Send a Digitally Signed Email Using Bouncycastle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#environment-preparation">Environment preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#structure-of-digitally-signed-email-send-function">Structure of digitally signed email send function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#preparation-of-configuration-file">Preparation of configuration file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/09/index.html#execution">Execution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/10/index.html">How to Use the Log Aggregation Sample</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/10/index.html#list-of-samples-provided">List of samples provided</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/11/index.html">Messaging Platform Test Simulator Sample</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#uses">Uses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#features">Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#request">Request</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#how-to-use">How to use</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/11/index.html#expansion-example">Expansion example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../nablarch_api/index.html">Nablarch API</a></li>
</ul>

  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">∇Nablarch </a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Nablarch Application Framework</a> &raquo;</li>
      
          <li><a href="../index.html">Application Framework</a> &raquo;</li>
      
          <li><a href="index.html">7. Libraries Provided by Nablarch</a> &raquo;</li>
      
    <li>7.12. Exclusive Control</li>
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/nablarch" class="fa fa-github">GitHub</a>
    </li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://nablarch.github.io/docs/LATEST/doc/index.html" class="ja">日本語</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="exclusive-control">
<span id="id1"></span><h1>7.12. Exclusive Control<a class="headerlink" href="#exclusive-control" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#function-overview" id="id2">Function overview</a><ul>
<li><a class="reference internal" href="#optimistic-locking-pessimistic-locking-are-possible" id="id3">Optimistic locking/Pessimistic locking are possible</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-list" id="id4">Module list</a></li>
<li><a class="reference internal" href="#how-to-use" id="id5">How to use</a><ul>
<li><a class="reference internal" href="#prepare-to-use-exclusive-control" id="id6">Prepare to use exclusive control</a></li>
<li><a class="reference internal" href="#optimistic-locking" id="id7">Optimistic locking</a></li>
<li><a class="reference internal" href="#perform-optimistic-lock-with-batch-update" id="id8">Perform optimistic lock with batch update</a></li>
<li><a class="reference internal" href="#pessimistic-locking" id="id9">Pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#expansion-example" id="id10">Expansion example</a></li>
</ul>
</div>
<p>This function performs exclusive control for updating data in the database.
With this function,
data integrity can be maintained even when the same data in the database is updated
from multiple transactions (web or batch) at the same time.</p>
<div class="admonition important" id="exclusive-control-deprecated">
<p class="first admonition-title">Important</p>
<p>This function is <strong>deprecated</strong> because of the following reasons:
Uses <a class="reference internal" href="database/universal_dao.html#universal-dao"><span>Universal DAO</span></a> for exclusive control.</p>
<ul class="last simple">
<li><dl class="first docutils">
<dt>Exclusive control of <a class="reference internal" href="database/universal_dao.html#universal-dao"><span>Universal DAO</span></a> can be used more easily than this function.</dt>
<dd>See <a class="reference internal" href="database/universal_dao.html#universal-dao-jpa-optimistic-lock"><span>Optimistic locking</span></a> , <a class="reference internal" href="database/universal_dao.html#universal-dao-jpa-pessimistic-lock"><span>Pessimistic locking</span></a>.</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>If the primary key is defined as a non-string type, this function cannot be used depending on the database.</dt>
<dd>This function stores all the primary key values as string type ( <cite>java.lang.String</cite> ).
When the primary key column definition is a non-string type (other than char or varchar),
a SQL statement runtime exception occurs due to type mismatch depending on the database.
For example, this problem occurs in the case of databases such as PostgreSQL where the implicit type conversion is not performed.</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="function-overview">
<h2><a class="toc-backref" href="#id2">7.12.1. Function overview</a><a class="headerlink" href="#function-overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="optimistic-locking-pessimistic-locking-are-possible">
<h3><a class="toc-backref" href="#id3">7.12.1.1. Optimistic locking/Pessimistic locking are possible</a><a class="headerlink" href="#optimistic-locking-pessimistic-locking-are-possible" title="Permalink to this headline">¶</a></h3>
<p>This function performs optimistic locking/pessimistic locking by defining the version number column in the table.
In this framework, the table in which the version number column is defined is called the <strong>exclusive control table</strong>.</p>
<p>The following can be realized with this function.</p>
<ul class="simple">
<li><a class="reference internal" href="#exclusive-control-optimistic-lock"><span>Optimistic locking</span></a></li>
<li><a class="reference internal" href="#exclusive-control-optimistic-lock-bulk"><span>Perform optimistic lock with batch update</span></a></li>
<li><a class="reference internal" href="#exclusive-control-pessimistic-lock"><span>Pessimistic locking</span></a></li>
</ul>
<p>Since, the optimistic lock/pessimistic lock provided by this function is realized by using the same exclusive control table,
even if optimistic lock and pessimistic lock are used in parallel, it is possible to prevent the same data from being updated at the same time.
For example, web using optimistic lock and batch using pessimistic lock can run
in parallel and still maintain the data integrity.</p>
<p>The exclusive control table is defined for each unit of exclusive control and the largest unit in which conflicts are allowed.
For example, if the business allows locking in a large unit called &#8220;user&#8221;,
an exclusive control table is defined in that unit.
However, note that the possibility of conflict increases if the unit is increased,
and update failure (in the case of optimistic locking) and processing delay (in the case of pessimistic locking) will occur.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Normally, the unit of the exclusive control table is defined from a business perspective.
For example, when the sales and deposit processes are updated at the same time,
the exclusive control table is defined in a unit of tables related to the processes.</p>
<p class="last">Also, the unit of the exclusive control table can be defined from the perspective of table design.
For example, if the parent-child relationship of the table such as the header (parent) and details (child) is clear,
the exclusive control table is defined in parent units.
If the parent-child relationship is not clear, determine which one should be the parent and then define the exclusive control table.</p>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Design the update order after designing the exclusive control table.
Deadlock is prevented by determining the update order of each table, and data integrity during update is guaranteed.
In a database, since row locks occur when records are updated,
deadlocks are very likely to occur if the update order is not specified.</p>
</div>
</div>
</div>
<div class="section" id="module-list">
<h2><a class="toc-backref" href="#id4">7.12.2. Module list</a><a class="headerlink" href="#module-list" title="Permalink to this headline">¶</a></h2>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-common-exclusivecontrol<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-common-exclusivecontrol-jdbc<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="c">&lt;!-- Only for optimistic locking --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-fw-web-tag<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id5">7.12.3. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="prepare-to-use-exclusive-control">
<span id="exclusive-control-optimistic-setting"></span><h3><a class="toc-backref" href="#id6">7.12.3.1. Prepare to use exclusive control</a><a class="headerlink" href="#prepare-to-use-exclusive-control" title="Permalink to this headline">¶</a></h3>
<p>To use exclusive control, <strong>create a class that retains the configuration</strong> and <strong>information required for exclusive control</strong>.</p>
<dl class="docutils">
<dt>Configuration</dt>
<dd><p class="first">Add the configuration of <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/exclusivecontrol/BasicExclusiveControlManager.html" title="nablarch.common.exclusivecontrol.BasicExclusiveControlManager">BasicExclusiveControlManager</a> to the component definition.</p>
<div class="last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Configure the component name with &quot;exclusiveControlManager&quot;. --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;exclusiveControlManager&quot;</span>
           <span class="na">class=</span><span class="s">&quot;nablarch.common.exclusivecontrol.BasicExclusiveControlManager&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Message ID used when an exclusive error occurs in optimistic locking --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;optimisticLockErrorMessageId&quot;</span> <span class="na">value=</span><span class="s">&quot;CUST0001&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
</dd>
<dt>Creating a class that holds the information required for exclusive control</dt>
<dd><p class="first">Create by inheriting <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/exclusivecontrol/ExclusiveControlContext.html" title="nablarch.common.exclusivecontrol.ExclusiveControlContext">ExclusiveControlContext</a>.
This class is created for each exclusive control table and used in the API call that performs exclusive control.</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- Exclusive control table</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">USERS</span> <span class="p">(</span>
    <span class="n">USER_ID</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="c1">-- Business data other than the primary key is omitted.</span>
    <span class="k">VERSION</span> <span class="nb">NUMBER</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">USER_ID</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// Class corresponding to the exclusive control table USERS.</span>
<span class="c1">// Inherit ExclusiveControlContext.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsersExclusiveControl</span> <span class="kd">extends</span> <span class="n">ExclusiveControlContext</span> <span class="o">{</span>

    <span class="c1">// Define the primary key of the exclusive control table with enumeration type.</span>
    <span class="kd">private</span> <span class="kd">enum</span> <span class="n">PK</span> <span class="o">{</span> <span class="n">USER_ID</span> <span class="o">}</span>

    <span class="c1">// Define a constructor that takes the value of the primary key.</span>
    <span class="kd">public</span> <span class="nf">UsersExclusiveControl</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// Configure the table name with the setTableName method of the parent class.</span>
        <span class="n">setTableName</span><span class="o">(</span><span class="s">&quot;USERS&quot;</span><span class="o">);</span>

        <span class="c1">// Configure the version number column name with the setVersionColumnName method</span>
        <span class="c1">// of the parent class.</span>
        <span class="n">setVersionColumnName</span><span class="o">(</span><span class="s">&quot;VERSION&quot;</span><span class="o">);</span>

        <span class="c1">// Use the enum values method for the setPrimaryKeyColumnNames method</span>
        <span class="c1">// of parent class to set all primary key enumeration types.</span>
        <span class="n">setPrimaryKeyColumnNames</span><span class="o">(</span><span class="n">PK</span><span class="o">.</span><span class="na">values</span><span class="o">());</span>

        <span class="c1">// Add the primary key value using the appendCondition method of the parent class.</span>
        <span class="n">appendCondition</span><span class="o">(</span><span class="n">PK</span><span class="o">.</span><span class="na">USER_ID</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="optimistic-locking">
<span id="exclusive-control-optimistic-lock"></span><h3><a class="toc-backref" href="#id7">7.12.3.2. Optimistic locking</a><a class="headerlink" href="#optimistic-locking" title="Permalink to this headline">¶</a></h3>
<p>When the data to be updated is acquired, the version number of the table for exclusive control is obtained.
The optimistic lock is achieved by checking whether the version number of the exclusive control table has been updated during the update.</p>
<p>Use <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/web/exclusivecontrol/HttpExclusiveControlUtil.html" title="nablarch.common.web.exclusivecontrol.HttpExclusiveControlUtil">HttpExclusiveControlUtil</a> for optimistic locking.</p>
<p>Using the update function with input → confirmation → completion as an example, an implementation example of optimistic locking is shown below.</p>
<dl class="docutils">
<dt>Initial display of input screen</dt>
<dd><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// (Business process)</span>
    <span class="c1">// Get the primary key condition to acquire the update target data from the request.</span>
    <span class="n">String</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">getUserId</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

    <span class="c1">// (Exclusive control)</span>
    <span class="c1">// Generate the primary key class and prepare the version number.</span>
    <span class="c1">// The acquired version number is configured in the ExecutionContext specified</span>
    <span class="c1">// by the framework.</span>
    <span class="n">HttpExclusiveControlUtil</span><span class="o">.</span><span class="na">prepareVersion</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">new</span> <span class="n">UsersExclusiveControl</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>

    <span class="c1">// (Business process)</span>
    <span class="c1">// Acquire the update target data and configure it in the request scope</span>
    <span class="c1">// to display the input screen.</span>
    <span class="n">context</span><span class="o">.</span><span class="na">setRequestScopedVar</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">findUser</span><span class="o">(</span><span class="n">userId</span><span class="o">));</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">HttpResponse</span><span class="o">(</span><span class="s">&quot;/input.jsp&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
<dt>Confirmation button on the input screen (Input → Confirm)</dt>
<dd><div class="first highlight-java"><div class="highlight"><pre><span></span><span class="nd">@OnErrors</span><span class="o">({</span>
    <span class="nd">@OnError</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">ApplicationException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/input.jsp&quot;</span><span class="o">),</span>
    <span class="nd">@OnError</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">OptimisticLockException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/error.jsp&quot;</span><span class="o">)</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">confirm</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// (Exclusive control)</span>
    <span class="c1">// Check the update of version number.</span>
    <span class="c1">// Acquire the version number from the HttpRequest specified by the framework.</span>
    <span class="c1">// Since the OptimisticLockException will be thrown if the version number has been updated,</span>
    <span class="c1">// specify @OnError and the transition destination.</span>
    <span class="n">HttpExclusiveControlUtil</span><span class="o">.</span><span class="na">checkVersions</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>

    <span class="c1">// (Business process)</span>
    <span class="c1">// Check the input data and configure in the request scope</span>
    <span class="c1">// to display the confirmation screen.</span>
    <span class="n">context</span><span class="o">.</span><span class="na">setRequestScopedVar</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">getUser</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">HttpResponse</span><span class="o">(</span><span class="s">&quot;/confirm.jsp&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="last admonition important">
<p class="first admonition-title">Important</p>
<p class="last">The version numbers will not be inherited between screens, if ( <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/web/exclusivecontrol/HttpExclusiveControlUtil.html#checkVersions-nablarch.fw.web.HttpRequest-nablarch.fw.ExecutionContext-" title="nablarch.common.web.exclusivecontrol.HttpExclusiveControlUtil.checkVersions(nablarch.fw.web.HttpRequest-nablarch.fw.ExecutionContext)">HttpExclusiveControlUtil.checkVersions</a> )
does not perform the version check.</p>
</div>
</dd>
<dt>Update button on the confirmation screen (confirmation → complete)</dt>
<dd><div class="first last highlight-java"><div class="highlight"><pre><span></span><span class="nd">@OnErrors</span><span class="o">({</span>
    <span class="nd">@OnError</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">ApplicationException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/input.jsp&quot;</span><span class="o">),</span>
    <span class="nd">@OnError</span><span class="o">(</span><span class="n">type</span> <span class="o">=</span> <span class="n">OptimisticLockException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/error.jsp&quot;</span><span class="o">)</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">update</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// (Exclusive control)</span>
    <span class="c1">// Perform the update check of the version number and update.</span>
    <span class="c1">// Acquire the version number from the HttpRequest specified by the framework.</span>
    <span class="c1">// Since the OptimisticLockException will be thrown if the version number has been updated,</span>
    <span class="c1">// specify @OnError and the transition destination.</span>
    <span class="n">HttpExclusiveControlUtil</span><span class="o">.</span><span class="na">updateVersionsWithCheck</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

    <span class="c1">// (Business process)</span>
    <span class="c1">// Check the input data and perform the update process.</span>
    <span class="c1">// Configure the updated data in request scope to the display completion screen.</span>
    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getUser</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
    <span class="n">update</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="n">context</span><span class="o">.</span><span class="na">setRequestScopedVar</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">HttpResponse</span><span class="o">(</span><span class="s">&quot;/complete.jsp&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="perform-optimistic-lock-with-batch-update">
<span id="exclusive-control-optimistic-lock-bulk"></span><h3><a class="toc-backref" href="#id8">7.12.3.3. Perform optimistic lock with batch update</a><a class="headerlink" href="#perform-optimistic-lock-with-batch-update" title="Permalink to this headline">¶</a></h3>
<p>In the process of collectively updating specific properties (such as logical deletion flag) for multiple records,
performing optimistic lock check only on selected records may be preferred.</p>
<p>There are two implementation methods depending on whether the primary key of the exclusive control table
is <strong>not a composite primary key</strong> or <strong>a composite primary key</strong>.</p>
<dl class="docutils">
<dt>Is not a composite primary key</dt>
<dd><p class="first">An implementation example when the primary key is not a composite primary key is shown using the screen for batch deletion of users as an example.
Since the acquire section of the version number just calls <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/web/exclusivecontrol/HttpExclusiveControlUtil.html#prepareVersions-nablarch.fw.ExecutionContext-java.util.List-" title="nablarch.common.web.exclusivecontrol.HttpExclusiveControlUtil.prepareVersions(nablarch.fw.ExecutionContext-java.util.List)">HttpExclusiveControlUtil#prepareVersions</a>,
implementation example is omitted.</p>
<div class="highlight-html"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Implementation of screen (before and after are omitted) --&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Delete target<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>User name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="c">&lt;!-- Send the primary key of the user with the request parameter &quot;user.deactivate&quot;. --&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">checkbox</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;user.deactivate&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;user001&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>User 001<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">checkbox</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;user.deactivate&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;user002&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>ユーザ002<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (Exclusive control: Check)</span>
<span class="c1">// Only the primary key of the user configured in the request parameter &quot;user.deactivate&quot;</span>
<span class="c1">// is a check target.</span>
<span class="n">HttpExclusiveControlUtil</span><span class="o">.</span><span class="na">checkVersions</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="s">&quot;user.deactivate&quot;</span><span class="o">);</span>
</pre></div>
</div>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (Exclusive control: Check and update)</span>
<span class="c1">// Only the primary key of the user configured in the request parameter &quot;user.deactivate&quot;</span>
<span class="c1">// is a check target.</span>
<span class="n">HttpExclusiveControlUtil</span><span class="o">.</span><span class="na">updateVersionsWithCheck</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="s">&quot;user.deactivate&quot;</span><span class="o">);</span>
</pre></div>
</div>
</dd>
<dt>For composite primary key</dt>
<dd><p class="first">An implementation example when the primary key is a composite primary key is shown using the screen for batch deletion of users as an example.
Since the acquire section of the version number just calls <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/web/exclusivecontrol/HttpExclusiveControlUtil.html#prepareVersions-nablarch.fw.ExecutionContext-java.util.List-" title="nablarch.common.web.exclusivecontrol.HttpExclusiveControlUtil.prepareVersions(nablarch.fw.ExecutionContext-java.util.List)">HttpExclusiveControlUtil#prepareVersions</a>,
implementation example is omitted.</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="c1">-- Table with a composite primary key defined.</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">USERS</span> <span class="p">(</span>
    <span class="n">USER_ID</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">PK2</span>     <span class="nb">CHAR</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">PK3</span>     <span class="nb">CHAR</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="c1">-- Business data other than the primary key is omitted.</span>
    <span class="k">VERSION</span> <span class="nb">NUMBER</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">USER_ID</span><span class="p">,</span><span class="n">PK2</span><span class="p">,</span><span class="n">PK3</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// Class corresponding to the exclusive control table USERS.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsersExclusiveControl</span> <span class="kd">extends</span> <span class="n">ExclusiveControlContext</span> <span class="o">{</span>

    <span class="c1">// Define the primary key of the exclusive control table with enumeration type.</span>
    <span class="kd">private</span> <span class="kd">enum</span> <span class="n">PK</span> <span class="o">{</span> <span class="n">USER_ID</span><span class="o">,</span> <span class="n">PK2</span><span class="o">,</span> <span class="n">PK3</span> <span class="o">}</span>

    <span class="c1">// Define a constructor that takes the value of the primary key</span>
    <span class="c1">// and set the necessary information in the parent class method.</span>
    <span class="kd">public</span> <span class="nf">UsersExclusiveControl</span><span class="o">(</span><span class="n">String</span> <span class="n">userId</span><span class="o">,</span> <span class="n">String</span> <span class="n">pk2</span><span class="o">,</span> <span class="n">String</span> <span class="n">pk3</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setTableName</span><span class="o">(</span><span class="s">&quot;USERS&quot;</span><span class="o">);</span>
        <span class="n">setVersionColumnName</span><span class="o">(</span><span class="s">&quot;VERSION&quot;</span><span class="o">);</span>
        <span class="n">setPrimaryKeyColumnNames</span><span class="o">(</span><span class="n">PK</span><span class="o">.</span><span class="na">values</span><span class="o">());</span>
        <span class="n">appendCondition</span><span class="o">(</span><span class="n">PK</span><span class="o">.</span><span class="na">USER_ID</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
        <span class="n">appendCondition</span><span class="o">(</span><span class="n">PK</span><span class="o">.</span><span class="na">PK2</span><span class="o">,</span> <span class="n">pk2</span><span class="o">);</span>
        <span class="n">appendCondition</span><span class="o">(</span><span class="n">PK</span><span class="o">.</span><span class="na">PK3</span><span class="o">,</span> <span class="n">pk3</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="highlight-html"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Implementation of screen (before and after are omitted) --&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>Delete target<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>User name<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="c">&lt;!--</span>
<span class="c">  Send the primary key of the user with the request parameter &quot;user.deactivate&quot;.</span>
<span class="c">  In the case of a composite primary key, specify a string that is combined with delimiters</span>
<span class="c">  (arbitrary, it cannot be the primary key value).</span>
<span class="c">  --&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;user.userCompositeKeys&quot;</span>
                                         <span class="na">value</span><span class="o">=</span><span class="s">&quot;user001,pk2001,pk3001&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>User 001<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;user.userCompositeKeys&quot;</span>
                                         <span class="na">value</span><span class="o">=</span><span class="s">&quot;user002,pk2002,pk3002&quot;</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>ユーザ002<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Composite primary keys are easier to handle when custom tag corresponding to the composite primary key
and <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/web/compositekey/CompositeKey.html" title="nablarch.common.web.compositekey.CompositeKey">CompositeKey</a> are used.
For details, see <a class="reference internal" href="tag.html#tag-composite-key"><span>Creating radio buttons and checkboxes associated with a composite key</span></a>.</p>
</div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (Exclusive control: Check)</span>
<span class="c1">// Form implements the process of extracting the primary key from the request parameter</span>
<span class="c1">// taking the delimiter into consideration.</span>
<span class="n">User</span><span class="o">[]</span> <span class="n">deletedUsers</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getDeletedUsers</span><span class="o">();</span>

<span class="c1">// Call the check by record.</span>
<span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">deletedUser</span> <span class="o">:</span> <span class="n">deletedUsers</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">HttpExclusiveControlUtil</span><span class="o">.</span><span class="na">checkVersion</span><span class="o">(</span>
        <span class="n">request</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">UsersExclusiveControl</span><span class="o">(</span><span class="n">deletedUser</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span>
                                  <span class="n">deletedUser</span><span class="o">.</span><span class="na">getPk2</span><span class="o">(),</span>
                                  <span class="n">deletedUser</span><span class="o">.</span><span class="na">getPk3</span><span class="o">()));</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="last highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (Exclusive control: Check and update)</span>
<span class="n">User</span><span class="o">[]</span> <span class="n">deletedUsers</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getDeletedUsers</span><span class="o">();</span>

<span class="c1">// Call check and update by record.</span>
<span class="k">for</span><span class="o">(</span><span class="n">User</span> <span class="n">deletedUser</span> <span class="o">:</span> <span class="n">deletedUsers</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">HttpExclusiveControlUtil</span><span class="o">.</span><span class="na">updateVersionWithCheck</span><span class="o">(</span>
        <span class="n">request</span><span class="o">,</span> <span class="k">new</span> <span class="n">ExclusiveUserCondition</span><span class="o">(</span><span class="n">deletedUser</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span>
                                            <span class="n">deletedUser</span><span class="o">.</span><span class="na">getPk2</span><span class="o">(),</span>
                                            <span class="n">deletedUser</span><span class="o">.</span><span class="na">getPk3</span><span class="o">()));</span>
<span class="o">}</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="pessimistic-locking">
<span id="exclusive-control-pessimistic-lock"></span><h3><a class="toc-backref" href="#id9">7.12.3.4. Pessimistic locking</a><a class="headerlink" href="#pessimistic-locking" title="Permalink to this headline">¶</a></h3>
<p>The pessimistic lock is realized by updating the version number of the exclusive control table before acquiring the update target data.</p>
<p>By updating the version number of the exclusive control table before acquiring the update target data,
the target row of the exclusive control table is locked until the transaction of the update process is committed or rolled back.
Therefore, the update process of other transactions is kept on wait until the lock is released.</p>
<p>Use <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/exclusivecontrol/ExclusiveControlUtil.html#updateVersion-nablarch.common.exclusivecontrol.ExclusiveControlContext-" title="nablarch.common.exclusivecontrol.ExclusiveControlUtil.updateVersion(nablarch.common.exclusivecontrol.ExclusiveControlContext)">ExclusiveControlUtil#updateVersion</a> for pessimistic locking.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">ExclusiveControlUtil</span><span class="o">.</span><span class="na">updateVersion</span><span class="o">(</span><span class="k">new</span> <span class="n">UsersExclusiveControl</span><span class="o">(</span><span class="s">&quot;U00001&quot;</span><span class="o">));</span>
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>In batch process, pre-processing to acquire only the primary key for locking is provided,
and it is implemented in this process such that data is acquired and updated after acquiring one lock each.
The reasons are as follows.</p>
<ul class="last simple">
<li>To prevent other processes from updating the data between the time when the data is acquired and updated.</li>
<li>The lock time should be kept as short as possible and keep its impact on parallel processing as small as possible.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="expansion-example">
<h2><a class="toc-backref" href="#id10">7.12.4. Expansion example</a><a class="headerlink" href="#expansion-example" title="Permalink to this headline">¶</a></h2>
<p>None.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>

    <hr/>

    <div role="contentinfo">
        <p>
            &copy; Copyright 2010-2021, TIS Inc.
        </p>
    </div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'5u20',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/custom.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>